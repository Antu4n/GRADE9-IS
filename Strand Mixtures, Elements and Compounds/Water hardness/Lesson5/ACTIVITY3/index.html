<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Activity: Water for Every Use</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;800;900&display=swap" rel="stylesheet">
    <style>
        html {
            font-size: 1.5vmin; /* Increased for better base readability */
        }
        ::-webkit-scrollbar{
            display: none;
        }
        
        @font-face {
            font-family: 'Fredoka';
            src: url('../assets/Fredoka-VariableFont_wdth\,wght.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }

        :root {
            --font-xs: 1.1rem;
            --font-sm: 1.4rem;
            --font-md: 1.6rem;
            --font-lg: 2rem;
            --font-xl: 4rem;
            --pad-sm: 1rem;
            --pad-md: 1.6rem;
            --pad-lg: 2.4rem;
            --primary-color: #5D04B2;
            --secondary-color: #FBB03B;
            --progress-color: #FFFF00;
            --correct-color: #5cb85c;
            --incorrect-color: #d9534f;
            --hard-water-color: #5cb85c;  /* Green for Hard Water */
            --soft-water-color: #3498db;  /* Blue for Soft Water */
            --text-color-dark: #333;
            --text-color-light: #fff;
            --card-background-light: #ffffff;
            --shadow-light: rgba(0, 0, 0, 0.1);
            --shadow-dark: rgba(0, 0, 0, 0.3);
            --header-font: 'Fredoka', 'Poppins', sans-serif;
            --body-font: 'Fredoka', 'Nunito', sans-serif;
            --border-radius: 1.4rem;
        }

        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #f0f4f8;
            font-family: var(--body-font);
            font-size: var(--font-md);
        }

        #game-wrapper {
            width: 100%;
            max-width: 1200px;
            aspect-ratio: 16 / 9;
            box-shadow: 0 1.5rem 4rem var(--shadow-dark);
            overflow: hidden;
            position: relative;
            background: #fff;
        }

        #game-container {
            width: 100%;
            height: 100%;
            position: relative;
            overflow: hidden;
        }

        .screen {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0; left: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: var(--pad-lg);
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
        }

        .screen.hidden {
            opacity: 0;
            pointer-events: none;
            transform: scale(0.95);
        }

        /* --- HEADER --- */
        .game-header {
            width: 100%;
            background-color: var(--primary-color);
            padding: var(--pad-sm) var(--pad-md);
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
            position: absolute;
            top: 0; left: 0; z-index: 10;
            box-shadow: 0 0.2rem 1rem rgba(0,0,0,0.2);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .game-header.visible { opacity: 1; }
        .game-header h1 { font-size: var(--font-lg); font-weight: 800; margin: 0; }

        /* --- PROGRESS BAR STYLING --- */
        .header-progress {
            display: flex;
            align-items: center;
            gap: var(--pad-md);
        }
        #header-progress-container {
            width: 20rem;
            background-color: rgba(255,255,255,0.3);
            border-radius: 1.6rem;
            height: 2rem;
            border: 0.2rem solid white;
            position: relative;
            overflow: hidden;
        }
        #header-progress-bar {
            height: 100%;
            width: 0%;
            background: var(--progress-color);
            border-radius: 1.3rem;
            transition: width 0.5s ease;
        }
        #header-progress-text {
            font-weight: 700;
            font-size: var(--font-sm);
        }

        /* --- START SCREEN --- */
        #start-screen {
            background-image: url('images/gamebg.jpg');
            background-size: cover;
            background-position: center;
        }
        #start-screen h1 {
            font-size: var(--font-xl);
            color: var(--text-color-light);
            margin-bottom: 1.9rem;
            text-align: center;
            font-weight: 600;
            text-shadow: 0 0.4rem 1rem rgba(0,0,0,0.3);
        }
        .start-button {
            font-family: var(--header-font);
            background: var(--secondary-color); color: var(--text-color-light);
            font-weight: 600;
            font-size: var(--font-md);
            border: 0.3rem solid #fff;
            border-radius: 4.8rem;
            padding: var(--pad-sm) var(--pad-lg);
            margin-top: 1.6rem;
            cursor: pointer;
            text-shadow: 0 0.2rem 0 #b88b2a;
            transition: all 0.2s;
        }
        .start-button:hover { transform: scale(1.06); }

        /* ===== COMPLETION OVERLAY ===== */
        #completion-overlay {
            background-image: url('images/gamebg.jpg');
            background-size: cover; background-position: center; color: #fff;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            gap: 1rem; padding: 1rem;
        }
        .completion-title-banner {
            font-size: clamp(2rem, 7vmin, 4rem);
            text-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.2);
            text-align: center; font-family: var(--header-font);
        }
        #completion-overlay .modal {
            background: transparent; box-shadow: none; width: auto; max-width: none;
            display: flex; justify-content: center; align-items: center; padding: 0; overflow: visible;
            border-top:0rem;
        }
        #completion-image {
            width: 100%;
            max-width: 700px;
            height: auto;
            border: 3px solid var(--secondary-color);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            margin-top: 0.5rem;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }
        .completion-buttons {
            position: static;
            width: 100%;
            display: flex;
            justify-content: space-between;
            gap: 1rem;
            padding: 0 2rem 2rem 2rem;
            box-sizing: border-box;
            align-items: flex-end;
            margin-top: 0;
        }
        .completion-btn {
            background: #FBB03B;
            color: #fff;
            font-weight: 700;
            font-size: 1.1rem;
            border: 0.3rem solid #fff;
            border-radius: 3rem;
            padding: 0.75rem 2.25rem;
            margin-top: 1rem;
            cursor: pointer;
            letter-spacing: 0.02em;
            transition: all 0.2s;
            box-shadow: 0 0.25rem 0.5rem rgba(0,0,0,0.2);
        }
        .completion-btn:hover { 
            transform: scale(1.05); 
            box-shadow: 0 0.5rem 1.25rem rgba(0,0,0,0.2);
        }
        
        /* --- GAME SCREEN & LAYOUT --- */
        #game-screen {
            justify-content: flex-start;
            padding: 0;
            overflow: hidden;
            background-color: #e9eef2;
        }
        .game-content {
            width: 100%;
            height: 100%;
            padding: 6.8rem var(--pad-md) var(--pad-md) var(--pad-md);
            display: flex;
            flex-direction: column; 
            gap: var(--pad-md);
        }
        #drop-zones-container {
            width: 100%;
            flex-grow: 1; 
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--pad-lg);
            min-height: 0; 
        }
        #drag-items-container {
            width: 100%;
            height: 15%;
            background: #dcdde1;
            border-radius: var(--border-radius);
            box-shadow: inset 0 5px 15px -5px rgba(0,0,0,0.15);
            padding: var(--pad-md);
            display: flex;
            flex-wrap: wrap;
            gap: var(--pad-sm);
            justify-content: center;
            align-content: flex-start;
            overflow-y: auto;
            flex-shrink: 0;
        }
        
        .drag-item {
            background-color: #fff;
            padding: var(--pad-sm) var(--pad-md);
            border-radius: var(--border-radius);
            box-shadow: 0 2px 5px var(--shadow-light);
            cursor: grab;
            transition: all 0.2s ease;
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--text-color-dark);
            border: 3px solid #ccc;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            min-width: 8rem;
        }
        .drag-item:active { cursor: grabbing; }
        .drag-item.dragging {
            opacity: 0.5;
            transform: scale(1.05);
        }

        .drop-zone {
            display: flex;
            flex-direction: column;
            background: #fdfdff;
            border-radius: var(--border-radius);
            overflow-y: auto;
        }
        .drop-zone-header {
            font-size: var(--font-lg);
            font-weight: 800;
            color: white;
            padding: var(--pad-sm);
            text-align: center;
            border-bottom: 4px solid rgba(0,0,0,0.1);
            border-top-left-radius: calc(var(--border-radius) - 3px);
            border-top-right-radius: calc(var(--border-radius) - 3px);
        }
        .drop-zone[data-category="Hard Water"] .drop-zone-header { background-color: var(--hard-water-color); }
        .drop-zone[data-category="Soft Water"] .drop-zone-header { background-color: var(--soft-water-color); }

        .drop-zone.drag-over {
            transform: scale(1.02);
            border-style: solid;
        }
        .drop-zone[data-category="Hard Water"].drag-over { border-color: var(--hard-water-color); }
        .drop-zone[data-category="Soft Water"].drag-over { border-color: var(--soft-water-color); }

        /* --- MODIFIED: STYLES FOR DROPPED ITEMS CONTAINER --- */
        .items-landed-container {
            flex-grow: 1;
            padding: var(--pad-lg);
            display: flex;
            flex-direction: column; /* Stack items vertically */
            gap: var(--pad-md); /* Space between stacked items */
            justify-content: flex-start; /* Start stacking from the top */
            align-items: center; /* Center items horizontally */
            overflow-y: auto;
        }
        /* --- MODIFIED: STYLES FOR DROPPED ITEMS --- */
        .items-landed-container .drag-item {
            cursor: default;
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            width: 85%; /* Make items wider */
            min-height: 5.5rem; /* Make items taller */
            font-size: 1.5rem; /* Increase font size */
            padding: var(--pad-md); /* Increase padding */
        }
        .items-landed-container .drag-item.in-hard-water {
            background-color: #e8f5e9;
            border-color: var(--hard-water-color);
        }
        .items-landed-container .drag-item.in-soft-water {
            background-color: #eaf4fb;
            border-color: var(--soft-water-color);
        }
        @keyframes popIn { from { transform: scale(0.7); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* --- BUTTONS --- */
        #help-button, .hint-icon { animation: glow-pulse-white 2.5s infinite ease-in-out; }
        #help-button {
            width: 4rem; height: 4rem;
            background: rgba(255, 255, 255, 0.2);
            border: 0.2rem solid rgba(255, 255, 255, 0.3);
            border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.3s ease; padding: 0; color: white; }
        #help-button svg { width: 50%; height: 50%; fill: white; }
        #help-button:hover { transform: scale(1.1); animation: none; }

        #hint-button {
            position: absolute;
            bottom: 2rem; right: 2rem;
            z-index: 20;
            width: 5rem; height: 5rem;
            background: var(--secondary-color);
            border: 0.3rem solid white;
            border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.3s ease;
            box-shadow: 0 0.4rem 1.5rem rgba(251, 176, 59, 0.4);
            animation: glow-pulse 2.5s infinite ease-in-out;
        }
        #hint-button:hover { animation: none; transform: scale(1.1); box-shadow: 0 0.6rem 2.5rem rgba(251, 176, 59, 0.8); }
        #hint-button svg { width: 2.4rem; height: 2.4rem; fill: white; }
        #hint-button.hidden { display: none; }

        /* --- NEW MODAL STYLES --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.4); backdrop-filter: blur(0.3125rem);
            z-index: 3000; display: flex; justify-content: center; align-items: center;
            opacity: 0; pointer-events: none; transition: opacity 0.3s ease; padding: 1rem;
        }
        .modal-overlay.active { opacity: 1; pointer-events: all; }
        
        .modal {
            background-color: #ffffff; padding: 2.5rem; border-radius: 1rem;
            text-align: center; width: 90%; max-width: 37.5rem; /* 600px */
            border-top: 0.5rem solid; /* 8px */
            transform: scale(0.95);
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .modal-overlay.active .modal { transform: scale(1); }
        
        .modal-title { 
            font-size: 2rem; font-weight: 600; margin-bottom: 1.5rem; 
            display: flex; align-items: center; justify-content: center; gap: 0.75rem; 
        }
        .modal-title svg { width: 2rem; height: 2rem; }
        
        .modal-text { 
            font-size: 1.2rem; line-height: 1.6; color: var(--text-color-dark); margin-bottom: 1.5rem; 
        }
        
        .modal-button {
            width: 100%; padding: 1rem; font-size: 1.2rem; font-weight: 700;
            border: none; border-radius: 0.75rem; cursor: pointer; color: #fff;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .modal-button:hover { transform: scale(1.02); }
        
        /* Specific Modal Styles */
        #narration-modal-overlay .modal, #help-modal-overlay .modal { border-color: var(--primary-color); }
        #narration-modal-overlay .modal-title, #help-modal-overlay .modal-title { color: var(--primary-color); }
        #narration-modal-overlay .modal-button, #help-modal-overlay .modal-button { background-color: var(--primary-color); }
        
        #hint-modal-overlay .modal { border-color: var(--secondary-color); }
        #hint-modal-overlay .modal-title { color: var(--secondary-color); }
        #hint-modal-overlay .modal-button { background-color: var(--secondary-color); }
        
        #feedback-modal-overlay .modal.correct-feedback { border-color: var(--correct-color); }
        #feedback-modal-overlay .modal.correct-feedback .modal-title { color: var(--correct-color); }
        #feedback-modal-overlay .modal.correct-feedback .modal-button { background-color: var(--correct-color); }
        
        #feedback-modal-overlay .modal.incorrect-feedback { border-color: var(--incorrect-color); }
        #feedback-modal-overlay .modal.incorrect-feedback .modal-title { color: var(--incorrect-color); }
        #feedback-modal-overlay .modal.incorrect-feedback .modal-button { background-color: var(--incorrect-color); }

        .narration-text {
            font-size: 1.3rem; line-height: 1.6; color: var(--text-color-dark); margin-bottom: 1.5rem;
            text-align: left; background: #f8f9fa; padding: 1.5rem;
            border-radius: 0.75rem; border-left: 0.25rem solid var(--primary-color);
        }
        #help-modal .modal-text { text-align: left; }

        .shake { animation: shake 0.82s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); }
        }
        @keyframes glow-pulse {
            0%, 100% { box-shadow: 0 0 10px rgba(251, 176, 59, 0.5), 0 0 20px rgba(251, 176, 59, 0.3); transform: scale(1); }
            50% { box-shadow: 0 0 20px rgba(251, 176, 59, 0.8), 0 0 30px rgba(251, 176, 59, 0.5); transform: scale(1.1); }
        }
        @keyframes glow-pulse-white {
            0%, 100% { box-shadow: 0 0 10px rgba(255, 255, 255, 0.7), 0 0 20px rgba(255, 255, 255, 0.5); transform: scale(1); }
            50% { box-shadow: 0 0 20px rgba(255, 255, 255, 1), 0 0 30px rgba(255, 255, 255, 0.7); transform: scale(1.1); }
        }

        /* --- Media Query for smaller screens --- */
        @media (max-width: 991px) {
            #completion-image { max-width: 56vw; width: 100%; }
            .items-landed-container .drag-item {
                cursor: default;
                animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
                width: 85%;
                min-height: 3.5rem;
                font-size: 1.5rem;
                padding: var(--pad-md);
                height: 12vh;
            }
             .items-landed-container {
                gap: 1rem;
             }
        }
        @media (max-width: 768px), (max-height: 500px) {
            body { padding: 0; }
            #game-wrapper { aspect-ratio: unset; width: 100vw; height: 100vh; border-radius: 0; box-shadow: none; }
            html { font-size: 2.8vmin; } /* Adjusted for better mobile scaling */
            .game-content { flex-direction: column; padding: 7rem var(--pad-sm) var(--pad-sm) var(--pad-sm); }
            #drag-items-container { height: auto; flex-basis: 27%; flex-wrap: wrap; }
            #drop-zones-container { flex-basis: 65%;}
            .drag-item { font-size: var(--font-sm); min-width: 6rem; }
            .completion-buttons { gap: 0.75rem; position: static; padding: 1rem; }
        }
    </style>
</head>
<body>
    <div id="game-wrapper">
        <div id="game-container">
            <div class="game-header">
                <h1>Water for Every Use</h1>
                <div class="header-progress">
                    <div id="header-progress-container">
                        <div id="header-progress-bar"></div>
                    </div>
                    <div id="header-progress-text">0 / 5</div>
                    <button id="help-button" class="help-icon" title="Help">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-.9.92C13.45 12.9 13 13.5 13 15h-2v-.5c0-1.1.45-2.1 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41 0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25z"/></svg>
                    </button>
                </div>
            </div>

            <div id="start-screen" class="screen">
                <h1>Water for Every Use</h1>
                <button class="start-button">Start Activity</button>
            </div>

            <div id="game-screen" class="screen hidden">
                <div class="game-content">
                    <div id="drop-zones-container"></div>
                    <div id="drag-items-container"></div>
                </div>
                <button id="hint-button" class="hint-icon hidden" title="Get a Hint">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M9 21c0 .5.4 1 1 1h4c.6 0 1-.5 1-1v-1H9v1zm3-19C8.1 2 5 5.1 5 9c0 2.4 1.2 4.5 3 5.7V17c0 .5.4 1 1 1h6c.6 0 1-.5 1-1v-2.3c1.8-1.3 3-3.4 3-5.7 0-3.9-3.1-7-7-7z"/></svg>
                </button>
            </div>

            <div id="completion-overlay" class="screen hidden">
                <h2 class="completion-title-banner">Activity Wrap Up!</h2>
                <div class="modal">
                    <img id="completion-image" src="images/complete.jpg" alt="Activity summary showing completed classification." onerror="this.src='https://placehold.co/600x400/5D04B2/ffffff?text=Well+Done!'; this.onerror=null;">
                </div>
                <div class="completion-buttons">
                    <button class="completion-btn" id="previous-activity-btn">Previous Activity</button>
                    <button class="completion-btn" id="restart-activity-btn">Restart Activity</button>
                    <button class="completion-btn" id="next-activity-btn">Next Activity</button>
                </div>
            </div>

            <div id="feedback-modal-overlay" class="modal-overlay">
                <div id="feedback-modal" class="modal">
                    <h2 class="modal-title" id="feedback-title"></h2>
                    <p class="modal-text" id="feedback-modal-text"></p>
                    <button class="modal-button" id="feedback-modal-btn">Continue</button>
                </div>
            </div>

            <div id="narration-modal-overlay" class="modal-overlay">
                <div id="narration-modal" class="modal">
                    <h2 class="modal-title">Activity Introduction</h2>
                    <p class="narration-text" id="narration-text"></p>
                    <button class="modal-button" id="continue-narration-btn">Continue</button>
                </div>
            </div>

            <div id="help-modal-overlay" class="modal-overlay">
                <div id="help-modal" class="modal">
                    <h2 class="modal-title">Learner Instructions</h2>
                    <div class="modal-text" id="help-modal-text"></div>
                    <button class="modal-button" id="help-modal-btn">Got It!</button>
                </div>
            </div>

            <div id="hint-modal-overlay" class="modal-overlay">
                <div id="hint-modal" class="modal">
                    <h2 class="modal-title">Here's a Hint...</h2>
                    <p class="modal-text" id="hint-modal-text"></p>
                    <button class="modal-button" id="hint-modal-btn">Thanks!</button>
                </div>
            </div>
            
            <audio id="intro-audio" src="audio/intro.mp3" preload="auto"></audio>
            <audio id="outro-audio" src="audio/outro.mp3" preload="auto"></audio>
            <audio id="correct-audio" src="audio/ding.mp3" preload="auto"></audio>
            <audio id="incorrect-audio" src="audio/buzz.mp3" preload="auto"></audio>

        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- CONSTANTS ---
    const endScreenDelay = 500;

    // --- DOM ELEMENTS ---
    const startScreen = document.getElementById('start-screen');
    const gameScreen = document.getElementById('game-screen');
    const completionOverlay = document.getElementById('completion-overlay');
    const gameHeader = document.querySelector('.game-header');
    const startBtn = document.querySelector('.start-button');
    const narrationModalOverlay = document.getElementById('narration-modal-overlay');
    const narrationText = document.getElementById('narration-text');
    const continueNarrationBtn = document.getElementById('continue-narration-btn');
    const modalOverlay = document.getElementById('feedback-modal-overlay');
    const modal = document.getElementById('feedback-modal');
    const feedbackTitle = document.getElementById('feedback-title');
    const feedbackText = document.getElementById('feedback-modal-text');
    const feedbackModalBtn = document.getElementById('feedback-modal-btn');
    const dragItemsContainer = document.getElementById('drag-items-container');
    const dropZonesContainer = document.getElementById('drop-zones-container');
    const helpButton = document.getElementById('help-button');
    const helpModalOverlay = document.getElementById('help-modal-overlay');
    const helpModalText = document.getElementById('help-modal-text');
    const helpModalBtn = document.getElementById('help-modal-btn');
    const hintButton = document.getElementById('hint-button');
    const hintModalOverlay = document.getElementById('hint-modal-overlay');
    const hintModalText = document.getElementById('hint-modal-text');
    const hintModalBtn = document.getElementById('hint-modal-btn');
    const progressBar = document.getElementById('header-progress-bar');
    const progressText = document.getElementById('header-progress-text');
    const restartActivityBtn = document.getElementById('restart-activity-btn');
    const introAudio = document.getElementById('intro-audio');
    const outroAudio = document.getElementById('outro-audio');
    const correctAudio = document.getElementById('correct-audio');
    const incorrectAudio = document.getElementById('incorrect-audio');

    // --- GAME DATA ---
    const gameContent = {
        intro: "Different types of water are better suited for different tasks. Some are rich in minerals, while others are better for washing. Let us find the best match! Can you pair each household use with the right type of water?",
        instructions: "<p>Drag each household use to the correct water type category.</p><p>Think about the benefits or disadvantages of each water type.</p><p>You may try again if you make a mistake.</p>",
        hint: "<p>Hard water contains calcium and magnesium minerals.</p><p>Soft water lathers easily and prevents scum buildup.</p><p>Some uses require minerals, others need soap efficiency.</p>",
        conclusion: "Excellent judgment! You matched each task to the right water type. Knowing which type to use makes daily life healthier, easier, and more efficient."
    };

    const gameData = [
        { id: 'drinking', text: 'Drinking', category: 'Hard Water', feedback: { correct: 'Yes. Hard water contains minerals like calcium that are beneficial to health.', incorrect: 'Try again. Soft water lacks important minerals needed in drinking water.' } },
        { id: 'laundry', text: 'Laundry', category: 'Soft Water', feedback: { correct: 'Correct. Soft water allows soap to lather better and avoids stains on clothes.', incorrect: 'Not quite. Hard water reacts with soap, forming scum and using more detergent.' } },
        { id: 'bathing', text: 'Bathing', category: 'Soft Water', feedback: { correct: 'Well done. Soft water feels gentle on skin and does not cause soap buildup.', incorrect: 'Recheck. Hard water often causes dryness and scum during bathing.' } },
        { id: 'cooking', text: 'Cooking', category: 'Hard Water', feedback: { correct: 'Yes. Using hard water in cooking supplies essential minerals in food.', incorrect: 'Try again. Cooking with soft water may remove important dietary minerals.' } },
        { id: 'gardening', text: 'Gardening', category: 'Hard Water', feedback: { correct: 'Right! Plants benefit from the minerals in hard water, especially calcium and magnesium.', incorrect: 'Oops. Soft water lacks nutrients that help plants grow.' } }
    ];

    const categories = [
        { id: "Hard Water", title: "Hard Water" },
        { id: "Soft Water", title: "Soft Water" }
    ];

    const icons = {
        correct: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>`,
        incorrect: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>`,
    };

    let score = 0;
    const totalQuestions = gameData.length;
    let draggedItem = null;
    let currentDropZone = null;
    let ghostElement = null;
    let touchOffsetX = 0;
    let touchOffsetY = 0;

    function initializeGame() {
        score = 0;
        
        narrationText.innerHTML = gameContent.intro;
        helpModalText.innerHTML = gameContent.instructions;
        hintModalText.innerHTML = gameContent.hint;

        dragItemsContainer.innerHTML = '';
        dropZonesContainer.innerHTML = '';

        const shuffledData = [...gameData].sort(() => Math.random() - 0.5);

        shuffledData.forEach(itemData => {
            const itemEl = document.createElement('div');
            itemEl.className = 'drag-item';
            itemEl.innerHTML = itemData.text;
            itemEl.draggable = true;
            itemEl.dataset.id = itemData.id;
            itemEl.title = itemData.text.replace(/<[^>]*>?/gm, ''); // Tooltip on hover without HTML
            dragItemsContainer.appendChild(itemEl);
        });

        categories.forEach(cat => {
            const zoneEl = document.createElement('div');
            zoneEl.className = 'drop-zone';
            zoneEl.dataset.category = cat.id;
            zoneEl.innerHTML = `
                <div class="drop-zone-header">${cat.title}</div>
                <div class="items-landed-container"></div>
            `;
            dropZonesContainer.appendChild(zoneEl);
        });

        addDragAndDropListeners();
        updateProgressBar();
    }
    
    function addDragAndDropListeners() {
        const draggables = document.querySelectorAll('.drag-item');
        const dropZones = document.querySelectorAll('.drop-zone');

        draggables.forEach(draggable => {
            draggable.addEventListener('dragstart', () => {
                draggedItem = draggable;
                setTimeout(() => draggable.classList.add('dragging'), 0);
            });
            draggable.addEventListener('dragend', () => {
                if (draggedItem) {
                    draggedItem.classList.remove('dragging');
                }
                draggedItem = null;
            });
        });

        dropZones.forEach(zone => {
            zone.addEventListener('dragover', e => {
                e.preventDefault();
                zone.classList.add('drag-over');
            });
            zone.addEventListener('dragleave', () => {
                zone.classList.remove('drag-over');
            });
            zone.addEventListener('drop', e => {
                e.preventDefault();
                zone.classList.remove('drag-over');
                if (draggedItem) {
                    handleDrop(zone, draggedItem);
                }
            });
        });

        draggables.forEach(draggable => {
            draggable.addEventListener('touchstart', (e) => {
                if (draggable.closest('.drop-zone')) return;

                e.preventDefault();
                draggedItem = draggable;

                const touch = e.touches[0];
                const rect = draggedItem.getBoundingClientRect();

                touchOffsetX = touch.clientX - rect.left;
                touchOffsetY = touch.clientY - rect.top;

                ghostElement = draggedItem.cloneNode(true);
                ghostElement.classList.add('dragging');
                ghostElement.style.position = 'fixed';
                ghostElement.style.zIndex = '10000';
                ghostElement.style.pointerEvents = 'none';
                ghostElement.style.width = `${rect.width}px`;
                ghostElement.style.height = `${rect.height}px`;
                ghostElement.style.left = `${touch.clientX - touchOffsetX}px`;
                ghostElement.style.top = `${touch.clientY - touchOffsetY}px`;
                
                document.body.appendChild(ghostElement);
                draggedItem.classList.add('dragging');

            }, { passive: false });
        });

        document.addEventListener('touchmove', (e) => {
            if (!ghostElement) return;
            e.preventDefault();

            const touch = e.touches[0];
            
            ghostElement.style.left = `${touch.clientX - touchOffsetX}px`;
            ghostElement.style.top = `${touch.clientY - touchOffsetY}px`;

            const elementUnder = document.elementFromPoint(touch.clientX, touch.clientY);
            const targetZone = elementUnder ? elementUnder.closest('.drop-zone') : null;

            if (currentDropZone !== targetZone) {
                if (currentDropZone) {
                    currentDropZone.classList.remove('drag-over');
                }
                if (targetZone) {
                    targetZone.classList.add('drag-over');
                }
                currentDropZone = targetZone;
            }
        }, { passive: false });

        document.addEventListener('touchend', () => {
            if (!draggedItem || !ghostElement) return;

            document.body.removeChild(ghostElement);
            ghostElement = null;

            if (currentDropZone) {
                handleDrop(currentDropZone, draggedItem);
                currentDropZone.classList.remove('drag-over');
            }

            draggedItem.classList.remove('dragging');
            
            draggedItem = null;
            currentDropZone = null;
        });
    }

    function handleDrop(dropZone, item) {
        if (!item) return;
        
        const itemId = item.dataset.id;
        const itemData = gameData.find(d => d.id === itemId);
        const correctCategory = itemData.category;
        const droppedCategory = dropZone.dataset.category;

        if (correctCategory === droppedCategory) {
            score++;
            updateProgressBar();
            
            const landedContainer = dropZone.querySelector('.items-landed-container');
            item.draggable = false;
            landedContainer.appendChild(item);
            
            if (droppedCategory === 'Hard Water') {
                item.classList.add('in-hard-water');
            } else {
                item.classList.add('in-soft-water');
            }
            
            showFeedback(true, itemData.feedback.correct, false);
        } else {
            showFeedback(false, itemData.feedback.incorrect, true);
        }
    }

    function switchScreen(hideScreen, showScreen) {
        hideScreen.classList.add('hidden');
        if (showScreen === gameScreen) {
            gameHeader.classList.add('visible');
            hintButton.classList.remove('hidden');
        } else if (hideScreen === gameScreen) {
            gameHeader.classList.remove('visible');
            hintButton.classList.add('hidden');
        }
        setTimeout(() => showScreen.classList.remove('hidden'), 50);
    }

    function updateProgressBar() {
        const percentage = totalQuestions > 0 ? (score / totalQuestions) * 100 : 0;
        progressBar.style.width = `${percentage}%`;
        progressText.textContent = `${score} / ${totalQuestions}`;
    }

    function showFeedback(isCorrect, message, shouldShake) {
        let titleText;
        let sound;

        modal.className = 'modal'; // Reset classes
        if (shouldShake && draggedItem) {
            draggedItem.classList.add('shake');
            draggedItem.addEventListener('animationend', () => draggedItem.classList.remove('shake'), { once: true });
        }

        if (isCorrect) {
            titleText = "Correct!";
            sound = correctAudio;
            modal.classList.add('correct-feedback');
            feedbackTitle.innerHTML = `${icons.correct} ${titleText}`;
        } else {
            titleText = "Try Again";
            sound = incorrectAudio;
            modal.classList.add('incorrect-feedback');
            feedbackTitle.innerHTML = `${icons.incorrect} ${titleText}`;
        }

        feedbackText.innerHTML = message;
        
        sound.currentTime = 0;
        sound.play().catch(e => console.log("Audio play failed."));

        modalOverlay.classList.add('active');
        checkGameCompletion();
    }

    function checkGameCompletion() {
        if (score === totalQuestions) {
            feedbackModalBtn.textContent = "Continue";
            feedbackModalBtn.onclick = handleFinishClick;
        } else {
            feedbackModalBtn.textContent = "Continue";
            feedbackModalBtn.onclick = handleContinueClick;
        }
    }

    const handleFinishClick = () => {
        modalOverlay.classList.remove('active');
        setTimeout(() => {
            switchScreen(gameScreen, completionOverlay);
            outroAudio.play().catch(e => console.log("Outro audio play failed."));
        }, endScreenDelay);
    };

    const handleContinueClick = () => {
        modalOverlay.classList.remove('active');
    };

    function showNarration() {
        introAudio.currentTime = 0;
        introAudio.play().catch(e => console.log("Intro audio play failed."));
        narrationModalOverlay.classList.add('active');
    }
    
    function stopAllAudio() {
        [introAudio, outroAudio, correctAudio, incorrectAudio].forEach(audio => {
            if (audio && !audio.paused) {
                audio.pause();
                audio.currentTime = 0;
            }
        });
    }

    function restartGame() {
        stopAllAudio();
        initializeGame();
        switchScreen(completionOverlay, gameScreen);
    }

    startBtn.addEventListener('click', () => {
        switchScreen(startScreen, gameScreen);
        initializeGame();
        showNarration();
        if (typeof sendEvent !== 'undefined' && typeof ActivityEvent !== 'undefined') {
            sendEvent(ActivityEvent.START_ACTIVITY, { activityName: 'Water for Every Use' });
        }
    });
    documnet.getElementById('previous-activity-btn').addEventListener('click', () => {
        if (typeof sendEvent !== 'undefined' && typeof ActivityEvent !== 'undefined') {
            sendEvent(ActivityEvent.END_ACTIVITY, { activityName: 'Water for Every Use' });
        }
        // Placeholder for navigation logic
        window.location.href = "../ACTIVITY1/index.html"; // Example navigation
    });
    restartActivityBtn.addEventListener('click', restartGame);
    
    document.querySelectorAll('.completion-buttons button').forEach(button => {
        button.addEventListener('click', stopAllAudio);
    });

    continueNarrationBtn.addEventListener('click', () => {
        narrationModalOverlay.classList.remove('active');
        stopAllAudio();
    });

    helpButton.addEventListener('click', () => helpModalOverlay.classList.add('active'));
    helpModalBtn.addEventListener('click', () => helpModalOverlay.classList.remove('active'));

    hintButton.addEventListener('click', () => hintModalOverlay.classList.add('active'));
    hintModalBtn.addEventListener('click', () => hintModalOverlay.classList.remove('active'));


    document.getElementById('next-activity-btn').addEventListener('click', () => {
        if (typeof sendEvent !== 'undefined' && typeof ActivityEvent !== 'undefined') {
            sendEvent(ActivityEvent.END_ACTIVITY, { activityName: 'Water for Every Use' });
        }
        // Placeholder for navigation logic
        window.location.href = "../ACTIVITY2/index.html"; // Example navigation
    });
});
</script>

</body>
</html>