<!DOCTYPE html>
<html lang="en-GB">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Water Detective Lab</title>
<style>
    /* Font Imports and Keyframes */
    @font-face {
        font-family: 'Fredoka';
        src: url('../assets/Fredoka-VariableFont_wdth\,wght.ttf') format('truetype');
    }
    @keyframes glow-pulse {
        0%, 100% { box-shadow: 0 0 10px rgba(251, 176, 59, 0.5), 0 0 20px rgba(251, 176, 59, 0.3); transform: scale(1); }
        50% { box-shadow: 0 0 20px rgba(251, 176, 59, 0.8), 0 0 30px rgba(251, 176, 59, 0.5); transform: scale(1.05); }
    }
    @keyframes glow-pulse-white {
        0%, 100% { box-shadow: 0 0 10px rgba(255, 255, 255, 0.7), 0 0 20px rgba(255, 255, 255, 0.5); transform: scale(1); }
        50% { box-shadow: 0 0 20px rgba(255, 255, 255, 1), 0 0 30px rgba(255, 255, 255, 0.7); transform: scale(1.1); }
    }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes slideIn { from { transform: translateY(30px) scale(0.95); opacity: 0; } to { transform: translateY(0) scale(1); } }
    @keyframes shake { 0%, 100% { transform: translateX(0); } 20%, 60% { transform: translateX(-8px); } 40%, 80% { transform: translateX(8px); } }
    
    ::-webkit-scrollbar{ display: none; }

    /* Root Variables */
    :root {
        --primary-color: #5D04B2;
        --secondary-color: #fbb03b;
        --correct-color: #28a745;
        --incorrect-color: #dc3545;
        --text-color-dark: #343a40;
        --text-color-light: #fff;
        --card-background-light: #ffffff;
        --shadow-dark: rgba(0, 0, 0, 0.2);
        --border-radius: 1rem;
        --header-font: 'Fredoka', sans-serif;
    }

    /* Global Reset & Base Styles */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { width: 100%; height: 100%; overflow: hidden; }

    body {
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: #f0f4f8;
        font-family: var(--header-font), sans-serif;
    }

    #game-wrapper {
        width: 100%;
        max-width: 1200px;
        height: auto;
        aspect-ratio: 16 / 9;
        box-shadow: 0 0.9375rem 2.5rem var(--shadow-dark);
        overflow: hidden;
        position: relative;
        display: flex;
        flex-direction: column;
        background: #fff;
    }

    #game-container {
        width: 100%;
        height: 100%;
        position: relative;
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }
    
    .screen {
        width: 100%;
        height: 100%;
        position: absolute;
        top: 0;
        left: 0;
        display: flex;
        flex-direction: column;
        transition: opacity 0.5s ease-in-out;
        overflow: hidden;
    }
    .screen.hidden { opacity: 0; pointer-events: none; }
    
    #start-screen {
       background-image: url(images/gamebg.jpg);
       background-size: cover;
       background-position: center;
       justify-content: center;
       align-items: center;
       padding: 2rem;
       text-align: center;
    }
    #start-screen h1 {
       font-size: clamp(2.5rem, 5vw, 4.2rem);
       color: var(--text-color-light);
       margin-bottom: 1.2rem;
       text-shadow: 0 4px 8px rgba(0,0,0,0.3);
       font-weight: 500;
    }
    .start-button { 
        background: var(--secondary-color); color: #fff; font-weight: 900;
        font-size: 1.1rem; border: 3px solid #fff; border-radius: 3rem;
        padding: 0.75rem 2.25rem; margin-top: 1rem; cursor: pointer;
        text-shadow: 0 2px 0 #b88b2a; transition: all 0.2s;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    .start-button:hover { transform: scale(1.06); box-shadow: 0 6px 24px rgba(0,0,0,0.18); }

    #game-screen { background: #f8f9ff; }

    .game-top-section {
        width: 100%; flex-shrink: 0; display: flex; justify-content: space-between;
        align-items: center; background-color: var(--primary-color);
        color: var(--text-color-light); padding: clamp(0.5rem, 1.5vmin, 0.75rem) clamp(0.75rem, 2vmin, 1.25rem);
        box-shadow: 0 2px 10px rgba(0,0,0,0.2); gap: 1rem; flex-wrap: wrap;
    }
    
    #game-title {
        font-size: clamp(1.2rem, 3vmin, 1.8rem); font-weight: 600;
        text-shadow: 0 2px 4px rgba(0,0,0,0.3); flex: 1 1 300px; min-width: 0;
    }

    .progress-area { display: flex; align-items: center; gap: clamp(0.5rem, 1.5vw, 1rem); flex-shrink: 0; }
    #progress-container {
        width: clamp(100px, 15vw, 200px); background-color: rgba(255,255,255,0.3);
        border-radius: 1rem; height: clamp(15px, 2.5vmin, 20px);
        border: 2px solid #fff; position: relative; overflow: hidden;
    }
    #progress-bar {
        height: 100%; width: 0%; background: #ffff00;
        border-radius: 0.8rem; transition: width 0.5s ease;
    }
    #progress-text {
        color: var(--text-color-light); font-weight: 700;
        font-size: clamp(0.75rem, 2vmin, 1rem); text-shadow: 1px 1px 2px rgba(0,0,0,0.6);
    }
    .instructions-icon {
        width: clamp(30px, 4vmin, 40px); height: clamp(30px, 4vmin, 40px); background: rgba(255, 255, 255, 0.2); border-radius: 50%;
        display: flex; align-items: center; justify-content: center; cursor: pointer;
        transition: all 0.3s ease; flex-shrink: 0; animation: glow-pulse-white 2s infinite;
    }
    .instructions-icon:hover { background: rgba(255, 255, 255, 0.3); transform: scale(1.1); }
    .instructions-icon svg { fill: white; width: 50%; height: 50%; }

    .game-main {
        flex: 1; display: flex; align-items: center; justify-content: center;
        padding: clamp(0.5rem, 2vmin, 2rem); overflow: hidden;
        position: relative;
    }
    
    #hotspot-container {
        position: relative;
        width: 100%;
        max-width: 1000px; /* Adjust as needed */
        margin: auto;
    }

    #hotspot-img {
        width: 100%;
        height: auto;
        display: block;
        border-radius: var(--border-radius);
    }
    
    .hotspot {
        position: absolute;
        width: 15%; /* Relative size */
        height: 30%; /* Relative size */
        border: 3px solid transparent;
        border-radius: 50%;
        cursor: pointer;
        transition: all 0.3s ease;
        animation: glow-pulse 2.5s infinite;
    }
    .hotspot:hover {
        background-color: rgba(255, 255, 255, 0.3);
        border-color: var(--secondary-color);
        transform: scale(1.1);
    }
    .hotspot.completed {
        background-color: rgba(40, 167, 69, 0.5);
        border-color: var(--correct-color);
        cursor: not-allowed;
        animation: none;
        pointer-events: none;
    }
    .hotspot.completed::after {
        content: '✔';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: white;
        font-size: clamp(2rem, 5vmin, 4rem);
        text-shadow: 0 2px 4px rgba(0,0,0,0.5);
    }

    /* Hotspot Positions */
    #hotspot-color { top: 30%; left: 10%; width: 18%; height: 42%; border-radius: 15%; }
    #hotspot-odour {
        top: 40%;
        left: 39%;
        width: 15%;
        height: 30%;
        border-radius: 20%;
    }  
    #hotspot-taste {
        top: 65%;
        left: 55%;
        width: 15%;
        height: 15%;
        border-radius: 15%;
    }    
    #hotspot-boiling {
        top: 25%;
        left: 70%;
        width: 20%;
        height: 25%;
        border-radius: 15%;
    }

    /* Modal Styles */
    .modal-overlay {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background-color: rgba(0,0,0,0.4); backdrop-filter: blur(5px);
        z-index: 3000; display: flex; justify-content: center; align-items: center;
        animation: fadeIn 0.3s ease;
    }
    .modal-overlay.hidden { display: none; }
    
    .modal-content {
        background: var(--card-background-light); padding: clamp(1.5rem, 3vw, 2.5rem);
        border-radius: var(--border-radius); text-align: center;
        width: 90%; max-width: 800px; /* Increased max-width for bigger modals */
        animation: slideIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        position: relative; max-height: 90vh; overflow-y: auto;
    }
    .modal-content h2 {
      font-size: clamp(1.5rem, 4vw, 2rem); font-weight: 600; margin-bottom: 1.5rem;
      color: var(--primary-color);
    }
    .modal-content p { font-size: clamp(1rem, 2.5vw, 1.2rem); line-height: 1.6; color: var(--text-color-dark); }
     .modal-content ul {
        list-style-type: none; text-align: left; margin-top: 1rem; padding: 0; font-size: clamp(0.9rem, 2vmin, 1.1rem);
    }
    .modal-content li { margin-bottom: 0.8rem; padding-left: 1.5rem; position: relative; }
    .modal-content li::before { content: ''; position: absolute; left: 0; }

    .modal-btn {
        min-width: 150px; padding: 1rem; font-size: 1.2rem; font-weight: 700;
        border: none; border-radius: 0.75rem; cursor: pointer; color: #fff;
        background-color: var(--primary-color); transition: transform 0.2s, box-shadow 0.2s;
        margin-top: 1.5rem; width: 100%;
    }
    .modal-btn:hover { transform: scale(1.02); }
    #activity-intro-overlay .modal-content, #instructions-overlay .modal-content { border-top: 8px solid var(--primary-color); }
    #activity-intro-overlay .modal-content p{
        text-align: left; background: #f8f9fa; padding: 1.5rem;
        border-radius: 0.75rem; border-left: 4px solid var(--primary-color);
    }

    /* Test-specific Modal Styling */
    .test-options-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-top: 1.5rem; }
    .option-button {
        background: #fff; border: 2px solid #ddd; border-radius: 1rem; padding: 1.2rem; cursor: pointer;
        transition: all 0.3s ease; font-size: clamp(1rem, 2.5vmin, 1.2rem); color: var(--text-color-dark); font-weight: 700;
        box-shadow: 0 4px 8px rgba(0,0,0,0.05); text-align: center;
    }
    .option-button:hover:not(:disabled) { transform: translateY(-3px); border-color: var(--primary-color); box-shadow: 0 6px 15px rgba(0,0,0,0.1); }
    .option-button:disabled { cursor: not-allowed; opacity: 0.7; }

    /* Colour Test Drag & Drop */
    #colour-test-area { display: flex; flex-direction: column; align-items: center; gap: 1.5rem; }
    #colour-draggable {
        width: 100px;
        height: 100px;
        border-radius: 0.5rem;
        cursor: grab;
        user-select: none;
        box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        object-fit: cover;
        position: relative; /* For the snap-back effect */
        transition: transform 0.3s ease-out, box-shadow 0.3s ease-out; /* For smooth snapback */
    }
    #colour-draggable:active { cursor: grabbing; }
    #colour-draggable.dragging {
        z-index: 5000;
        transition: none; /* disable transition while dragging */
        box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        transform: scale(1.1);
    }
    #colour-drop-zones { display: flex; justify-content: center; gap: 1rem; flex-wrap: wrap; }
    .colour-drop-zone {
        padding: 1rem; width: 120px; height: 80px;
        border: 3px dashed #ccc; border-radius: var(--border-radius);
        display: flex; align-items: center; justify-content: center;
        font-weight: bold; transition: all 0.3s ease;
    }
    .colour-drop-zone.over { background-color: #d4edda; border-color: var(--correct-color); transform: scale(1.05); }

    /* Boiling Test Layout */
    #boiling-test-content {
        display: flex; flex-direction: column; align-items: center; gap: 1rem; width: 100%;
    }
    #boiling-main-area {
        display: flex; gap: 1.5rem; width: 100%;
        flex-direction: row;
    }
    @media (max-width: 768px) { #boiling-main-area { flex-direction: column; } }
    
    #boiling-canvas-container { flex: 1; min-height: 300px; position: relative; background: #e9f5ff; border-radius: var(--border-radius); }
    #boiling-canvas { width: 100%; height: 100%; display: block; }
    #boiling-quiz-container { flex: 1; display: flex; flex-direction: column; justify-content: center; }
    .boiling-quiz-options { display: flex; flex-direction: column; gap: 0.75rem; }


    /* Feedback Popup */
    .feedback-modal .modal-content { border-top: 8px solid; }
    .feedback-modal.correct .modal-content { border-color: var(--correct-color); }
    .feedback-modal.incorrect .modal-content { border-color: var(--incorrect-color); }
    .feedback-modal h2 { font-weight: 700; }
    .feedback-modal h2 svg {
        vertical-align: middle;
        width: 1.5em;
        height: 1.5em;
        margin-right: 0.4em;
        display: inline-block;
    }
    .feedback-modal.correct h2 { color: var(--correct-color); }
    .feedback-modal.incorrect h2 { color: var(--incorrect-color); }
    .feedback-modal .modal-btn { background-color: #333; }
    .feedback-modal.correct .modal-btn { background-color: var(--correct-color); }
    .feedback-modal.incorrect .modal-btn { background-color: var(--incorrect-color); }

    /* Completion Screen Styling from Reference */
    #completion-overlay {
        background-image: url('images/gamebg.jpg');
        background-size: cover; background-position: center;
        color: #fff; flex-direction: column;
        justify-content: center; align-items: center; gap: 1rem; padding: 1rem;
    }
    .completion-title-banner {
        font-size: clamp(2rem, 7vmin, 4rem); text-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.2);
        text-align: center; font-family: var(--header-font);
        font-weight: 600;
    }
    #completion-overlay .modal-content {
        background: transparent; box-shadow: none; width: auto; max-width: none;
        display: flex; justify-content: center; align-items: center; padding: 0; overflow: visible;
    }
    #completion-image {
        width: 60%;
        max-width: 100%;
        height: auto;
        border: 3px solid var(--secondary-color);
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        margin-top: 0.5rem;
        display: block;
        margin-left: auto;
        margin-right: auto;
        margin-bottom: 5rem;
    }
    .completion-buttons {
        position: absolute;
            bottom: 2rem;
            left: 2rem;
            right: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
    }
    .completion-btn {
        background: #FBB03B;
        color: #fff;
        font-weight: 500;
        font-size: 1.32rem;
        border: 3.6px solid #fff;
        border-radius: 3rem;
        padding: 0.72rem 2.64rem;
        margin-top: 1rem;
        cursor: pointer;
        letter-spacing: 0.04em;
        text-shadow: 0 2px 0 #b88b2a;
        transition: all 0.2s;
        font-family: var(--header-font);
        white-space: nowrap;
    }
    .completion-btn:hover { transform: scale(1.05); box-shadow: 0 0.5rem 1.25rem rgba(0,0,0,0.2); }


    .visually-hidden {
        position: absolute; width: 1px; height: 1px; margin: -1px; padding: 0;
        overflow: hidden; clip: rect(0, 0, 0, 0); border: 0;
    }

    #orientation-lock {
        display: none; position: fixed; top: 0; left: 0;
        width: 100vw; height: 100vh; background: #f0f4f8;
        z-index: 10000; flex-direction: column; justify-content: center;
        align-items: center; text-align: center; padding: 2rem;
    }

    @media (orientation: portrait) {
        #game-wrapper { display: none; }
        #orientation-lock { display: flex; }
    }

    @media (max-width:991px){
         #game-wrapper {
            width: 100vw !important; height: 100vh !important;
            border-radius: 0 !important; max-width: none !important;
            aspect-ratio: unset !important; box-shadow: none;
        }
         #completion-image { width: 55%; }
         .completion-btn { font-size: clamp(0.8rem, 2.5vw, 1rem); padding: 0.6rem 1.2rem; }
    }
    @media (max-width: 768px){
        #completion-image { width: 67%; }

    }
</style>
</head>
<body>

<div id="orientation-lock">
    <h2>Please rotate your device to landscape mode to play.</h2>
</div>

<div id="game-wrapper">
   <div id="game-container">
        <div id="start-screen" class="screen">
            <h1>Water Detective Lab</h1>
            <button class="start-button">Start Activity</button>
        </div>

        <div id="game-screen" class="screen hidden">
            <div class="game-top-section">
               <h1 id="game-title">Virtual Lab: Test the 4 Properties</h1>
               <div class="progress-area">
                   <div id="progress-container"><div id="progress-bar"></div></div>
                   <div id="progress-text">0 / 4</div>
               </div>
               <div class="instructions-icon">
                   <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-.9.92C13.45 12.9 13 13.5 13 15h-2v-.5c0-1.1.45-2.1 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41 0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25z"/></svg>
               </div>
            </div>
            <main class="game-main">
                <div id="hotspot-container">
                    <img src="images/hotspot-img.jpg" id="hotspot-img" alt="A virtual lab station with four test areas: a colour chart and beaker, a steaming beaker, a taste test sensor, and a beaker being heated by a bunsen burner with a thermometer.">
                    <div id="hotspot-color" class="hotspot" data-test="color" aria-label="Colour Test Area"></div>
                    <div id="hotspot-odour" class="hotspot" data-test="odour" aria-label="Odour Test Area"></div>
                    <div id="hotspot-taste" class="hotspot" data-test="taste" aria-label="Taste Test Area"></div>
                    <div id="hotspot-boiling" class="hotspot" data-test="boiling" aria-label="Boiling Point Test Area"></div>
                </div>
            </main>
        </div>
        
        <div id="activity-intro-overlay" class="modal-overlay hidden">
            <div class="modal-content">
                <h2>Activity Introduction</h2>
                <p>This is your virtual lab station, young scientist. You will test water’s colour, smell, taste, and boiling point. Carefully observe each reaction and make your decision. Ready your tools, it is time to discover what truly makes water pure.</p>
                <button class="modal-btn" id="intro-continue-btn">Continue</button>
            </div>
        </div>
        <div id="instructions-overlay" class="modal-overlay hidden">
           <div class="modal-content">
               <h2>Instructions</h2>
               <ul id="instructions-list">
                    <li>Click on each of the four highlighted areas to start a test.</li>
                    <li>Perform the test using the provided interactive tools.</li>
                    <li>Select the correct observation from the options given.</li>
                    <li>Continue until all four tests are completed.</li>
               </ul>
               <button class="modal-btn" id="close-instructions-btn">Got it!</button>
           </div>
        </div>

        <div id="colour-test-overlay" class="modal-overlay hidden">
            <div class="modal-content">
                <h2>Colour Test</h2>
                <p>Drag the water sample to the correct colour description below.</p>
                <div id="colour-test-area">
                    <img id="colour-draggable" src="images/water.png" alt="Water sample in a beaker">
                    <div id="colour-drop-zones">
                        <div class="colour-drop-zone" data-option="Blue" style="background-color: #a0c4ff;">Blue</div>
                        <div class="colour-drop-zone" data-option="Red" style="background-color: #ffadad;">Red</div>
                        <div class="colour-drop-zone" data-option="Green" style="background-color: #b3e6b3;">Green</div>
                        <div class="colour-drop-zone" data-option="Colourless" style="background-color: #f1f1f1;">Colourless</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="odour-test-overlay" class="modal-overlay hidden">
            <div class="modal-content">
                <h2>Odour Test</h2>
                <p>Click the “Sniff” icon and select the correct observation.</p>
                <div class="test-options-grid">
                    <button class="option-button" data-option="Floral">Floral</button>
                    <button class="option-button" data-option="Rotten">Rotten</button>
                    <button class="option-button" data-option="Minty">Minty</button>
                    <button class="option-button" data-option="Odourless">Odourless</button>
                </div>
            </div>
        </div>

        <div id="taste-test-overlay" class="modal-overlay hidden">
            <div class="modal-content">
                <h2>Taste Test</h2>
                <p>Click the “Taste” button and select the correct observation.</p>
                 <div class="test-options-grid">
                    <button class="option-button" data-option="Salty">Salty</button>
                    <button class="option-button" data-option="Sweet">Sweet</button>
                    <button class="option-button" data-option="Sour">Sour</button>
                    <button class="option-button" data-option="Tasteless">Tasteless</button>
                </div>
            </div>
        </div>
        
        <div id="boiling-test-overlay" class="modal-overlay hidden">
                 <div class="modal-content">
                     <h2>Boiling Point Test</h2>
                <div id="boiling-test-content">
                    <p id="boiling-instruction">Turn on the burner and observe the thermometer.</p>
                    <div id="boiling-main-area">
                        <div id="boiling-canvas-container">
                            <canvas id="boiling-canvas"></canvas>
                        </div>
                        <div id="boiling-quiz-container" class="hidden">
                             <h3>What is the boiling point of pure water?</h3>
                             <div class="boiling-quiz-options">
                                <button class="option-button" data-option="90°C">90°C</button>
                                <button class="option-button" data-option="95°C">95°C</button>
                                <button class="option-button" data-option="100°C">100°C</button>
                                <button class="option-button" data-option="105°C">105°C</button>
                            </div>
                        </div>
                    </div>
                    <button class="modal-btn" id="burner-btn">Turn On Burner</button>
                </div>
            </div>
        </div>
        
        <div id="feedback-overlay" class="modal-overlay feedback-modal hidden">
            <div class="modal-content">
                <h2 id="feedback-title"></h2>
                <p id="feedback-text"></p>
                <button class="modal-btn" id="feedback-continue-btn">Continue</button>
            </div>
        </div>

        <div id="completion-overlay" class="modal-overlay hidden">
            <h2 class="completion-title-banner">Activity Wrap Up!</h2>
            <div class="modal-content">
                 <img id="completion-image" src="images/complete.jpg" alt="Completion celebration">
            </div>
            <div class="completion-buttons">
                <button class="completion-btn" id="prev-btn">Previous Activity</button>
                <button class="completion-btn" id="restart-btn">Restart Activity</button>
                <button class="completion-btn" id="next-btn">Next Activity</button>

            </div>
        </div>
        
        <div id="aria-live-announcer" class="visually-hidden" aria-live="polite"></div>
        
    <audio id="ding-sound" src="audio/ding.mp3" preload="auto"></audio>
    <audio id="buzz-sound" src="audio/buzz.mp3" preload="auto"></audio>
    <audio id="intro-sound" src="audio/intro.mp3" preload="auto"></audio>
    <audio id="outro-sound" src="audio/outro.mp3" preload="auto"></audio>
    <audio id="boil-sound" src="audio/boil.mp3" preload="auto" loop></audio>
   </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- Data ---
    const TESTS = {
        color: { id: 'color', completed: false, answer: 'Colourless', feedback: { correct: "Excellent! Pure water has no colour.", incorrect: "Not quite. A pure substance like water does not appear coloured." } },
        odour: { id: 'odour', completed: false, answer: 'Odourless', feedback: { correct: "Correct. Pure water should smell like nothing  truly scent-free.", incorrect: "Close observation! However, any fragrance suggests an impurity." } },
        taste: { id: 'taste', completed: false, answer: 'Tasteless', feedback: { correct: "Correct! Pure water has no flavour. It is neutral to your tongue.", incorrect: "Hmm… good thinking, but taste in water indicates dissolved salts or impurities." } },
        boiling: { id: 'boiling', completed: false, answer: '100°C', feedback: { correct: "Spot on! Pure water boils exactly at 100°C under standard sea-level pressure.", incorrect: "Try again. For pure water, the boiling point is always 100°C at sea level." } }
    };
    const TOTAL_TESTS = Object.keys(TESTS).length;

    // --- DOM Elements ---
    const getEl = id => document.getElementById(id);
    const query = sel => document.querySelector(sel);
    const queryAll = sel => document.querySelectorAll(sel);
    
    // Screens
    const startScreen = getEl('start-screen');
    const gameScreen = getEl('game-screen');
    
    // Top Bar
    const progressBar = getEl('progress-bar');
    const progressText = getEl('progress-text');

    // Buttons
    const startBtn = query('.start-button');
    const introContinueBtn = getEl('intro-continue-btn');
    const closeInstructionsBtn = getEl('close-instructions-btn');
    const restartBtn = getEl('restart-btn');
    const instructionsIcon = query('.instructions-icon');

    // Overlays & Modals
    const activityIntroOverlay = getEl('activity-intro-overlay');
    const instructionsOverlay = getEl('instructions-overlay');
    const completionOverlay = getEl('completion-overlay');
    const feedbackOverlay = getEl('feedback-overlay');
    const feedbackTitle = getEl('feedback-title');
    const feedbackText = getEl('feedback-text');
    const feedbackContinueBtn = getEl('feedback-continue-btn');
    
    // Hotspots
    const hotspots = queryAll('.hotspot');

    // Test Overlays
    const testOverlays = {
        color: getEl('colour-test-overlay'),
        odour: getEl('odour-test-overlay'),
        taste: getEl('taste-test-overlay'),
        boiling: getEl('boiling-test-overlay')
    };

    // Audio
    const dingSound = getEl('ding-sound'), buzzSound = getEl('buzz-sound');
    const introSound = getEl('intro-sound'), outroSound = getEl('outro-sound');
    const boilSound = getEl('boil-sound');

    // Boiling Test Elements
    const boilingCanvas = getEl('boiling-canvas'), boilingCtx = boilingCanvas.getContext('2d');
    const burnerBtn = getEl('burner-btn');
    const boilingQuizContainer = getEl('boiling-quiz-container');
    const boilingInstruction = getEl('boiling-instruction');
    
    // --- State ---
    let gameState = 'intro';
    let completedTestsCount = 0;
    let currentTest = null;
    let boilingAnimState = { id: null, temp: 20, burnerOn: false, bubbles: [] };

    // --- Sound Management ---
    const playSound = s => { if(s) { s.currentTime = 0; s.play().catch(e => {}); } }
    const stopSound = s => { if(s) { s.pause(); s.currentTime = 0; } }

    // --- Game Logic ---
    function startGame() {
        gameState = 'playing';
        completedTestsCount = 0;
        Object.values(TESTS).forEach(test => test.completed = false);
        hotspots.forEach(h => h.classList.remove('completed'));
        updateProgress();
    }

    function updateProgress() {
        progressBar.style.width = `${(completedTestsCount / TOTAL_TESTS) * 100}%`;
        progressText.textContent = `${completedTestsCount} / ${TOTAL_TESTS}`;
        if (completedTestsCount === TOTAL_TESTS) {
            setTimeout(showCompletion, 500);
        }
    }

    function handleHotspotClick(e) {
        const testId = e.target.dataset.test;
        if (TESTS[testId].completed) return;
        
        currentTest = TESTS[testId];
        testOverlays[testId].classList.remove('hidden');
        if (testId === 'boiling') {
            initBoilingAnimation();
        }
    }

    function completeTest(test) {
        if (test.completed) return;
        test.completed = true;
        completedTestsCount++;
        query(`.hotspot[data-test="${test.id}"]`).classList.add('completed');
        updateProgress();
    }
    
    function showCompletion() {
        gameState = 'done';
        gameScreen.classList.add('hidden');
        playSound(outroSound);
        completionOverlay.classList.remove('hidden');
    }

    function showFeedback(isCorrect, feedback, onContinue) {
        feedbackOverlay.classList.remove('hidden', 'correct', 'incorrect');
        feedbackOverlay.classList.add(isCorrect ? 'correct' : 'incorrect');
        
        const correctSVG = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>`;
        const incorrectSVG = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>`;
        
        feedbackTitle.innerHTML = (isCorrect ? correctSVG : incorrectSVG) + (isCorrect ? "Correct!" : "Incorrect");
        feedbackText.textContent = feedback;
        
        feedbackContinueBtn.onclick = () => {
            feedbackOverlay.classList.add('hidden');
            if (onContinue) onContinue();
        };
    }

    // --- Test Implementations ---

    // Colour Test (Drag & Drop)
    function initColourTest() {
        const draggable = getEl('colour-draggable');
        const dropZones = queryAll('.colour-drop-zone');
        let isDragging = false;
        let dragStartOffset = { x: 0, y: 0 };

        function getPointerCoords(e) {
            if (e.touches && e.touches.length > 0) {
                return { x: e.touches[0].clientX, y: e.touches[0].clientY };
            }
            if (e.changedTouches && e.changedTouches.length > 0) {
                return { x: e.changedTouches[0].clientX, y: e.changedTouches[0].clientY };
            }
            return { x: e.clientX, y: e.clientY };
        }

        function onDragStart(e) {
            if (e.type === 'mousedown') e.preventDefault();
            
            isDragging = true;
            draggable.classList.add('dragging');

            const rect = draggable.getBoundingClientRect();
            const pointer = getPointerCoords(e);
            
            // Set the offset to be the center of the element, so the cursor is in the middle.
            dragStartOffset = {
                x: rect.width / 0.4,
                y: rect.height / 0.5
            };
            
            draggable.style.position = 'fixed';
            
            // Position the element's top-left corner so its center is at the pointer location.
            draggable.style.left = `${pointer.x - dragStartOffset.x}px`;
            draggable.style.top = `${pointer.y - dragStartOffset.y}px`;
            draggable.style.transform = 'scale(1.1)';
            
            window.addEventListener('mousemove', onDragMove);
            window.addEventListener('mouseup', onDragEnd);
            window.addEventListener('touchmove', onDragMove, { passive: false });
            window.addEventListener('touchend', onDragEnd);
        }

        function onDragMove(e) {
            if (!isDragging) return;
            if (e.type === 'touchmove') e.preventDefault();

            const pointer = getPointerCoords(e);
            const newX = pointer.x - dragStartOffset.x;
            const newY = pointer.y - dragStartOffset.y;

            draggable.style.left = `${newX}px`;
            draggable.style.top = `${newY}px`;
            
            const currentElement = document.elementFromPoint(pointer.x, pointer.y);
            dropZones.forEach(zone => {
                zone.classList.toggle('over', zone === currentElement || zone.contains(currentElement));
            });
        }

        function onDragEnd(e) {
            if (!isDragging) return;
            isDragging = false;
            
            window.removeEventListener('mousemove', onDragMove);
            window.removeEventListener('mouseup', onDragEnd);
            window.removeEventListener('touchmove', onDragMove);
            window.removeEventListener('touchend', onDragEnd);

            const pointer = getPointerCoords(e);
            const droppedZone = document.elementFromPoint(pointer.x, pointer.y)?.closest('.colour-drop-zone');

            dropZones.forEach(z => z.classList.remove('over'));

            if (droppedZone) {
                handleDrop(droppedZone.dataset.option);
            } else {
                resetDraggablePosition();
            }
        }
        
        function resetDraggablePosition() {
            draggable.classList.remove('dragging');
            draggable.style.position = 'relative';
            draggable.style.left = '';
            draggable.style.top = '';
            draggable.style.transform = '';
        }

        function handleDrop(selectedOption) {
            const isCorrect = selectedOption === currentTest.answer;
            playSound(isCorrect ? dingSound : buzzSound);
            
            showFeedback(isCorrect, isCorrect ? currentTest.feedback.correct : currentTest.feedback.incorrect, () => {
                if (isCorrect) {
                    testOverlays.color.classList.add('hidden');
                    completeTest(currentTest);
                }
                resetDraggablePosition();
            });
        }
        
        draggable.addEventListener('mousedown', onDragStart);
        draggable.addEventListener('touchstart', onDragStart, { passive: true });
    }

    // Odour & Taste Tests (Button Clicks)
    function initSimpleTests() {
        ['odour', 'taste'].forEach(testId => {
            const overlay = testOverlays[testId];
            overlay.querySelectorAll('.option-button').forEach(btn => {
                btn.addEventListener('click', () => {
                    currentTest = TESTS[testId];
                    const selectedOption = btn.dataset.option;
                    const isCorrect = selectedOption === currentTest.answer;
                    playSound(isCorrect ? dingSound : buzzSound);
                    showFeedback(isCorrect, isCorrect ? currentTest.feedback.correct : currentTest.feedback.incorrect, () => {
                         if (isCorrect) {
                            overlay.classList.add('hidden');
                            completeTest(currentTest);
                        }
                    });
                });
            });
        });
    }

    // Boiling Point Test (Canvas & Quiz)
    function initBoilingAnimation() {
        const container = getEl('boiling-canvas-container');
        const rect = container.getBoundingClientRect();
        boilingCanvas.width = rect.width;
        boilingCanvas.height = rect.height;
        boilingAnimState = { id: null, temp: 20, burnerOn: false, bubbles: [] };
        
        burnerBtn.textContent = 'Turn On Burner';
        burnerBtn.disabled = false;
        boilingQuizContainer.classList.add('hidden');
        boilingInstruction.classList.remove('hidden');

        boilingAnimState.id = requestAnimationFrame(boilingLoop);
    }
    
    function boilingLoop() {
        const w = boilingCanvas.width, h = boilingCanvas.height;
        boilingCtx.clearRect(0, 0, w, h);

        // Draw Tripod Stand
        boilingCtx.strokeStyle = '#555';
        boilingCtx.lineWidth = 5;
        boilingCtx.beginPath();
        boilingCtx.moveTo(w * 0.25, h * 0.95);
        boilingCtx.lineTo(w * 0.5, h * 0.6);
        boilingCtx.lineTo(w * 0.75, h * 0.95);
        boilingCtx.moveTo(w * 0.3, h * 0.65);
        boilingCtx.lineTo(w * 0.7, h * 0.65);
        boilingCtx.stroke();
        
        // Draw Beaker
        const beakerW = w * 0.4, beakerH = h * 0.5;
        const beakerX = w * 0.5 - beakerW / 2, beakerY = h * 0.6 - beakerH;
        boilingCtx.fillStyle = 'rgba(200, 220, 255, 0.3)';
        boilingCtx.strokeStyle = '#888';
        boilingCtx.lineWidth = 3;
        boilingCtx.beginPath();
        boilingCtx.moveTo(beakerX, beakerY);
        boilingCtx.lineTo(beakerX, beakerY + beakerH);
        boilingCtx.lineTo(beakerX + beakerW, beakerY + beakerH);
        boilingCtx.lineTo(beakerX + beakerW, beakerY);
        boilingCtx.stroke();
        boilingCtx.fill();
        
        // Draw Water
        const waterH = beakerH * 0.6;
        boilingCtx.fillStyle = 'rgba(135, 206, 250, 0.7)';
        boilingCtx.fillRect(beakerX, beakerY + beakerH - waterH, beakerW, waterH);
        
        // Draw Burner
        const burnerBaseY = h * 0.95;
        boilingCtx.fillStyle = '#777';
        boilingCtx.fillRect(w/2 - 20, burnerBaseY, 40, 10);
        boilingCtx.fillStyle = '#999';
        boilingCtx.fillRect(w/2 - 5, burnerBaseY - 25, 10, 25);
        
        if (boilingAnimState.burnerOn) {
            // Animate flame
            boilingCtx.fillStyle = `rgba(255, ${100 + Math.random() * 50}, 0, 0.8)`;
            boilingCtx.beginPath();
            boilingCtx.moveTo(w/2, burnerBaseY - 25);
            boilingCtx.bezierCurveTo(w/2-15, burnerBaseY - 50, w/2+15, burnerBaseY - 50, w/2, burnerBaseY - 25);
            boilingCtx.fill();
            
            // Update temp and bubbles
            if (boilingAnimState.temp < 100) {
                boilingAnimState.temp += 0.2;
            } else {
                boilingAnimState.temp = 100;
                stopSound(boilSound);
                burnerBtn.disabled = true;
                boilingInstruction.classList.add('hidden');
                boilingQuizContainer.classList.remove('hidden');
            }
            if (boilingAnimState.temp > 80 && Math.random() > 0.5) {
                boilingAnimState.bubbles.push({
                    x: beakerX + 10 + Math.random() * (beakerW - 20),
                    y: beakerY + beakerH - 10,
                    r: Math.random() * 3 + 1,
                    speed: Math.random() * 1 + 0.5
                });
            }
        }
        
        // Draw Bubbles
        boilingCtx.fillStyle = 'rgba(255, 255, 255, 0.7)';
        boilingAnimState.bubbles.forEach((p, i) => {
            p.y -= p.speed;
            if (p.y < beakerY + beakerH - waterH) boilingAnimState.bubbles.splice(i, 1);
            boilingCtx.beginPath();
            boilingCtx.arc(p.x, p.y, p.r, 0, Math.PI * 2);
            boilingCtx.fill();
        });

        // Draw Thermometer
        const thermX = beakerX + beakerW - 20, thermY = beakerY + 10, thermH = beakerH * 0.8;
        boilingCtx.fillStyle = '#eee';
        boilingCtx.fillRect(thermX, thermY, 10, thermH);
        boilingCtx.beginPath();
        boilingCtx.arc(thermX + 5, thermY + thermH, 10, 0, Math.PI * 2);
        boilingCtx.fill();
        const tempHeight = (boilingAnimState.temp / 100) * (thermH - 10);
        boilingCtx.fillStyle = '#e74c3c';
        boilingCtx.fillRect(thermX + 2, thermY + thermH - 5 - tempHeight, 6, tempHeight);
        boilingCtx.beginPath();
        boilingCtx.arc(thermX + 5, thermY + thermH, 7, 0, Math.PI * 2);
        boilingCtx.fill();
        boilingCtx.fillStyle = '#000';
        boilingCtx.font = '14px sans-serif';
        boilingCtx.textAlign = 'center';
        boilingCtx.fillText(`${Math.floor(boilingAnimState.temp)}°C`, thermX + 30, thermY + thermH / 2);

        boilingAnimState.id = requestAnimationFrame(boilingLoop);
    }
    
    burnerBtn.addEventListener('click', () => {
        if (boilingAnimState.burnerOn) return;
        boilingAnimState.burnerOn = true;
        playSound(boilSound);
        burnerBtn.textContent = 'Heating...';
        burnerBtn.disabled = true;
    });
    
    boilingQuizContainer.addEventListener('click', (e) => {
        if (e.target.classList.contains('option-button')) {
            const selectedOption = e.target.dataset.option;
            const isCorrect = selectedOption === currentTest.answer;
            playSound(isCorrect ? dingSound : buzzSound);
            showFeedback(isCorrect, isCorrect ? currentTest.feedback.correct : currentTest.feedback.incorrect, () => {
                 if (isCorrect) {
                    cancelAnimationFrame(boilingAnimState.id);
                    testOverlays.boiling.classList.add('hidden');
                    completeTest(currentTest);
                }
            });
        }
    });


    // --- Init & Event Listeners ---
    function init() {
        // Main flow
        startBtn.addEventListener('click', () => {
            startScreen.classList.add('hidden');
            gameScreen.classList.remove('hidden');
            activityIntroOverlay.classList.remove('hidden');
            playSound(introSound);
            // sendEvent(ActivityEvent.START_ACTIVITY, {activityName: 'Water Detective Lab'});
        });

        introContinueBtn.addEventListener('click', () => {
            activityIntroOverlay.classList.add('hidden');
            stopSound(introSound);
            startGame();
        });
        
        restartBtn.addEventListener('click', () => {
            completionOverlay.classList.add('hidden');
            gameScreen.classList.remove('hidden');
            startGame();
        });
        
        hotspots.forEach(h => h.addEventListener('click', handleHotspotClick));
        
        // Modals
        instructionsIcon.addEventListener('click', () => instructionsOverlay.classList.remove('hidden'));
        closeInstructionsBtn.addEventListener('click', () => instructionsOverlay.classList.add('hidden'));

        // Init individual test handlers
        initColourTest();
        initSimpleTests();
    }

    init();
});
</script>
<script src = "../eventSender.js"></script>
</body>
</html>