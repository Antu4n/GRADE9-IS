<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Set Up the Boil!</title>
    <style>
        /* Font Imports */
        @font-face {
            font-family: 'Fredoka';
            src: url('../assets/Fredoka-VariableFont_wdth\,wght.ttf') format('truetype');
        }

        /* Root Variables */
        :root {
            --primary-color: #5D04B2;
            --secondary-color: #FBB03B;
            --correct-color: #4caf50;
            --incorrect-color: #e74c3c;
            --text-color-dark: #333;
            --text-color-light: #fff;
            --card-background-light: #ffffff;
            --shadow-dark: rgba(0, 0, 0, 0.3);
            --border-radius: 1rem;
            --header-font: 'Fredoka', sans-serif;
        }

        /* Global Reset & Base Styles */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        body {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #f0f4f8;
            font-family: var(--header-font);
            font-size: 16px;
            overflow: hidden; /* Prevent body scrollbars */
        }

        #game-wrapper {
            width: 100%;
            max-width: 1200px;
            aspect-ratio: 16 / 9;
            margin: auto;
            height: auto;
            position: relative;
            background: #fff;
        }

        #game-container {
            width: 100%;
            height: 100%;
            position: relative;
        }

        .screen {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
            overflow: hidden;
        }

        .screen.hidden {
            opacity: 0;
            pointer-events: none;
            transform: scale(0.95);
        }

        /* Start Screen & End Screen Styles */
        #start-screen, #completion-overlay {
            background: var(--primary-color) url('images/gamebg.jpg') center center/cover no-repeat;
            padding: 2rem;
            z-index: 500;
        }
        
        #start-screen h1 {
            font-size: 4rem;
            color: var(--text-color-light);
            margin-bottom: 1.2rem;
            text-align: center;
            font-family: var(--header-font);
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            font-weight: 500;
        }

        .start-button, .completion-btn {
            background: #FBB03B;
            color: #fff;
            font-weight: 500;
            font-size: 1.32rem;
            border: 3.6px solid #fff;
            border-radius: 3rem;
            padding: 0.72rem 2.64rem;
            margin-top: 1rem;
            cursor: pointer;
            letter-spacing: 0.04em;
            text-shadow: 0 2px 0 #b88b2a;
            transition: all 0.2s;
            font-family: var(--header-font);
            white-space: nowrap;
        }

        .start-button:hover, .completion-btn:hover {
            transform: scale(1.06);
            box-shadow: 0 6px 24px rgba(0, 0, 0, 0.18);
        }

        /* Game Screen Styles */
        #game-screen {
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
        }

        .game-top-section {
            width: 100%;
            flex-shrink: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--primary-color);
            padding: 0.3rem 1.5rem;
            position: relative;
            z-index: 10;
            height: 7vh;
            box-sizing: border-box;
        }
        
        #game-title {
            color: var(--text-color-light);
            font-size: clamp(1rem, 1.8vw, 1.8rem);
            text-shadow: 0 2px 2px rgba(0,0,0,0.3);
            font-family: var(--header-font);
            font-weight: 600;
        }

        .game-top-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        #progress-bar-container {
            width: clamp(120px, 18vw, 250px);
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 1rem;
            height: clamp(16px, 2vw, 22px);
            border: 2px solid rgb(255, 255, 255);
        }

        #progress-bar {
            height: 100%;
            width: 0%;
            background: #ffff00; /* Updated color */
            border-radius: 0.8rem;
            transition: width 0.5s ease;
        }

        #progress-text {
            color: var(--text-color-light);
            font-weight: 500;
            font-size: clamp(0.8rem, 1.2vw, 1.3rem);
            text-shadow: 1px 1px 2px rgba(0,0,0,0.6);
            white-space: nowrap;
        }

        .instructions-icon {
            width: clamp(36px, 3vw, 44px);
            height: clamp(36px, 3vw, 44px);
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 15;
            flex-shrink: 0;
            animation: glow-pulse-white 2s infinite;
        }
        .instructions-icon:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        .instructions-icon svg {
            width: clamp(16px, 1.8vw, 22px);
            height: clamp(16px, 1.8vw, 22px);
            fill: white;
        }

        .hint-icon {
            position: absolute;
            bottom: 1.5rem;
            right: 1.5rem;
            width: clamp(40px, 3.5vw, 50px);
            height: clamp(40px, 3.5vw, 50px);
            background: var(--secondary-color);
            border: 2px solid rgba(255, 255, 255, 0.7);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 100;
            animation: glow-pulse 2s infinite;
        }
        .hint-icon:hover {
             background: #ffc966;
        }
        .hint-icon svg {
            width: clamp(20px, 2vw, 28px);
            height: clamp(20px, 2vw, 28px);
            fill: white;
        }


        /* Game Area */
        .lab-game-area {
            width: 100%;
            flex: 1;
            position: relative;
            background-color: #e8eaf6;
            display: flex;
            gap: 1rem;
            padding: 1rem;
            overflow: hidden;
        }
        
        #burner-container {
            flex: 3;
            height: 100%;
            background-image: url('images/hotspot-img.jpg'); /* Updated Image */
            background-size: contain;
            background-position: center;
            background-repeat: no-repeat;
            position: relative;
        }

        #drag-items-container {
            flex: 1;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            grid-auto-rows: min-content;
            gap: 0.5rem;
            padding: 0.5rem;
            height: 100%;
            overflow-y: auto;
        }

        .drag-item {
            background-color: var(--primary-color);
            color: var(--text-color-light);
            border: 2px solid rgba(255,255,255,0.5);
            border-radius: 0.5rem;
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            cursor: grab;
            transition: transform 0.2s, box-shadow 0.2s, opacity 0.3s;
            font-size: clamp(0.7rem, 1.5vw, 1.1rem); /* Increased font size for legibility */
            padding: 0.5rem; /* Increased padding */
            min-height: 60px; /* Increased min height */
        }
        .drag-item:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .drag-item.dragging {
            opacity: 0.5;
            cursor: grabbing;
            z-index: 1000;
        }
        .drag-item.placed {
            visibility: hidden;
        }
        .drag-item.shake {
            animation: shake 0.5s ease-in-out;
        }
        .touch-clone {
            position: fixed;
            pointer-events: none;
            transform-origin: center center;
            z-index: 9999;
        }

        .drop-zone {
            position: absolute;
            border: 2px dashed var(--primary-color);
            border-radius: 0.25rem;
            transition: background-color 0.3s, border-color 0.3s;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: transparent;
            color: var(--primary-color);
            font-weight: bold;
            font-size: clamp(0.7rem, 1.5vw, 1.1rem);
            text-align: center;
            padding: 0.5rem;
        }
        .drop-zone.drag-over {
            background-color: rgba(251, 176, 59, 0.3);
            border-color: var(--secondary-color);
        }
        .drop-zone.correct {
            background-color: var(--correct-color);
            border: 2px solid #fff;
            color: #fff;
            box-shadow: 0 0 10px var(--correct-color);
            border-radius: 0.5rem;
        }
        .drop-zone.hint-glow {
            animation: hint-animation 2s ease-in-out;
        }


        /* Modals & Overlays */
      #activity-description-overlay, #game-instructions-overlay, #feedback-overlay, #hint-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(5px);
            z-index: 3000;
            display: flex;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s ease;
        }
        #game-instructions-overlay .modal-content p {
            text-align: left;
        }
        #activity-description-overlay.hidden, #game-instructions-overlay.hidden, #feedback-overlay.hidden, #hint-overlay.hidden {
            display: none;
        }
        .modal {
            background: var(--card-background-light);
            padding: 2.5rem;
            border-radius: var(--border-radius);
            text-align: center;
            width: 80%;
            max-width: 600px;
            border-top: 8px solid var(--primary-color);
            animation: slideIn 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            max-height: 80vh;
            overflow-y: auto;
        }
        .modal-title {
            font-size: 2.2rem;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 1.5rem;
            font-family: var(--header-font);
        }
        .modal-content p {
            font-size: 1.2rem;
            line-height: 1.6;
            color: var(--text-color-dark);
            margin-bottom: 1rem;
        }
        #activity-description-overlay .modal-content p {
            text-align: left;
            margin-bottom: 2rem;
            font-family: var(--header-font);
            border-left: 3px solid var(--primary-color);
            box-shadow: 0 4px 18px rgba(93, 4, 178, 0.15);
            border-radius: 1rem;
            padding: 1.2rem 1.5rem;
            background: #f8f9ff;
            margin: 0.5rem 0;
        }
        .modal-close-btn {
            width: 100%;
            padding: 1rem;
            margin-top: 1rem;
            font-size: 1.2rem;
            font-weight: 600;
            border: none;
            border-radius: 0.75rem;
            cursor: pointer;
            color: var(--text-color-light);
            background: var(--primary-color);
            transition: transform 0.2s, box-shadow 0.2s, background-color 0.2s;
            font-family: var(--header-font);
        }
        .modal-close-btn:hover {
            transform: scale(1.03);
            box-shadow: 0 5px 15px rgba(93, 4, 178, 0.3);
        }
        
        #feedback-modal.correct-feedback .modal-close-btn { background-color: var(--correct-color); }
        #feedback-modal.incorrect-feedback .modal-close-btn { background-color: var(--incorrect-color); }
        #feedback-modal.correct-feedback .modal-close-btn:hover { box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4); }
        #feedback-modal.incorrect-feedback .modal-close-btn:hover { box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4); }
        #feedback-modal.correct-feedback .modal-title { color: var(--correct-color); }
        #feedback-modal.correct-feedback { border-top: 8px solid var(--correct-color); }
        #feedback-modal.incorrect-feedback .modal-title { color: var(--incorrect-color); }
        #feedback-modal.incorrect-feedback { border-top: 8px solid var(--incorrect-color); }

        /* Hint Modal Styles */
        #hint-modal {
            border-top: 5px solid var(--secondary-color);
        }
        #hint-modal #hint-title {
            color: var(--secondary-color);
        }
        #hint-modal #hint-close-btn {
            background: var(--secondary-color);
            color: white;
        }
        #hint-modal #hint-close-btn:hover {
            box-shadow: 0 5px 15px rgba(251, 176, 59, 0.4);
        }
        #hint-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        #hint-table th, #hint-table td {
            padding: 0.8rem;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        #hint-table th {
            background-color: #f8f9ff;
            font-weight: bold;
            color: var(--primary-color);
        }
        #hint-table tbody tr:nth-child(even) {
            background-color: #f8f9ff;
        }
        #hint-table td:first-child {
            font-weight: bold;
            width: 40%;
        }

        /* Completion Screen */
        #completion-overlay .completion-modal {
            text-align: center;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 1rem; /* Added gap */
        }
        #completion-overlay #completion-title {
            position: absolute;
            top: 3rem;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            font-size: clamp(2.5rem, 5vw, 3.5rem);
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            font-weight: 500;
        }

        #completion-overlay .completion-image {
            width: clamp(250px, 35vw, 450px);
            height: auto;
            margin: 0;
        }
        #completion-overlay .completion-image img {
            max-width: 100%;
            height: auto;
            border-radius: 1.5rem;
            border: 5px solid var(--secondary-color);
        }
        .completion-buttons-footer {
            position: absolute;
            bottom: 2rem;
            left: 2rem;
            right: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .completion-buttons-footer .restart-btn {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            margin-top: 0;
        }

        /* Animations */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideIn { from { transform: translateY(30px) scale(0.95); opacity: 0; } to { transform: translateY(0) scale(1); opacity: 1; } }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            50% { transform: translateX(5px); }
            75% { transform: translateX(-5px); }
        }
        @keyframes glow-pulse {
            0%, 100% {
                box-shadow: 0 0 10px rgba(251, 176, 59, 0.5), 0 0 20px rgba(251, 176, 59, 0.3);
                transform: scale(1);
            }
            50% {
                box-shadow: 0 0 20px rgba(251, 176, 59, 0.8), 0 0 30px rgba(251, 176, 59, 0.5);
                transform: scale(1.1);
            }
        }
        @keyframes glow-pulse-white {
            0%, 100% {
                box-shadow: 0 0 10px rgba(255, 255, 255, 0.7), 0 0 20px rgba(255, 255, 255, 0.5);
                transform: scale(1);
            }
            50% {
                box-shadow: 0 0 20px rgba(255, 255, 255, 1), 0 0 30px rgba(255, 255, 255, 0.7);
                transform: scale(1.1);
            }
        }
        @keyframes hint-animation {
            0%, 100% { box-shadow: 0 0 0 0 rgba(251, 176, 59, 0); border-color: var(--primary-color); }
            50% { box-shadow: 0 0 25px 10px rgba(251, 176, 59, 0.8); border-color: var(--secondary-color); }
        }

        /* --- Responsiveness --- */
        @media (max-width: 991px) {
             body { overflow: auto; }
            #game-wrapper {
                aspect-ratio: auto;
                height: 100vh;
                min-height: -webkit-fill-available;
            }
             #start-screen h1 {
                font-size: 2.8rem;
                margin-bottom: 1rem;
            }
            .game-top-section {
                height: 8vh;
            }
            .lab-game-area {
                padding: 0.75rem;
                gap: 0.75rem;
                height: 92vh;
            }
            #burner-container {
                flex: 2.5; 
            }
            #drag-items-container {
                flex: 1; 
                padding: 0.25rem;
                overflow-y: auto;
            }
            .drag-item {
                font-size: clamp(0.65rem, 1.4vw, 0.85rem);
                min-height: 45px;
            }
        }

        @media (max-width: 768px) {
             #start-screen h1 {
                font-size: 2.4rem;
                margin-bottom: 1rem;
            }
            .lab-game-area {
                flex-direction: row; 
                padding: 0.5rem;
                gap: 0.5rem;
            }
            #burner-container {
                flex: 2; 
            }
            #drag-items-container {
                flex: 1;
                height: 100%;
                max-height: calc(100% - 1rem); 
                grid-template-columns: repeat(1, 1fr);
                grid-template-rows: repeat(3, 1fr);
                overflow: hidden;
            }
            .drag-item {
                display: none; 
            }
            .drag-item.visible-item {
                display: flex; 
            }
            .drag-item.placed {
                display: none; 
            }

            .game-top-section {
                flex-direction: row;
                height: auto;
                padding: 0.5rem 1rem;
                gap: 0.5rem;
            }
            #game-title {
                width: auto;
                text-align: left;
                margin-bottom: 0;
                font-size: 1.2rem;
            }
             .completion-buttons-footer {
                flex-wrap: nowrap;
                justify-content: space-between;
                gap: 0.5rem;
                bottom: 1rem;
            }
             .completion-buttons-footer .completion-btn {
                font-size: clamp(0.8rem, 2.5vw, 1rem);
                padding: 0.6rem 1.2rem;
            }
            .completion-buttons-footer .restart-btn {
                position: absolute; 
                left: 50%;
                transform: translateX(-50%);
            }
            .hint-icon {
                bottom: 1rem;
                right: 1rem;
            }
        }

        @media (max-width: 480px) {
            #game-title {
                font-size: 1rem;
            }
            .game-top-right {
                gap: 0.5rem;
            }
            .completion-btn {
                font-size: clamp(0.7rem, 2.5vw, 0.9rem);
                padding: 0.5rem 1rem;
            }
             .completion-buttons-footer {
                bottom: 1rem;
                left: 1rem;
                right: 1rem;
            }
             #hint-table {
                font-size: 0.9rem;
            }
            #hint-table td:first-child {
                width: 35%;
            }
        }

        @media (max-width: 600px) {
            #start-screen h1 {
                font-size: 2rem;
                margin-bottom: 1rem;
            }
        }
    </style>
</head>
<body>
    <div id="game-wrapper">
        <div id="game-container">
            <div id="start-screen" class="screen">
                <h1>Set Up the Boil!</h1>
                <button class="start-button" onclick="startGame()">Start Activity</button>
            </div>

            <div id="activity-description-overlay" class="screen hidden">
                <div class="modal">
                    <h2 class="modal-title">Activity Introduction</h2>
                    <div class="modal-content">
                        <p>Here is a water boiling station, but it is all mixed up! Drag the correct labels onto the matching parts of the lab diagram. Look closely at the shapes and positions.</p>
                    </div>
                    <button class="modal-close-btn" onclick="closeActivityDescription()">Continue</button>
                </div>
            </div>

            <div id="game-screen" class="screen hidden">
                <div class="game-top-section">
                    <h1 id="game-title">Set Up the Boil!</h1>
                    <div class="game-top-right">
                        <div id="progress-bar-container">
                            <div id="progress-bar"></div>
                        </div>
                        <div id="progress-text">0 / 6</div>
                        <div class="instructions-icon" onclick="showGameInstructions()">
                            <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-.9.92C13.45 12.9 13 13.5 13 15h-2v-.5c0-1.1.45-2.1 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41 0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25z"/></svg>
                        </div>
                    </div>
                </div>
                <div class="lab-game-area">
                    <div id="burner-container">
                        </div>
                    <div id="drag-items-container">
                        </div>
                </div>
                 <div class="hint-icon" onclick="showHint()">
                    <svg viewBox="0 0 24 24"><path d="M9 21c0 .55.45 1 1 1h4c.55 0 1-.45 1-1v-1H9v1zm3-19C8.14 2 5 5.14 5 9c0 2.38 1.19 4.47 3 5.74V17c0 .55.45 1 1 1h4c.55 0 1-.45 1-1v-2.26c1.81-1.27 3-3.36 3-5.74 0-3.86-3.14-7-7-7z"/></svg>
                </div>
            </div>

            <div id="game-instructions-overlay" class="screen hidden">
                <div class="modal">
                    <h2 class="modal-title">Learner Instructions</h2>
                    <div class="modal-content">
                        <p>1. Drag each label to the matching part of the diagram.</p>
                        <p>2. Use the hint icon if you need help.</p>
                        <p>3. If your choice is correct, the label will lock into place.</p>
                        <p>4. Continue until all six parts are labelled correctly.</p>
                    </div>
                    <button class="modal-close-btn" onclick="closeGameInstructions()">Got It!</button>
                </div>
            </div>

            <div id="feedback-overlay" class="hidden">
                 <div class="modal" id="feedback-modal">
                    <h2 id="feedback-title" class="modal-title">Correct!</h2>
                    <div class="modal-content">
                        <p id="feedback-text"></p>
                    </div>
                    <button class="modal-close-btn" onclick="closeFeedback()">Continue</button>
                </div>
            </div>

            <div id="hint-overlay" class="screen hidden">
                <div class="modal" id="hint-modal">
                    <h2 id="hint-title" class="modal-title">Here's a hint</h2>
                    <div class="modal-content" id="hint-text">
                       <p>"Look closely at the shapes and positions."</p>
                       <table id="hint-table">
                           <thead>
                               <tr>
                                   <th>Part</th>
                                   <th>Hint</th>
                               </tr>
                           </thead>
                           <tbody>
                               </tbody>
                       </table>
                    </div>
                    <button class="modal-close-btn" id="hint-close-btn" onclick="closeHint()">Got It!</button>
                </div>
            </div>

            <div id="completion-overlay" class="screen hidden">
                <div class="completion-modal">
                    <h2 id="completion-title">Activity Wrap-Up</h2>
                    <div class="completion-image">
                        <img src="images/complete.jpg" alt="Activity Complete">
                    </div>
                    <div class="completion-buttons-footer">
                        <button class="completion-btn" onclick="window.location.href='../ACTIVITY1/index.html';sendEvent(ActivityEvent.END_ACTIVITY, {activityName: 'Set Up the boil'})">Previous Activity</button>
                        <button class="completion-btn restart-btn" onclick="restartGame()">Restart Activity</button>
                        <button class="completion-btn" onclick="window.location.href='../ACTIVITY3/index.html';sendEvent(ActivityEvent.END_ACTIVITY, {activityName: 'Set Up the boil'})">Next Activity</button>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <audio id="ding-sound" src="audio/ding.mp3" preload="auto"></audio>
    <audio id="intro-audio" src="audio/intro.mp3" preload="auto"></audio>
    <audio id="outro-audio" src="audio/outro.mp3" preload="auto"></audio>
    <audio id="click-sound" src="audio/buzz.mp3" preload="auto"></audio>

    <script>
        const activityData = [
            { id: 'bunsen-burner', name: 'Bunsen burner', hint: 'Below the tripod', feedback: 'Correct! The Bunsen burner is placed directly under the tripod to heat the water.', incorrectFeedback: 'Not quite. The Bunsen burner must be under the tripod to heat the container evenly.', coords: { top: '70%', left: '5%', width: '22%', height: '8%' } },
            { id: 'beaker', name: 'Beaker', hint: 'On top of wire gauze', feedback: 'Right! The beaker holds the water and must rest securely on the gauze.', incorrectFeedback: 'Try again. The beaker must sit on the wire gauze above the flame.', coords: { top: '20%', left: '5%', width: '22%', height: '8%' } },
            { id: 'tripod-stand', name: 'Tripod stand', hint: 'Supporting the beaker and gauze', feedback: 'Yes! The tripod stand holds everything above the flame at a safe height.', incorrectFeedback: 'Careful! The tripod should surround the Bunsen burner and hold up the beaker.', coords: { top: '55%', left: '0%', width: '22%', height: '8%' } },
            { id: 'wire-gauze', name: 'Wire gauze', hint: 'On top of tripod', feedback: 'Well done. The gauze spreads the heat evenly and supports the beaker.', incorrectFeedback: 'That is not the right spot. Wire gauze always sits between flame and beaker.', coords: { top: '46%', left: '76%', width: '22%', height: '8%' } },
            { id: 'thermometer', name: 'Thermometer', hint: 'Inside beaker (water contact)', feedback: 'Good job. The thermometer must touch the water, not just float in air.', incorrectFeedback: 'Oops. Thermometer must be dipped in the water to read temperature accurately.', coords: { top: '3%', left: '10%', width: '22%', height: '8%' } },
            { id: 'clamp', name: 'Clamp', hint: 'Holding thermometer in place', feedback: 'Perfect! The clamp keeps the thermometer steady and safe from tipping.', incorrectFeedback: 'Check again. The clamp should grip the thermometer, not the beaker.', coords: { top: '78%', left: '72%', width: '22%', height: '8%' } }
        ];

        const TOTAL_PARTS = activityData.length;
        let completedParts = new Set();
        let draggedItem = null;
        let touchClone = null;
        let gameCompleted = false;

        // --- DOM ELEMENTS ---
        const startScreen = document.getElementById('start-screen');
        const activityDescriptionOverlay = document.getElementById('activity-description-overlay');
        const gameScreen = document.getElementById('game-screen');
        const burnerContainer = document.getElementById('burner-container');
        const dragItemsContainer = document.getElementById('drag-items-container');
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');
        const completionOverlay = document.getElementById('completion-overlay');
        const gameInstructionsOverlay = document.getElementById('game-instructions-overlay');
        const feedbackOverlay = document.getElementById('feedback-overlay');
        const hintOverlay = document.getElementById('hint-overlay');
        const feedbackModal = document.getElementById('feedback-modal');
        const feedbackTitle = document.getElementById('feedback-title');
        const feedbackText = document.getElementById('feedback-text');
        
        // --- AUDIO ---
        const dingSound = document.getElementById('ding-sound');
        const introAudio = document.getElementById('intro-audio');
        const outroAudio = document.getElementById('outro-audio');
        const clickSound = document.getElementById('click-sound');

        // --- DYNAMIC ITEM VISIBILITY ---
        function updateVisibleDragItems() {
            const allDragItems = Array.from(document.querySelectorAll('.drag-item'));

            if (window.innerWidth > 768) {
                allDragItems.forEach(item => {
                    item.classList.remove('visible-item');
                    item.style.display = item.classList.contains('placed') ? 'none' : 'flex';
                });
                dragItemsContainer.style.overflowY = 'auto';
                return;
            }

            const visibleItemsToShow = 6;
            const nonPlacedItems = allDragItems.filter(item => !item.classList.contains('placed'));
            allDragItems.forEach(item => item.classList.remove('visible-item'));
            for (let i = 0; i < Math.min(nonPlacedItems.length, visibleItemsToShow); i++) {
                nonPlacedItems[i].classList.add('visible-item');
            }
        }

        function populateHintTable() {
            const hintTableBody = document.querySelector("#hint-table tbody");
            hintTableBody.innerHTML = ''; // Clear previous hints
            activityData.forEach(part => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${part.name}</td>
                    <td>${part.hint}</td>
                `;
                hintTableBody.appendChild(row);
            });
        }

        // --- INITIALIZATION ---
        function initializeGame() {
            burnerContainer.innerHTML = '';
            dragItemsContainer.innerHTML = '';
            completedParts.clear();
            gameCompleted = false;

            activityData.forEach(part => {
                const zone = document.createElement('div');
                zone.className = 'drop-zone';
                zone.dataset.part = part.id;
                zone.style.top = part.coords.top;
                zone.style.left = part.coords.left;
                zone.style.width = part.coords.width;
                zone.style.height = part.coords.height;
                burnerContainer.appendChild(zone);
            });

            const shuffledParts = [...activityData].sort(() => Math.random() - 0.5);
            shuffledParts.forEach(part => {
                const item = document.createElement('div');
                item.className = 'drag-item';
                item.dataset.part = part.id;
                item.textContent = part.name;
                item.draggable = true;
                dragItemsContainer.appendChild(item);
            });
            
            addDragListeners();
            updateProgress();
            updateVisibleDragItems();
            populateHintTable();
        }

        // --- GAME FLOW ---
        function startGame() {
            startScreen.classList.add('hidden');
            gameScreen.classList.remove('hidden');
            initializeGame();
            
            activityDescriptionOverlay.classList.remove('hidden');
            if (introAudio) playSound(introAudio);
            sendEvent(ActivityEvent.START_ACTIVITY, {activityName: 'Set Up the boil'});
        }

        function closeActivityDescription() {
            activityDescriptionOverlay.classList.add('hidden');
            if (introAudio) introAudio.pause();
        }
        
        function restartGame() {
            if (outroAudio) outroAudio.pause();
            completionOverlay.classList.add('hidden');
            gameScreen.classList.remove('hidden');
            initializeGame();
        }

        function showHint() {
            hintOverlay.classList.remove('hidden');
        }

        function closeHint() {
            hintOverlay.classList.add('hidden');
        }
        
        // --- UI & FEEDBACK ---
        function updateProgress() {
            const progress = (completedParts.size / TOTAL_PARTS) * 100;
            progressBar.style.width = progress + '%';
            progressText.textContent = `${completedParts.size} / ${TOTAL_PARTS}`;
        }

        function showFeedback(part, isCorrect = true) {
            if (isCorrect) {
                feedbackTitle.textContent = 'Correct!';
                feedbackText.textContent = part.feedback;
                feedbackModal.className = 'modal correct-feedback';
            } else {
                feedbackTitle.textContent = 'Try Again!';
                feedbackText.textContent = part.incorrectFeedback;
                feedbackModal.className = 'modal incorrect-feedback';
            }
            feedbackOverlay.classList.remove('hidden');
        }

        function closeFeedback() {
            feedbackOverlay.classList.add('hidden');
            if (completedParts.size === TOTAL_PARTS && !gameCompleted) {
                gameCompleted = true;
                setTimeout(() => {
                    gameScreen.classList.add('hidden');
                    completionOverlay.classList.remove('hidden');
                    if (outroAudio) playSound(outroAudio);
                }, 300);
            }
        }

        // --- MODAL CONTROLS ---
        function showGameInstructions() { gameInstructionsOverlay.classList.remove('hidden'); }
        function closeGameInstructions() { gameInstructionsOverlay.classList.add('hidden'); }

        // --- DRAG AND DROP LOGIC ---
        function addDragListeners() {
            const draggables = document.querySelectorAll('.drag-item');
            const dropzones = document.querySelectorAll('.drop-zone');

            draggables.forEach(draggable => {
                draggable.addEventListener('dragstart', () => {
                    draggable.classList.add('dragging');
                    draggedItem = draggable;
                });
                draggable.addEventListener('dragend', () => {
                    draggable.classList.remove('dragging');
                    draggedItem = null;
                });
            });

            dropzones.forEach(zone => {
                zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('drag-over'); });
                zone.addEventListener('dragleave', () => { zone.classList.remove('drag-over'); });
                zone.addEventListener('drop', e => {
                    e.preventDefault();
                    zone.classList.remove('drag-over');
                    handleDrop(draggedItem, zone);
                });
            });

            draggables.forEach(draggable => { draggable.addEventListener('touchstart', handleTouchStart, { passive: false }); });
            document.addEventListener('touchmove', handleTouchMove, { passive: false });
            document.addEventListener('touchend', handleTouchEnd);
        }

        function handleDrop(item, zone) {
            if (item && zone && item.dataset.part === zone.dataset.part && !completedParts.has(item.dataset.part)) {
                const partId = item.dataset.part;
                const partData = activityData.find(p => p.id === partId);
                completedParts.add(partId);
                item.classList.add('placed');
                zone.classList.add('correct');
                zone.textContent = partData.name;
                playSound(dingSound);
                showFeedback(partData, true);
                updateProgress();
                updateVisibleDragItems();
            } else {
                playSound(clickSound);
                if (item) {
                    const partId = item.dataset.part;
                    const partData = activityData.find(p => p.id === partId);
                    showFeedback(partData, false);
                    item.classList.add('shake');
                    setTimeout(() => item.classList.remove('shake'), 500);
                }
            }
        }
        
        function handleTouchStart(e) {
            if (e.target.classList.contains('placed')) return;
            e.preventDefault();
            draggedItem = e.target;
            draggedItem.classList.add('dragging');
            touchClone = draggedItem.cloneNode(true);
            touchClone.classList.add('touch-clone');
            document.body.appendChild(touchClone);
            const touch = e.touches[0];
            moveClone(touch.clientX, touch.clientY);
        }

        function handleTouchMove(e) {
            if (!draggedItem || !touchClone) return;
            e.preventDefault();
            const touch = e.touches[0];
            moveClone(touch.clientX, touch.clientY);
            touchClone.style.display = 'none';
            const elementUnder = document.elementFromPoint(touch.clientX, touch.clientY);
            touchClone.style.display = '';
            document.querySelectorAll('.drop-zone').forEach(z => z.classList.remove('drag-over'));
            if (elementUnder && elementUnder.classList.contains('drop-zone')) {
                elementUnder.classList.add('drag-over');
            }
        }
        
        function moveClone(x, y) {
             if (!touchClone) return;
             touchClone.style.left = `${x - touchClone.offsetWidth / 2}px`;
             touchClone.style.top = `${y - touchClone.offsetHeight / 2}px`;
        }

        function handleTouchEnd(e) {
            if (!draggedItem || !touchClone) return;
            const touch = e.changedTouches[0];
            touchClone.style.display = 'none';
            const dropTarget = document.elementFromPoint(touch.clientX, touch.clientY);
            touchClone.style.display = '';
            document.querySelectorAll('.drop-zone').forEach(z => z.classList.remove('drag-over'));
            
            if (dropTarget && dropTarget.classList.contains('drop-zone')) {
                handleDrop(draggedItem, dropTarget);
            } else {
                 playSound(clickSound);
                 if(draggedItem) {
                    const partId = draggedItem.dataset.part;
                    const partData = activityData.find(p => p.id === partId);
                    showFeedback(partData, false);
                    draggedItem.classList.add('shake');
                    setTimeout(() => draggedItem.classList.remove('shake'), 500);
                 }
            }
            draggedItem.classList.remove('dragging');
            draggedItem = null;
            if (touchClone.parentNode === document.body) {
                document.body.removeChild(touchClone);
            }
            touchClone = null;
        }

        function playSound(audioElement) {
            if (audioElement) {
                audioElement.currentTime = 0;
                audioElement.play().catch(e => console.log('Audio play failed:', e));
            }
        }

        window.addEventListener('resize', updateVisibleDragItems);

    </script>
    <script src ="../eventSender.js"></script>
</body>
</html>