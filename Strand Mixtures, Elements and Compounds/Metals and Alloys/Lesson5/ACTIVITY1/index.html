<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alloy Detective: Where Am I Used?</title>
    <style>
        /* Font Imports */
        @font-face {
            font-family: 'fredoka';
            src: url('../assets/Fredoka-VariableFont_wdth\,wght.ttf') format('truetype');
        }
        ::-webkit-scrollbar {
            display: none;
        }
        /* Root Variables */
        :root {
            --primary-color: #5D04B2;
            --secondary-color: #fbb03b;
            --progress-color: #ffff00;
            --correct-color: #5cb85c;
            --incorrect-color: #d9534f;
            --text-color-dark: #333;
            --text-color-light: #fff;
            --card-background-light: #ffffff;
            --header-font: 'fredoka', sans-serif;
            --body-font: var(--header-font);
        }

        /* Proportional Scaling System Setup */
        html {
            font-size: 1.8vmin;
        }

        /* Global Reset & Base Styles */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        body {
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #f0f4f8;
            font-family: var(--body-font);
        }

        #game-wrapper {
            width: 100%;
            height: auto;
            aspect-ratio: 16 / 9;
            max-width: 1200px;
            margin: auto;
            position: relative;
        }

        #game-container {
            width: 100%;
            height: 100%;
            position: relative;
            overflow: hidden;
            background-color: var(--primary-color);
        }

        .screen {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
            overflow: hidden;
            padding: 1rem;
        }

        .screen.hidden {
            opacity: 0;
            pointer-events: none;
            transform: scale(0.95);
        }

        
    /* ===== START SCREEN ===== */
    #start-screen {
      color: var(--text-color-light);
      text-align: center;
      padding: 2rem;
      background-image: url('images/gamebg.jpg');
      background-size: cover;
      background-position: center;
      justify-content: center;
      align-items: center;
    }
    
    #start-screen h1 {
      color: var(--text-color-light);
      font-size: 3.2rem;
      font-family: var(--header-font);
      text-shadow: 0 0.2rem 0.5rem rgba(0,0,0,0.4);
      font-weight: 500;
    }
    
    .start-button {
      background: var(--secondary-color);
      color: #fff;
      font-weight: 900;
      font-size: 1.1rem;
      border: 3px solid #fff;
      border-radius: 3rem;
      padding: 0.75rem 2.25rem;
      margin-top: 1rem;
      cursor: pointer;
      letter-spacing: 0.02em;
      transition: all 0.2s;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }
    
    .start-button:hover {
      transform: scale(1.06);
      box-shadow: 0 6px 24px rgba(0, 0, 0, 0.18);
    }
    
        /* Game Screen Styles */
        #game-screen {
             justify-content: flex-start;
             padding: 0;
             display: flex;
             flex-direction: column;
        }
        
        /* Header / Top Bar */
        .game-top-section { 
          width: 100%;
          background-color: #5D04B2;
          padding: 0.75rem 1.25rem;
          display: flex;
          justify-content: space-between;
          align-items: center;
          color: #fff;
          z-index: 10;
          box-shadow: 0 0.1rem 0.5rem rgba(0,0,0,0.2);
          flex-shrink: 0;
        }
        
        #game-title {
          font-size: 1.8rem;
          font-weight: 600;
          margin: 0;
        }
        
        .progress-wrapper {
            display: flex;
            align-items: center;
            gap: 0.8rem;
        }

        /* Progress Bar */
         #progress-container {
            width: 12.5rem;
            background-color: rgba(255,255,255,0.3);
            border-radius: 1rem;
            height: 1.25rem;
            border: 2px solid #fff;
            position: relative;
            overflow: hidden;
        }

        #progress-bar {
            height: 100%;
            width: 0%;
            background: #FFFF00;
            border-radius: 0.8rem;
            transition: width 0.5s ease;
        }

        #progress-text {
            color: var(--text-color-light);
            font-weight: 700;
            font-size: 1rem;
            text-shadow: 0.0625rem 0.0625rem 0.125rem rgba(0,0,0,0.6);
            white-space: nowrap;
        }
            
        @keyframes glow-pulse-white {
            0%, 100% { box-shadow: 0 0 1rem rgba(255, 255, 255, 0.7), 0 0 2rem rgba(255, 255, 255, 0.5); transform: scale(1); }
            50% { box-shadow: 0 0 2rem rgba(255, 255, 255, 1), 0 0 3rem rgba(255, 255, 255, 0.7); transform: scale(1.1); }
        }

        .instructions-icon {
            width: 3rem;
            height: 3rem;
            background: rgba(255, 255, 255, 0.2);
            border: 0.15rem solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 15;
            flex-shrink: 0;
            animation: glow-pulse-white 2s infinite ease-in-out;
        }
        .instructions-icon svg { width: 60%; height: 60%; fill: white; }
        .instructions-icon:hover { 
            transform: scale(1.1);
            animation-play-state: paused;
        }
        
        .lab-game-area {
            width: 100%;
            flex-grow: 1;
            position: relative;
            background-image: url('images/hotspot-img.jpg');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-color: #fafafa;
        }
        
        .hotspot {
            position: absolute;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 2;
            border-radius: 50%;
            background-color: rgba(255, 255, 0, 0.2);
            border: 0.2rem solid white;
            transform: translate(-50%, -50%); /* Center the hotspot */
        }

        @keyframes zone-pulse {
            0% { transform: translate(-50%, -50%) scale(1); box-shadow: 0 0 0 0rem rgba(255, 255, 255, 0.7); }
            70% { box-shadow: 0 0 0 1.5rem rgba(255, 255, 255, 0); }
            100% { transform: translate(-50%, -50%) scale(1); box-shadow: 0 0 0 0rem rgba(255, 255, 255, 0); }
        }
        
        .hotspot.active { animation: zone-pulse 1.5s infinite; }
        .hotspot.completed::before {
            content: '✓';
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2.5rem;
            color: white;
            font-weight: 700;
            text-shadow: 0 0.1rem 0.3rem rgba(0,0,0,0.5);
        }
        .hotspot.completed { 
            pointer-events: none; 
            background-color: rgba(76, 175, 80, 0.3);
            border-color: rgba(255, 255, 255, 0.5); 
            animation: none;
        }
        
        /* MODALS */
        .overlay {
          position: absolute; top: 0; left: 0; width: 100%; height: 100%;
          background-color: rgba(0,0,0,0.4);
          backdrop-filter: blur(0.5rem);
          z-index: 100;
          display: flex; justify-content: center; align-items: center;
          animation: fadeIn 0.3s ease;
          transition: opacity 0.3s, visibility 0.3s;
        }
        .overlay.hidden { display: none; visibility: hidden; opacity: 0;}
        
        .modal {
          background: var(--card-background-light, #fff);
          padding: 2.5rem;
          border-radius: 1rem;
          text-align: center;
          width: 90%; 
          max-width: 50rem;
          animation: slideIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
          position: relative;
        }
        
        .modal .modal-title {
          font-size: 2.2rem; font-weight: 600; margin-bottom: 1.5rem;
          color: var(--primary-color);
        }
        .modal p { font-size: 1.5rem; line-height: 1.6; color: var(--text-color-dark, #333); }

        #activity-description-overlay .modal { border-top: 0.5rem solid var(--primary-color); }
        #activity-description-overlay .modal .modal-title { color: var(--primary-color); }
        #activity-description-overlay .modal p {
          text-align: left; background: #f8f9fa; padding: 1.5rem;
          border-radius: 0.75rem; border-left: 0.4rem solid var(--primary-color);
        }
        
        #game-instructions-overlay .modal { border-top: 0.5rem solid var(--primary-color); }
        #game-instructions-overlay .modal .modal-title { color: var(--primary-color); }
        #game-instructions-overlay .modal p {
            text-align: left;
            background-color: #f8f9fa;
            padding: 1rem 1.5rem;
            border-radius: 0.75rem;
            font-size: 1.2rem; line-height: 1.6;
        }
        
        .modal-close-btn {
          width: 100%; padding: 1.2rem; font-size: 1.5rem; font-weight: 700;
          border: none; border-radius: 0.75rem; cursor: pointer; color: #fff;
          background-color: var(--primary-color);
          transition: transform 0.2s, box-shadow 0.2s;
          margin-top: 1.5rem;
        }
        
        .modal-close-btn:hover { transform: scale(1.02); }

        /* Quiz Modal */
        #quiz-overlay .modal { max-width: 60rem; }
        #quiz-question {
            font-size: 1.8rem;
            font-weight: 500;
            color: var(--text-color-dark);
            margin-bottom: 2rem;
            text-align: left;
        }
        #quiz-options {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
        }
        .option-btn {
            background: linear-gradient(45deg, #FFD700, #FBB03B);
            border: 3px solid white;
            border-radius: 1rem; padding: 1rem; cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1.2rem; line-height: 1.4;
            color: var(--text-color-dark);
            font-weight: 700;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); 
            display: flex; align-items: center; justify-content: flex-start;
            text-align: left;
        }
        .option-btn:hover:not(:disabled) {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 8px 25px rgba(251, 176, 59, 0.4);
        }
        .option-btn.correct {
            background: var(--correct-color);
            color: white; border-color: #fff;
            transform: scale(1.02);
            box-shadow: 0 0 15px var(--correct-color);
        }
        .option-btn.incorrect {
            background: var(--incorrect-color);
            color: white; animation: shake 0.5s;
            box-shadow: 0 0 15px var(--incorrect-color);
        }
        .option-btn:disabled {
            cursor: not-allowed; opacity: 0.7;
        }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 20%, 60% { transform: translateX(-8px); } 40%, 80% { transform: translateX(8px); } }

        /* Feedback Modals */
        .feedback-modal { max-width: 480px; }
        .feedback-header { display: flex; align-items: center; justify-content: center; gap: 0.75rem; margin-bottom: 1rem; }
        .feedback-header h2 { font-size: 2.2rem; font-weight: 700; margin: 0; }
        .feedback-header.correct h2 { color: var(--correct-color); }
        .feedback-header.incorrect h2 { color: var(--incorrect-color); }
        .feedback-btn {
            width: 100%; padding: 1rem; font-size: 1.2rem; font-weight: 700;
            border: none; border-radius: 0.75rem; cursor: pointer; color: #fff;
            transition: transform 0.2s, box-shadow 0.2s; margin-top: 1rem;
        }
        .feedback-btn:hover { transform: scale(1.02); }
        .feedback-btn.correct { background-color: var(--correct-color); }
        .feedback-btn.incorrect { background-color: var(--incorrect-color); }
        #feedback-correct-overlay .modal { border-top: 8px solid var(--correct-color); }
        #feedback-incorrect-overlay .modal { border-top: 8px solid var(--incorrect-color); }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideIn { from { transform: translateY(3rem) scale(0.95); opacity: 0; } to { transform: translateY(0) scale(1); opacity: 1; } }
       
        /* ===== COMPLETION OVERLAY ===== */
        #completion-overlay {
            background-image: url('images/gamebg.jpg');
            background-size: cover; background-position: center; color: #fff;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            gap: 1rem; padding: 1rem;
        }
        .completion-title-banner {
            font-size: clamp(2rem, 7vmin, 4rem);
            text-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.2);
            text-align: center; font-family: var(--header-font);
            font-weight: 600;
        }
        #completion-overlay .modal {
            background: transparent; box-shadow: none; width: auto; max-width: none;
            display: flex; justify-content: center; align-items: center; padding: 0; overflow: visible;
        }
        #completion-image {
            width: 100%;
            max-width: 700px;
            height: auto;
            border: 3px solid var(--secondary-color);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            margin-top: 0.5rem;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }
        .completion-buttons {
            position: static;
            width: 100%;
            display: flex;
            justify-content: space-between;
            gap: 1rem;
            padding: 0 2rem 2rem 2rem;
            box-sizing: border-box;
            align-items: flex-end;
            margin-top: 0;
        }
        .completion-btn {
            background: #FBB03B;
            color: #fff;
            font-weight: 500;
            font-size: 1.5rem;
            border: 3px solid #fff;
            border-radius: 3rem;
            padding: 0.75rem 2.25rem;
            margin-top: 1rem;
            cursor: pointer;
            letter-spacing: 0.02em;
            transition: all 0.2s;
            box-shadow: 0 0.25rem 0.5rem rgba(0, 0, 0, 0.2);
        }
        .completion-btn:hover { 
            transform: scale(1.05); 
            box-shadow: 0 0.5rem 1.25rem rgba(0,0,0,0.2);
        }
        
        
        /* MEDIA QUERIES */
        @media (max-aspect-ratio: 16/9) {
            #game-wrapper {
                max-height: 100%;
                max-width: calc(100vh * 16 / 9);
            }
        }
        @media (max-width: 1200px) {
            html {
                font-size: 2.2vmin;
            }
        }
        
        @media (max-width: 1000px) {
            html{
                font-size: 3vmin;
            }
            #game-wrapper {
                width: 100vw; height: 100vh; min-width: 100vw; min-height: 100vh;
                border-radius: 0; max-width: none; aspect-ratio: unset;
            }
            #completion-image { max-width: 50vw; width: 100%; }

        }
        
        @media (max-width: 768px) {
             html {
                font-size: 3.3vmin;
            }
            .modal {
                padding: 1.5rem;
                width: 95%;
            }
            #quiz-question { font-size: 1.5rem; }
            .option-btn { font-size: 1.1rem; padding: 1rem; }
            .completion-header { font-size: 3rem; }
            .completion-message { font-size: 1.2rem; padding: 0 1.5rem; }
            .completion-buttons { gap: 0.75rem; position: static; padding: 1rem; }
        }
    </style>
</head>
<body>
    <div id="game-wrapper">
        <div id="game-container">
            <div id="start-screen" class="screen">
                <h1>Alloy Detective</h1>
                <button class="start-button" onclick="startGame(); sendEvent(ActivityEvent.START_ACTIVITY, { activityName: 'Alloy Detective' });">Start Activity</button>
            </div>

            <div id="game-screen" class="screen hidden">
                <div class="game-top-section">
                    <h1 id="game-title">Alloy Detective</h1>
                    <div class="progress-wrapper">
                         <div id="progress-container">
                            <div id="progress-bar"></div>
                        </div>
                        <div id="progress-text">0 / 4</div>
                        <div class="instructions-icon" onclick="showGameInstructions()">
                            <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-.9.92C13.45 12.9 13 13.5 13 15h-2v-.5c0-1.1.45-2.1 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41 0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25z"/></svg>
                        </div>
                    </div>
                </div>
                <div class="lab-game-area" id="lab-game-area">
                    </div>
            </div>

            <div id="activity-description-overlay" class="overlay hidden">
                <div class="modal">
                    <h2 class="modal-title">Activity Introduction</h2>
                    <p>Welcome, Alloy Detective! Alloys are everywhere, from your kitchen to the skies. Your task is to explore different everyday objects and figure out why alloys are chosen for each. Click an object, think carefully, and pick the correct reason for its alloy use. Let us investigate!</p>
                    <button class="modal-close-btn" onclick="closeModal('activity-description-overlay');">Continue</button>
                </div>
            </div>
            
            <div id="game-instructions-overlay" class="overlay hidden">
                <div class="modal">
                    <h2 class="modal-title">Learner Instructions</h2>
                    <p>Click on any object to reveal its quiz. Read the question carefully. Choose the correct reason why the alloy is used. Review the feedback after your selection.</p>
                    <button class="modal-close-btn" onclick="closeModal('game-instructions-overlay')">Got It!</button>
                </div>
            </div>
            
            <div id="quiz-overlay" class="overlay hidden">
                 <div class="modal">
                    <h2 id="quiz-question"></h2>
                    <div id="quiz-options"></div>
                </div>
            </div>

            <div id="feedback-correct-overlay" class="overlay hidden">
                <div class="modal feedback-modal">
                    <div class="feedback-header correct"><h2>Correct!</h2></div>
                    <p id="correct-feedback-text"></p>
                    <button class="feedback-btn correct" onclick="closeModal('feedback-correct-overlay')">Continue</button>
                </div>
            </div>
            
            <div id="feedback-incorrect-overlay" class="overlay hidden">
                <div class="modal feedback-modal">
                    <div class="feedback-header incorrect"><h2>Not Quite</h2></div>
                    <p id="incorrect-feedback-text"></p>
                    <button class="feedback-btn incorrect" onclick="handleTryAgain()">Try Again</button>
                </div>
            </div>

            <div id="completion-overlay" class="screen hidden">
                <h2 class="completion-title-banner">Activity Wrap Up!</h2>
                <div class="modal">
                    <img id="completion-image" src="images/complete.jpg" alt="Activity summary showing completed classification." onerror="this.src='https://placehold.co/600x400/5D04B2/ffffff?text=Well+Done!'; this.onerror=null;">
                </div>
                <div class="completion-buttons">
                    <button class="completion-btn" id="restart-activity-btn" onclick="restartActivity()">Restart Activity</button>
                    <button class="completion-btn" id="next-activity-btn" onclick="nextActivity()">Next Activity</button>
                </div>
            </div>
        </div>
    </div>

    <audio id="ding-sound" src="audio/ding.mp3" preload="auto"></audio>
    <audio id="buzz-sound" src="audio/buzz.mp3" preload="auto"></audio>
    <audio id="intro-audio"src="audio/intro.mp3" preload="auto"></audio>
    <audio id="outro-audio" src="audio/outro.mp3" preload="auto"></audio>
    
    <script>
        // --- DATA ---
        const activityData = [
            {
                id: 'spoon',
                title: 'Stainless Steel Spoon',
                question: 'Why is this alloy used here?',
                options: [
                    { text: 'It rusts easily', correct: false },
                    { text: 'It is strong, shiny, and does not corrode', correct: true },
                    { text: 'It is very soft', correct: false },
                    { text: 'It is cheap like wood', correct: false }
                ],
                feedback: {
                    correct: 'Stainless steel keeps your spoon strong and rust-free!',
                    incorrect: 'Stainless steel is used because it resists rust, not because of softness or cost.'
                },
                coords: { top: '45%', left: '7%', width: '10%', height: '35%' }
            },
            {
                id: 'tap',
                title: 'Brass Water Tap',
                question: 'Why is brass used for taps?',
                options: [
                    { text: 'It breaks easily', correct: false },
                    { text: 'It resists rust and looks shiny', correct: true },
                    { text: 'It conducts electricity', correct: false },
                    { text: 'It melts in water', correct: false }
                ],
                feedback: {
                    correct: 'Brass is durable and corrosion-resistant, perfect for plumbing.',
                    incorrect: 'Brass does not rust or melt, it is chosen for durability and appearance.'
                },
                coords: { top: '55%', left: '20%', width: '10%', height: '25%' }
            },
            {
                id: 'bridge',
                title: 'Steel Bridge',
                question: 'Why is steel used in bridges?',
                options: [
                    { text: 'It is decorative', correct: false },
                    { text: 'It is waterproof', correct: false },
                    { text: 'It is strong and supports heavy loads', correct: true },
                    { text: 'It is used in medals', correct: false }
                ],
                feedback: {
                    correct: 'Steel’s strength supports heavy traffic and long spans.',
                    incorrect: 'Steel is chosen for strength, not decoration or waterproofing.'
                },
                coords: { top: '25%', left: '60%', width: '10%', height: '20%' }
            },
            {
                id: 'medal',
                title: 'Bronze Medal',
                question: 'Why is bronze used in medals?',
                options: [
                    { text: 'It rusts quickly', correct: false },
                    { text: 'It has a beautiful finish and is durable', correct: true },
                    { text: 'It is heavier than gold', correct: false },
                    { text: 'It melts easily', correct: false }
                ],
                feedback: {
                    correct: 'Bronze lasts long and looks great, ideal for awards!',
                    incorrect: 'Bronze does not rust or melt easily, it is used for its appearance and durability.'
                },
                coords: { top: '42%', left: '77%', width: '8%', height: '15%' }
            }
        ];
        const TOTAL_ACTIVITIES = activityData.length;

        // --- STATE ---
        let completedActivities = new Set();
        let activeActivity = null;

        // --- DOM ELEMENTS ---
        const startScreen = document.getElementById('start-screen');
        const gameScreen = document.getElementById('game-screen');
        const completionOverlay = document.getElementById('completion-overlay');
        const labGameArea = document.getElementById('lab-game-area');
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');
        const overlays = {
            activityDescription: document.getElementById('activity-description-overlay'),
            gameInstructions: document.getElementById('game-instructions-overlay'),
            quiz: document.getElementById('quiz-overlay'),
            feedbackCorrect: document.getElementById('feedback-correct-overlay'),
            feedbackIncorrect: document.getElementById('feedback-incorrect-overlay'),
        };
        const sounds = {
            ding: document.getElementById('ding-sound'),
            buzz: document.getElementById('buzz-sound'),
            intro: document.getElementById('intro-audio'),
            outro: document.getElementById('outro-audio'),
        };
        const quizElements = {
            question: document.getElementById('quiz-question'),
            options: document.getElementById('quiz-options'),
        };
        
        // --- UTILITY FUNCTIONS ---
        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }
        
        function shuffleQuizOptions() {
            activityData.forEach(activity => {
                activity.shuffledOptions = shuffleArray(activity.options);
            });
        }
        
        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', initializeGame);

        function initializeGame() {
            shuffleQuizOptions(); // Shuffle options for all activities
            labGameArea.innerHTML = ''; 
            activityData.forEach((item, index) => {
                const hotspot = document.createElement('div');
                hotspot.className = 'hotspot active';
                hotspot.id = item.id;
                hotspot.dataset.index = index;
                Object.assign(hotspot.style, item.coords);
                labGameArea.appendChild(hotspot);
            });
            updateHotspotStates();
            updateProgress();
            labGameArea.addEventListener('click', handleHotspotClick);
        }

        // --- GAME FLOW ---
        function startGame() {
            startScreen.classList.add('hidden');
            gameScreen.classList.remove('hidden');
            setTimeout(() => {
                overlays.activityDescription.classList.remove('hidden');
                playSound(sounds.intro);
            }, 500);
        }
        
        function handleHotspotClick(event) {
            const clickedHotspot = event.target.closest('.hotspot');
            if (!clickedHotspot || clickedHotspot.classList.contains('completed')) return;
            
            activeActivity = activityData[parseInt(clickedHotspot.dataset.index)];
            showQuiz(activeActivity);
        }

        function showQuiz(activity) {
            quizElements.question.textContent = activity.question;
            quizElements.options.innerHTML = '';
            
            // Use shuffled options instead of original options
            const optionsToShow = activity.shuffledOptions || activity.options;
            optionsToShow.forEach(option => {
                const button = document.createElement('button');
                button.className = 'option-btn';
                button.textContent = option.text;
                button.onclick = (e) => selectAnswer(option, activity, e.currentTarget);
                quizElements.options.appendChild(button);
            });
            
            overlays.quiz.classList.remove('hidden');
        }

        function selectAnswer(selectedOption, activity, buttonElement) {
            const buttons = quizElements.options.querySelectorAll('.option-btn');
            buttons.forEach(btn => btn.disabled = true);

            if (selectedOption.correct) {
                playSound(sounds.ding);
                buttonElement.classList.add('correct');
                setTimeout(() => showFeedback('correct', activity.feedback.correct), 500);
            } else {
                playSound(sounds.buzz);
                buttonElement.classList.add('incorrect');
                setTimeout(() => showFeedback('incorrect', activity.feedback.incorrect), 500);
            }
        }
        
        function showFeedback(type, message) {
            const overlay = overlays[`feedback${type.charAt(0).toUpperCase() + type.slice(1)}`];
            overlay.querySelector('p').textContent = message;
            overlay.classList.remove('hidden');
        }

        function handleTryAgain() {
            closeModal('feedback-incorrect-overlay');
            const buttons = quizElements.options.querySelectorAll('.option-btn');
            buttons.forEach(btn => {
                btn.disabled = false;
                btn.classList.remove('incorrect');
            });
        }

        function proceedToNextStep() {
            overlays.quiz.classList.add('hidden');
            
            if (activeActivity && !completedActivities.has(activeActivity.id)) {
                completedActivities.add(activeActivity.id);
                updateProgress();
                updateHotspotStates();
            }
             
            activeActivity = null;

            if (completedActivities.size === TOTAL_ACTIVITIES) {
                 setTimeout(() => {
                     gameScreen.classList.add('hidden');
                     completionOverlay.classList.remove('hidden');
                     playSound(sounds.outro); 
                 }, 800);
            }
        }
        
        function restartActivity() {
            stopSound(sounds.outro);
            completedActivities.clear();
            activeActivity = null;
            completionOverlay.classList.add('hidden');
            gameScreen.classList.remove('hidden');
            startScreen.classList.add('hidden');
            initializeGame();
        }
        function previousActivity() {
            stopSound(sounds.outro);
            sendEvent(ActivityEvent.END_ACTIVITY, { activityName: 'Alloy Detective' });
            window.location.href = "../ACTIVITY1/index.html"; 
        }
        const nextActivity = () => {
            stopSound(sounds.outro);
            sendEvent(ActivityEvent.END_ACTIVITY, { activityName: 'Alloy Detective' });
            window.location.href = "../ACTIVITY2/index.html"; 
        }
        
        // --- UI & FEEDBACK ---
        function updateProgress() {
            const progress = (completedActivities.size / TOTAL_ACTIVITIES) * 100;
            progressBar.style.width = `${progress}%`;
            progressText.textContent = `${completedActivities.size} / ${TOTAL_ACTIVITIES}`;
        }
        
        function updateHotspotStates() {
            document.querySelectorAll('.hotspot').forEach((hotspot) => {
                const activityId = hotspot.id;
                hotspot.classList.remove('completed', 'active'); 

                if (completedActivities.has(activityId)) {
                    hotspot.classList.add('completed');
                } else {
                    hotspot.classList.add('active');
                }
            });
        }

        // --- MODAL CONTROLS ---
        function showGameInstructions() { overlays.gameInstructions.classList.remove('hidden'); }
        
        function closeModal(id) {
            document.getElementById(id).classList.add('hidden');
            if (id === 'activity-description-overlay') { 
                stopSound(sounds.intro); 
            }
            if (id === 'feedback-correct-overlay') { 
                proceedToNextStep();
            }
        }
        
        // --- UTILITIES ---
        function playSound(audioEl) {
            if (audioEl) {
                audioEl.currentTime = 0;
                audioEl.play().catch(e => console.error('Audio play failed:', e));
            }
        }

        function stopSound(audioEl) {
            if(audioEl) {
                audioEl.pause();
                audioEl.currentTime = 0;
            }
        }
    </script>
     <script src ="../eventSender.js"></script>
</body>
</html>