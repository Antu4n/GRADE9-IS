<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Who Reacts Faster? - Reactivity Scenarios</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        /* Font Imports */
        @font-face {
            font-family: 'Fredoka';
            /* Assuming assets folder is one level up from where the HTML is. Adjust if needed. */
            src: url('../assets/Fredoka-VariableFont_wdth\,wght.ttf') format('truetype');
        }
        ::-webkit-scrollbar {
            display: none;
        }
        /* Root Variables */
        :root {
            --primary-color: #5D04B2;
            --secondary-color: #fbb03b;
            --progress-color: #ffff00;
            --correct-color: #4caf50;
            --incorrect-color: #d9534f;
            --text-color-dark: #333;
            --text-color-light: #fff;
            --card-background-light: #ffffff;
            --border-radius: 1rem;
            --header-font: 'Fredoka', sans-serif;
            --body-font: var(--header-font);
        }
        
        html {
             font-size: 1.8vmin;
        }

        /* ===== HIDE SCROLLBAR ===== */
        body::-webkit-scrollbar, .scenario-content::-webkit-scrollbar, .modal::-webkit-scrollbar { display: none; }
        body, .scenario-content, .modal { scrollbar-width: none; -ms-overflow-style: none; }

        /* ====== GLOBAL BASE ====== */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            display: flex; justify-content: center; align-items: center;
            min-height: 100vh; background: #f0f4f8;
            font-family: var(--body-font);
            overflow: hidden;
        }
        #game-wrapper {
            width: 100%; max-width: 1200px; aspect-ratio: 16 / 9;
            overflow: hidden;
            display: flex; flex-direction: column; 
            box-shadow: 0 15px 40px rgba(0,0,0,0.3);
            position: relative;
        }
        #game-container {
            width: 100%; height: 100%; background: #fff;
            position: relative; display: flex; flex-direction: column;
        }
        .screen {
            position: absolute; width: 100%; height: 100%; top: 0; left: 0;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: opacity 0.5s ease-in-out, visibility 0.5s;
            pointer-events: all; visibility: visible;
        }
        .hidden { opacity: 0; pointer-events: none; visibility: hidden; }

        /* ===== START SCREEN ===== */
        #start-screen {
            color: var(--text-color-light); text-align: center; padding: 2rem;
            background-image: url('images/gamebg.jpg'); background-size: cover; background-position: center;
        }
        #start-screen h1 {
            color: var(--text-color-light); font-size: 3.2rem;
            font-family: var(--header-font);
            font-weight: 500;
        }
        .start-button { 
            background: #FBB03B; color: #fff; font-weight: 900;
            font-size: 1.1rem; border: 3px solid #fff; border-radius: 3rem;
            padding: 0.75rem 2.25rem; margin-top: 1rem; cursor: pointer;
            letter-spacing: 0.02em; text-shadow: 0 2px 0 #b88b2a;
            transition: all 0.2s; box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .start-button:hover { transform: scale(1.06); box-shadow: 0 6px 24px rgba(0,0,0,0.18); }


        /* ===== GAME SCREEN STYLES ===== */
        #game-screen { 
            justify-content: flex-start; 
            overflow: hidden; 
            position: relative;
            display: flex;
            flex-direction: column;
        }
        
        .game-top-section { 
            width: 100%; background-color: #5D04B2; 
            padding: clamp(0.5rem, 1.5vmin, 0.75rem) clamp(0.75rem, 2vmin, 1.25rem);
            display: flex; justify-content: space-between; align-items: center;
            color: #fff; z-index: 10;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            flex-shrink: 0;
        }
        #game-title {
        font-weight: 700;
            margin: 0; font-family: var(--header-font);
        }
        .top-right-controls { display: flex; align-items: center; gap: 1rem; }
        
        #progress-container { 
            width: clamp(100px, 20vw, 200px); background-color: rgba(255,255,255,0.3);
            border-radius: 1rem; height: clamp(15px, 2.5vmin, 20px);
            border: 2px solid #fff; position: relative; overflow: hidden;
        }
        #progress-bar {
            height: 100%; width: 0%; background: var(--progress-color);
            border-radius: 0.8rem; transition: width 0.5s ease;
        }
        #progress-text {
            font-weight: 700; color: #fff;
            text-shadow: none;
        }

        .instructions-icon {
            width: 2.5rem; height: 2.5rem; background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3); border-radius: 50%; display: flex;
            align-items: center; justify-content: center; cursor: pointer; transition: all 0.3s ease;
            z-index: 15; flex-shrink: 0;
            animation: glow-pulse-white 2s infinite;
        }
        .instructions-icon:hover { background: rgba(255, 255, 255, 0.3); transform: scale(1.1); }
        .instructions-icon svg { width: 1.25rem; height: 1.25rem; fill: white;}

        .hint-icon {
            position: absolute; bottom: 1.5rem; right: 1.5rem; width: 3.125rem; height: 3.125rem;
            background: var(--secondary-color); border-radius: 50%; display: flex;
            align-items: center; justify-content: center; cursor: pointer; transition: all 0.3s ease;
            z-index: 1001;
            border: 0.1875rem solid white;
            animation: glow-pulse 2s infinite;
        }
        .hint-icon:hover { transform: scale(1.1); }
        .hint-icon svg { fill: white; width: 1.5rem; height: 1.5rem; }

        /* ===== MODALS ===== */
        .overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.4);
            backdrop-filter: blur(5px);
            z-index: 3000;
            display: flex; justify-content: center; align-items: center;
            animation: fadeIn 0.3s ease;
        }
        .overlay.hidden { display: none; visibility: hidden; opacity: 0; }
        .modal {
            background: var(--card-background-light); padding: 2.5rem; border-radius: 1rem;
            text-align: center; width: 90%; max-width: 600px;
            animation: slideIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative; box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideIn { from { transform: translateY(30px) scale(0.95); opacity: 0; } to { transform: translateY(0) scale(1); } }

        .modal h2 {
            font-size: 2rem; font-weight: 600; margin-bottom: 1.5rem;
            font-family: var(--header-font);
        }
        .modal p, .modal ul, .modal ol { font-size: 1.5rem; line-height: 1.6; color: var(--text-color-dark, #333); }
        
        #activity-intro-overlay .modal { border-top: 8px solid var(--primary-color); }
        #activity-intro-overlay .modal h2 { color: var(--primary-color); }
        #activity-intro-overlay .modal p {
            text-align: left; background: #f8f9fa; padding: 1.5rem;
            border-radius: 0.75rem; border-left: 4px solid var(--primary-color);
        }
        
        #instructions-overlay .modal { border-top: 8px solid var(--primary-color); }
        #instructions-overlay .modal h2 { color: var(--primary-color); }
        #instructions-overlay .modal ol { text-align: left; padding-left: 2rem; font-size: 1.2rem; }

        #hint-overlay .modal { border-top: 8px solid var(--secondary-color); }
        #hint-overlay .modal h2 { 
            color: var(--secondary-color); display: flex; 
            align-items: center; justify-content: center; gap: 0.75rem; 
        }
        #hint-overlay ul { text-align: left; list-style-position: inside; }

        /* Modal Buttons */
        .modal button {
            width: 100%; padding: 1rem; font-size: 1.2rem; font-weight: 700;
            border: none; border-radius: 0.75rem; cursor: pointer; color: #fff;
            transition: transform 0.2s, box-shadow 0.2s; margin-top: 1rem;
        }
        .modal button:hover { transform: scale(1.02); }
        #activity-intro-overlay button, #instructions-overlay button { background-color: var(--primary-color); }
        #hint-overlay button { background-color: var(--secondary-color); }

        /* Feedback Modals */
        .feedback-modal { max-width: 480px; }
        .feedback-header { display: flex; align-items: center; justify-content: center; gap: 0.75rem; margin-bottom: 1rem; }
        .feedback-header h2 { font-size: 2rem; font-weight: 700; }
        .feedback-header.correct h2 { color: var(--correct-color); }
        .feedback-header.incorrect h2 { color: var(--incorrect-color); }
        .feedback-btn.correct { background-color: var(--correct-color); }
        .feedback-btn.incorrect { background-color: var(--incorrect-color); }
        #feedback-correct-overlay .modal { border-top: 8px solid var(--correct-color); }
        #feedback-incorrect-overlay .modal { border-top: 8px solid var(--incorrect-color); }

        /* ===== COMPLETION SCREEN ===== */
        #completion-overlay { 
            background-image: url('images/gamebg.jpg'); background-size: cover; background-position: center;
            color: #fff; display: flex; flex-direction: column; justify-content: center;
            align-items: center; gap: 1rem; padding: 1rem;
        }
        .completion-title-banner { 
            font-size: clamp(2rem, 7vmin, 4rem);
            text-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.2);
            text-align: center; font-family: var(--header-font);
            font-weight: 500;
        }
        #completion-overlay .modal { 
            background: transparent; box-shadow: none; width: auto; max-width: none;
            display: flex; justify-content: center; align-items: center;
            padding: 0; overflow: visible;
        }
        #completion-image { 
            width: clamp(400px, 70%, 700px); max-width: 85%; height: auto;
            border: 3px solid #FBB03B; border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            margin-top: 0.5rem;
        }
        .completion-buttons {
            display: flex;
            justify-content: space-between;
            gap: 1.5rem;
            width: 100%;
            padding: 1rem 2rem;
        }
        .completion-btn {
            background: #FBB03B; color: #fff; font-weight: 600;
            font-size: 1.1rem; border: 0.1875rem solid #fff; border-radius: 3rem;
            padding: 0.75rem 2.25rem; cursor: pointer; transition: all 0.2s;
            box-shadow: 0 0.25rem 0.5rem rgba(0,0,0,0.2); flex-basis: 30%; max-width: 250px;
        }
        .completion-btn:hover { transform: scale(1.05); box-shadow: 0 0.5rem 1.25rem rgba(0,0,0,0.2); }
    
        /* ===== SCENARIO LAYOUT ===== */
        .scenario-title {
            font-family: var(--header-font); color: var(--primary-color);
            font-size: 2.2rem; text-align: center; padding: 1rem;
            width: 100%; margin-bottom: 0.5rem; flex-shrink: 0;
        }
        .scenario-content {
            flex: 1; padding: 1rem 2rem; overflow: auto; display: flex;
            justify-content: center; align-items: center; margin-top: 0;
        }
        .scenario-container {
            display: flex; gap: 2rem; align-items: center; width: 100%;
            max-width: 80rem; padding: 1rem; background: var(--card-background-light);
            border-radius: var(--border-radius); box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            opacity: 1; transition: opacity 0.3s ease-in-out; height: 55vh;
        }
        .scenario-container.fade-out { opacity: 0; }
        
        .scenario-details { flex: 1 1 50%; display: flex; flex-direction: column; align-items: center; gap: 1.5rem; }
        .scenario-story { font-size: 1.3rem; color: #444; line-height: 1.7; background: #f8f9fa; border-left: 0.25rem solid var(--primary-color); padding: 1.5rem; border-radius: 0.8rem; text-align: left; width: 100%; }
        
        .diagrams-container { display: flex; gap: 1.5rem; justify-content: center; align-items: center; width: 100%; height: 150px; }
        .scenario-icon {
            max-height: 100%;
            max-width: 150px;
            object-fit: contain;
        }
        
        .question-section {
            flex: 1 1 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            background-color: #f2f0f5;
            padding: 1.5rem;
            border-radius: var(--border-radius);
        }
        .question-section h3 { font-family: var(--header-font); color: var(--text-color-dark); font-size: 1.5rem; margin-bottom: 1.5rem; text-align: center; font-weight: 500;}
        
        .options-container { display: flex; flex-direction: column; gap: 1rem; width: 100%; max-width: 450px; }
        .option-button {
            background: var(--card-background-light); border: 2px solid #ddd; border-radius: 1rem; padding: 1.2rem; cursor: pointer;
            transition: all 0.3s ease; font-size: 1.2rem; color: var(--text-color-dark); font-weight: 700;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }
        .option-button:hover:not(:disabled) { transform: translateY(-3px); border-color: var(--primary-color); box-shadow: 0 6px 15px rgba(0,0,0,0.1); }
        .option-button.correct { background: var(--correct-color); color: white; border-color: #fff; transform: scale(1.02); }
        .option-button.incorrect { background: var(--incorrect-color); color: white; animation: shake 0.5s; }
        .option-button:disabled { cursor: not-allowed; opacity: 0.7; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 20%, 60% { transform: translateX(-8px); } 40%, 80% { transform: translateX(8px); } }

        /* ===== Glowing Pulsating Effect Keyframes ====== */
        @keyframes glow-pulse { 0%, 100% { box-shadow: 0 0 10px rgba(251,176,59,0.5), 0 0 20px rgba(251,176,59,0.3); transform: scale(1); } 50% { box-shadow: 0 0 20px rgba(251,176,59,0.8), 0 0 30px rgba(251,176,59,0.5); transform: scale(1.1); } }
        @keyframes glow-pulse-white { 0%, 100% { box-shadow: 0 0 10px rgba(255,255,255,0.7), 0 0 20px rgba(255,255,255,0.5); transform: scale(1); } 50% { box-shadow: 0 0 20px rgba(255,255,255,1), 0 0 30px rgba(255,255,255,0.7); transform: scale(1.1); } }

        /* ===== RESPONSIVE DESIGN ===== */
        @media (max-width: 1199px) { #game-wrapper { width: 100vw; height: 100vh; border-radius: 0; aspect-ratio: unset; } html { font-size: 2.5vmin; } }
        @media (max-width: 991px) {
            html{ font-size: 3vmin; }
            .scenario-container {  flex-direction: column; height: auto; max-height: 80%; overflow-y: auto; padding: 1.5rem; }
            .scenario-details, .question-section { flex-basis: auto; }
            .question-section { margin-top: 1rem; }
            .completion-buttons { flex-direction: column; align-items: center; }
            .completion-title-banner{
                top:1%;
            }
            .completion-image {
                width: 57%;
            }
        }
        @media (max-width: 768px) {
            html { font-size: 3.3vmin; }
            .scenario-title { font-size: 1.8rem; }
            .scenario-content { padding: 1rem; }
            .completion-title-banner { font-size: 1.8rem; }
            #completion-image { max-width: 66%; }
            .completion-btn { min-width: 180px; }
        }
    </style>
</head>
<body>

<div id="game-wrapper">
    <div id="game-container">
        <div id="start-screen" class="screen">
            <h1>Choose the Best Metal or Alloy</h1>
            <button class="start-button" onclick="showActivityIntro();">Start Activity</button>
        </div>

        <div id="game-screen" class="screen hidden">
            <div class="game-top-section">
                <h1 id="game-title">Engineering Scenarios</h1>
                <div class="top-right-controls">
                    <div id="progress-container">
                        <div id="progress-bar"></div>
                    </div>
                    <span id="progress-text">0 / 5</span>
                    <div class="instructions-icon" onclick="showInstructions()">
                        <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-.9.92C13.45 12.9 13 13.5 13 15h-2v-.5c0-1.1.45-2.1 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41 0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25z"/></svg>
                    </div>
                </div>
            </div>

            <h2 class="scenario-title" id="scenario-title"></h2>
            
            <div class="scenario-content">
                <div class="scenario-container" id="scenario-container">
                    <div class="scenario-details">
                        <p class="scenario-story" id="scenario-story-text"></p>
                        <div class="diagrams-container" id="diagrams-container"></div>
                    </div>
                    <div class="question-section">
                        <h3 id="question-text"></h3>
                        <div class="options-container" id="options-container"></div>
                    </div>
                </div>
            </div>
            
            <div class="hint-icon" id="hint-icon" onclick="showHint()">
                <svg viewBox="0 0 24 24"><path d="M9 21c0 .5.4 1 1 1h4c.6 0 1-.5 1-1v-1H9v1zm3-19C8.1 2 5 5.1 5 9c0 2.4 1.2 4.5 3 5.7V17c0 .5.4 1 1 1h6c.6 0 1-.5 1-1v-2.3c1.8-1.3 3-3.4 3-5.7 0-3.9-3.1-7-7-7z"></path></svg>
            </div>
        </div>

        <div id="completion-overlay" class="overlay hidden">
            <h2 class="completion-title-banner">Activity Wrap Up!</h2>
            <img id="completion-image" src="images/complete.jpg" alt="Activity Complete Summary">
            <div class="completion-buttons">
                <button class="completion-btn btn-prev" onclick="goToPreviousActivity()">Previous Activity</button>
                <button class="completion-btn btn-restart" onclick="restartGame()">Restart Activity</button>
                <button class="completion-btn btn-next" onclick="goToNextActivity()">Next Activity</button>
            </div>
        </div>

        <div id="activity-intro-overlay" class="overlay hidden">
            <div class="modal">
                <h2>Activity Introduction</h2>
                <p id="intro-text"></p>
                <button onclick="closeModal('activity-intro-overlay')">Continue</button>
            </div>
        </div>

        <div id="instructions-overlay" class="overlay hidden">
            <div class="modal">
                <h2>Instructions</h2>
                <ol id="instructions-list"></ol>
                <button onclick="closeModal('instructions-overlay')">Got it!</button>
            </div>
        </div>
        
        <div id="hint-overlay" class="overlay hidden">
            <div class="modal">
                <h2>Here's a hint...</h2>
                <ul id="hint-list"></ul>
                <button onclick="closeModal('hint-overlay')">Got it!</button>
            </div>
        </div>
        
        <div id="feedback-correct-overlay" class="overlay hidden">
            <div class="modal feedback-modal">
                <div class="feedback-header correct"><h2>Correct!</h2></div>
                <p id="correct-feedback-text"></p>
                <button class="feedback-btn correct" onclick="closeModal('feedback-correct-overlay')">Continue</button>
            </div>
        </div>
        
        <div id="feedback-incorrect-overlay" class="overlay hidden">
            <div class="modal feedback-modal">
                <div class="feedback-header incorrect"><h2>Not Quite...</h2></div>
                <p id="incorrect-feedback-text"></p>
                <button class="feedback-btn incorrect" onclick="handleTryAgain()">Try Again</button>
            </div>
        </div>
    </div>
</div>

<script>
    const activityData = {
        introduction: "Metals and alloys help us build safe bridges, design aircrafts, and wire homes. In this challenge, step into the shoes of an engineer or designer. Read each real-world task, choose the best metal or alloy, and explain your decision using the properties you know!",
        instructions: [
            "Read the real-world engineering scenario carefully.",
            "Click the metal or alloy you think is most suitable for the task.",
            "Read the feedback to understand why your choice is correct or incorrect.",
            "Use the “Hint” if you need extra guidance before answering."
        ],
        hints: [
            "Think about the property needed: strength, lightness, corrosion resistance, conductivity, or appearance.",
            "Match these to the metals or alloys you know."
        ],
        conclusion: "Fantastic reasoning! You applied knowledge of properties like strength, conductivity, and corrosion resistance to make the right material choices for real-world needs. Well done!",
        scenarios: [
            {
                title: "Scenario 1: Build a lightweight bicycle frame",
                story: "You are designing a bicycle frame. It must be strong but very light.",
                icon: "images/bicycle.svg",
                question: "Which material is best for the task?",
                options: [
                    { text: "Iron", feedback: "Iron is strong but too heavy for bikes. Look for something lighter." },
                    { text: "Gold", feedback: "Gold is heavy and soft—unsuitable for building frames." },
                    { text: "Aluminium", feedback: "Correct! Aluminium is lightweight and resistant to corrosion—great for bicycle frames." },
                    { text: "Duralumin", feedback: "Correct! Duralumin is a strong, lightweight alloy—perfect for high-performance bike frames." }
                ],
                correctIndices: [2, 3]
            },
            {
                title: "Scenario 2: Design a corrosion-resistant kitchen sink",
                story: "You are choosing a metal for a kitchen sink that will not rust or corrode.",
                icon: "images/sink.svg",
                question: "Which material is best for the task?",
                options: [
                    { text: "Steel", feedback: "Steel rusts when exposed to water. Think about what prevents rust." },
                    { text: "Copper", feedback: "Copper is shiny but corrodes over time and stains easily." },
                    { text: "Stainless Steel", feedback: "Correct! Stainless steel resists rust and keeps its shine—ideal for kitchens." },
                    { text: "Bronze", feedback: "Bronze is durable but less common in wet kitchen environments." }
                ],
                correctIndices: [2]
            },
            {
                title: "Scenario 3: Make a flexible, conductive wire",
                story: "You need a material that conducts electricity well and can bend easily.",
                icon: "images/wire.svg",
                question: "Which material is best for the task?",
                options: [
                    { text: "Brass", feedback: "Brass is used in instruments, not wires. Look for better conductivity." },
                    { text: "Iron", feedback: "Iron conducts poorly and is too rigid for wire." },
                    { text: "Copper", feedback: "Correct! Copper is highly conductive and flexible—perfect for wiring." },
                    { text: "Aluminium", feedback: "Correct! Aluminium is a good conductor and light—also used in power cables." }
                ],
                correctIndices: [2, 3]
            },
            {
                title: "Scenario 4: Construct a strong, durable bridge",
                story: "You are selecting the main structural metal for a large bridge.",
                icon: "images/bridge.svg",
                question: "Which material is best for the task?",
                options: [
                    { text: "Gold", feedback: "Gold is too soft and expensive for structural work." },
                    { text: "Steel", feedback: "Correct! Steel is strong, durable, and ideal for load-bearing structures like bridges." },
                    { text: "Aluminium", feedback: "Aluminium is light but lacks the strength for long-span bridges." },
                    { text: "Bronze", feedback: "Bronze is tough but not commonly used in large structural designs." }
                ],
                correctIndices: [1]
            },
            {
                title: "Scenario 5: Craft a medal for a sports competition",
                story: "The sports committee wants a decorative and durable metal for medals.",
                icon: "images/medal.svg",
                question: "Which material is best for the task?",
                options: [
                    { text: "Aluminium", feedback: "Aluminium is light but not traditionally used for awards." },
                    { text: "Brass", feedback: "Correct! Brass has a golden appearance and is easy to mould into decorative medals." },
                    { text: "Stainless Steel", feedback: "Stainless steel is rust-resistant but lacks the classic look of medals." },
                    { text: "Bronze", feedback: "Correct! Bronze is traditional for medals—it is hard and aesthetically appealing." }
                ],
                correctIndices: [1, 3]
            }
        ]
    };

    let currentScenarioIndex = 0;
    const totalScenarios = activityData.scenarios.length;
    let selectedOptionIndex = null;
    let introAudio, dingAudio, buzzAudio, outroAudio;

    function initAudio() {
        try {
            introAudio = new Audio('audio/intro.mp3');
            dingAudio = new Audio('audio/ding.mp3');
            buzzAudio = new Audio('audio/buzz.mp3');
            outroAudio = new Audio('audio/outro.mp3');
        } catch (e) {
            console.warn("Audio could not be loaded.");
            const mockAudio = { play: () => {}, pause: () => {}, currentTime: 0 };
            introAudio = dingAudio = buzzAudio = outroAudio = mockAudio;
        }
    }

    function playSound(audio) { if(audio) { audio.currentTime = 0; audio.play().catch(e => {}); } }
    function stopSound(audio) { if(audio) { audio.pause(); } }

    function initGame() {
        loadScenario();
    }
    
    function loadScenario() {
        selectedOptionIndex = null;
        const scenario = activityData.scenarios[currentScenarioIndex];
        
        document.getElementById('scenario-title').textContent = scenario.title;
        document.getElementById('scenario-story-text').innerHTML = scenario.story;
        document.getElementById('question-text').textContent = scenario.question;
        
        const diagramsContainer = document.getElementById('diagrams-container');
        diagramsContainer.innerHTML = ''; // Clear previous icon
        if (scenario.icon) {
            const icon = document.createElement('img');
            icon.src = scenario.icon;
            icon.alt = scenario.title;
            icon.className = 'scenario-icon';
            diagramsContainer.appendChild(icon);
        }

        const optionsContainer = document.getElementById('options-container');
        optionsContainer.innerHTML = '';
        scenario.options.forEach((option, index) => {
            const button = document.createElement('button');
            button.className = 'option-button';
            button.innerHTML = option.text;
            button.onclick = () => selectOption(index);
            optionsContainer.appendChild(button);
        });
        
        updateProgress();
    }

    function selectOption(index) {
        if (selectedOptionIndex !== null) return;
        selectedOptionIndex = index;
        const scenario = activityData.scenarios[currentScenarioIndex];
        const buttons = document.getElementById('options-container').querySelectorAll('.option-button');
        
        buttons.forEach(btn => btn.disabled = true);
        const chosenFeedback = scenario.options[index].feedback;

        if (scenario.correctIndices.includes(index)) {
            buttons[index].classList.add('correct');
            playSound(dingAudio);
             setTimeout(() => {
                showFeedbackPopup('correct', chosenFeedback);
            }, 500);
        } else {
            buttons[index].classList.add('incorrect');
            playSound(buzzAudio);
            setTimeout(() => {
                showFeedbackPopup('incorrect', chosenFeedback);
            }, 500);
        }
    }

    function handleTryAgain() {
        document.getElementById('feedback-incorrect-overlay').classList.add('hidden');
        const buttons = document.getElementById('options-container').querySelectorAll('.option-button');
        buttons.forEach(btn => {
            btn.disabled = false;
            btn.classList.remove('incorrect');
        });
        selectedOptionIndex = null;
    }

    function goToNextScenario() {
        const container = document.getElementById('scenario-container');
        container.classList.add('fade-out');
        setTimeout(() => {
            if (currentScenarioIndex < totalScenarios - 1) {
                currentScenarioIndex++;
                loadScenario();
                container.classList.remove('fade-out');
            } else {
                endActivity();
            }
        }, 300);
    }
    
    function updateProgress() {
        const progress = currentScenarioIndex;
        document.getElementById('progress-bar').style.width = `${(progress / totalScenarios) * 100}%`;
        document.getElementById('progress-text').textContent = `${progress} / ${totalScenarios}`;
    }

    function showFeedbackPopup(type, message) {
        document.getElementById(`${type}-feedback-text`).innerHTML = message;
        document.getElementById(`feedback-${type}-overlay`).classList.remove('hidden');
    }
    
    function showActivityIntro() {
        document.getElementById('start-screen').classList.add('hidden');
        document.getElementById('game-screen').classList.remove('hidden');
        document.getElementById('activity-intro-overlay').classList.remove('hidden');
        playSound(introAudio);
        sendEvent(ActivityEvent.START_ACTIVITY, {activityName: 'Choose the Best Metal or Alloy'});
    }

    function showInstructions() { document.getElementById('instructions-overlay').classList.remove('hidden'); }
    
    function showHint() { 
        document.getElementById('hint-overlay').classList.remove('hidden');
    }

    function closeModal(id) {
        document.getElementById(id).classList.add('hidden');
        if (id === 'activity-intro-overlay') { 
            stopSound(introAudio); 
            initGame(); 
        }
        if (id === 'feedback-correct-overlay') { 
             goToNextScenario();
        }
    }
    
    function endActivity() {
        document.getElementById('progress-bar').style.width = `100%`;
        document.getElementById('progress-text').textContent = `${totalScenarios} / ${totalScenarios}`;
        document.getElementById('game-screen').classList.add('hidden');
        document.getElementById('completion-overlay').classList.remove('hidden');
        playSound(outroAudio);
        sendEvent(ActivityEvent.END_ACTIVITY, {activityName: 'Choose the Best Metal or Alloy'});
    }
    
    function restartGame() {
        stopSound(outroAudio);
        document.getElementById('completion-overlay').classList.add('hidden');
        currentScenarioIndex = 0;
        document.getElementById('game-screen').classList.remove('hidden');
        document.getElementById('scenario-container').classList.remove('fade-out');
        loadScenario();
    }

    function goToPreviousActivity() { 
        // This function would navigate to the previous activity.
        // For demonstration, it might alert or log. Replace with actual navigation.
        stopSound(outroAudio);
        window.location.href = "../ACTIVITY1/index.html"; // Example link
    }
    
    function goToNextActivity() {
        // This function would navigate to the next activity.
        // For demonstration, it might alert or log. Replace with actual navigation.
        stopSound(outroAudio);
        window.location.href = "../ACTIVITY3/index.html"; // Example link
    }
    
    function populateStaticContent() {
        document.getElementById('intro-text').innerHTML = activityData.introduction;
        
        const instructionsList = document.getElementById('instructions-list');
        instructionsList.innerHTML = activityData.instructions.map(item => `<li>${item}</li>`).join('');

        const hintList = document.getElementById('hint-list');
        hintList.innerHTML = activityData.hints.map(item => `<li>${item}</li>`).join('');

        document.getElementById('progress-text').textContent = `0 / ${totalScenarios}`;
    }

    window.onload = () => { initAudio(); populateStaticContent(); };
</script>
<script src = "../eventSender.js"></script>
</body>
</html>