<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Think & Match ‚Äì ‚ÄúName That Particle!‚Äù</title>
<style>
    /* ====== KEYFRAME ANIMATIONS ====== */
    @keyframes glow-pulse {
        0%, 100% {
            box-shadow: 0 0 10px rgba(251, 176, 59, 0.5), 0 0 20px rgba(251, 176, 59, 0.3);
            transform: scale(1);
        }
        50% {
            box-shadow: 0 0 20px rgba(251, 176, 59, 0.8), 0 0 30px rgba(251, 176, 59, 0.5);
            transform: scale(1.05);
        }
    }
    @keyframes glow-pulse-white {
        0%, 100% {
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.7), 0 0 20px rgba(255, 255, 255, 0.5);
            transform: scale(1);
        }
        50% {
            box-shadow: 0 0 20px rgba(255, 255, 255, 1), 0 0 30px rgba(255, 255, 255, 0.7);
            transform: scale(1.05);
        }
    }
    @keyframes electron-orbit {
        0% { transform: rotate(0deg) translateX(5px) rotate(0deg); }
        100% { transform: rotate(360deg) translateX(5px) rotate(-360deg); }
    }
    @keyframes popIn {
        from { transform: scale(0.7); opacity: 0; }
        to { transform: scale(1); opacity: 1; }
    }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes slideIn { from { transform: translateY(30px) scale(0.95); opacity: 0; } to { transform: translateY(0) scale(1); opacity: 1; } }


    /* ====== FONT IMPORTS ====== */
    @font-face {
      font-family: 'Chevin Pro Medium';
      src: url('../assets/Chevin_Pro.otf') format('opentype');
    }
    ::-webkit-scrollbar{ display: none; }

    /* ====== ROOT VARIABLES & SCALING ====== */
    :root {
      --primary-color: #5D04B2;
      --secondary-color: #FBB03B;
      --correct-color: #4caf50;
      --incorrect-color: #E74C3C;
      --text-color-dark: #34495E;
      --text-color-light: #fff;
      --border-radius: 1rem;
      --header-font: 'Chevin Pro Medium', 'Poppins', sans-serif;
      --body-font: var(--header-font);
      --game-bg: #ECF0F1;
      --zone-bg: #ffffff;
      --zone-border: #DADEE2;

      /* Particle Colors */
      --proton-color: #E74C3C;
      --neutron-color: #bdc3c7;
      --electron-color: #3498DB;
    }
    
    html { font-size: 1.8vmin; }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      user-select: none;
    }
    
    body {
        width: 100%;
        height: 100vh;
        overflow: hidden; 
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: #d4d8da;
        font-family: var(--body-font);
    }

    #game-wrapper {
        width: 100%;
        max-width: 1200px;
        height: auto;
        aspect-ratio: 16 / 9;
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
        overflow: hidden;
        position: relative;
        display: flex;
        flex-direction: column;
        background: #fff;
    }
    
    #game-container {
        width: 100%;
        height: 100%;
        position: relative;
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }
    
    .touch-clone {
        position: fixed;
        opacity: 0.9;
        pointer-events: none;
        z-index: 9999;
        transform-origin: center center;
        transition: transform 0.1s;
        box-shadow: 0 8px 25px rgba(0,0,0,0.2);
    }

    .screen {
        width: 100%;
        height: 100%;
        position: absolute;
        top: 0;
        left: 0;
        display: flex;
        flex-direction: column;
        transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
        overflow: hidden;
    }

    .screen.hidden {
        opacity: 0;
        pointer-events: none;
        transform: scale(0.95);
    }

    /* ===== START SCREEN ===== */
    #start-screen {
      color: var(--text-color-light);
      text-align: center;
      padding: 2rem;
      background-image: url('images/gamebg.jpg');
      background-size: cover;
      background-position: center;
      justify-content: center;
      align-items: center;
    }
    
    #start-screen h1 {
      color: var(--text-color-light);
      font-size: 3.2rem;
      font-family: var(--header-font);
    }
    
    .start-button {
      background: var(--secondary-color);
      color: #fff;
      font-weight: 900;
      font-size: 1.1rem;
      border: 3px solid #fff;
      border-radius: 3rem;
      padding: 0.75rem 2.25rem;
      margin-top: 1rem;
      cursor: pointer;
      letter-spacing: 0.02em;
      text-shadow: 0 2px 0 #b88b2a;
      transition: all 0.2s;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }
    
    .start-button:hover {
      transform: scale(1.06);
      box-shadow: 0 6px 24px rgba(0, 0, 0, 0.18);
    }
    
    /* ===== GAME SCREEN BASE ===== */
    #game-screen {
      justify-content: flex-start;
      overflow: hidden;
      position: relative;
      background: var(--game-bg);
    }
    
    .game-top-section {
      width: 100%;
      background-color: var(--primary-color);
      padding: clamp(0.5rem, 1.5vmin, 0.75rem) clamp(0.75rem, 2vmin, 1.25rem);
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: #fff;
      position: relative;
      z-index: 10;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
      flex-shrink: 0;
    }
    
    #game-title {
      font-weight: 800;
      margin: 0;
      font-family: var(--header-font);
      font-size: clamp(1rem, 2.5vmin, 1.4rem);
    }
    
    .top-right-controls { display: flex; align-items: center; gap: 1rem; }
    
    #progress-container {
      width: clamp(100px, 20vw, 200px);
      background-color: rgba(255, 255, 255, 0.3);
      border-radius: 1rem;
      height: clamp(15px, 2.5vmin, 20px);
      border: 2px solid #fff;
      position: relative;
      overflow: hidden;
    }
    
    #progress-bar {
      height: 100%;
      width: 0%;
      background: #FFFF00;
      border-radius: 0.8rem;
      transition: width 0.5s ease;
    }
    
    #progress-text { font-weight: 700; color: #fff; text-shadow: none; }
    
    .instructions-icon {
      width: 2.5rem; height: 2.5rem; background: rgba(255, 255, 255, 0.2);
      border: 2px solid rgba(255, 255, 255, 0.3); border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; transition: all 0.3s ease; z-index: 15;
      flex-shrink: 0; animation: glow-pulse-white 2s infinite;
    }
    
    .instructions-icon:hover { background: rgba(255, 255, 255, 0.3); transform: scale(1.1); }
    .instructions-icon svg { width: 1.25rem; height: 1.25rem; fill: white; }

    /* ====== Game Content Layout ====== */
    .game-content {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        padding: clamp(1rem, 2vmin, 1.5rem);
        gap: clamp(1rem, 2vmin, 1.5rem);
    }
    
    #drop-zones-wrapper {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        gap: clamp(1rem, 2vmin, 1.5rem);
        height: 70%;
    }

    .drop-zone-row {
        display: flex;
        justify-content: center;
        gap: clamp(1rem, 2vmin, 1.5rem);
        flex-grow: 1;
    }
    
    #drag-items-container {
        flex-shrink: 0;
        background: #dcdde1;
        box-shadow: inset 0 5px 15px -5px rgba(0,0,0,0.15);
        padding: clamp(1rem, 2vmin, 1.5rem);
        display: flex;
        gap: clamp(0.8rem, 1.5vmin, 1.2rem);
        justify-content: center;
        align-items: center;
        height: 30%;
        border-radius: var(--border-radius);
    }

    /* ====== Drag & Drop Items Styling ====== */
    .drag-item {
        background: linear-gradient(135deg, #ffffff 0%, #f8f9ff 100%);
        border-radius: var(--border-radius);
        padding: clamp(0.5rem, 1vmin, 0.8rem);
        color: var(--text-color-dark);
        cursor: grab;
        box-shadow: 0 8px 25px rgba(89, 55, 155, 0.15);
        transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        width: clamp(150px, 20vmin, 200px);
        min-height: clamp(70px, 10vmin, 90px);
        border-width: 3px;
        border-style: solid;
    }

    .drag-item[data-particle="proton"] { border-color: var(--proton-color); }
    .drag-item[data-particle="neutron"] { border-color: var(--neutron-color); }
    .drag-item[data-particle="electron"] { border-color: var(--electron-color); }

    .particle-image {
        height: clamp(2.5rem, 5vmin, 3.5rem);
        width: auto;
        object-fit: contain;
    }
    .drag-item[data-particle="electron"] .particle-image { animation: electron-orbit 4s linear infinite; }
    
    .drag-item:hover {
        transform: translateY(-4px) scale(1.02);
        box-shadow: 0 12px 35px rgba(89, 55, 155, 0.25);
    }

    .drag-item:active { transform: scale(1.02) translateY(0px); cursor: grabbing; }
    .drag-item.dragging { opacity: 0.6; cursor: grabbing; transform: scale(0.95); }
    .drag-item.placed { display: none; }

    .item-text {
        font-size: clamp(1.2rem, 2.2vmin, 1.5rem);
        font-weight: 700;
        line-height: 1.3;
    }
        
    /* Drop Zone Styling */
    .drop-zone {
        background: var(--zone-bg);
        border: 2px dashed var(--zone-border);
        border-radius: var(--border-radius);
        position: relative;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        transition: all 0.2s ease;
        box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        overflow: hidden;
        flex-grow: 1;
        width: 100%;
    }
    
    .drop-zone-header {
        width: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.75rem;
        padding: clamp(0.75rem, 1.8vmin, 1rem);
        font-size: clamp(1.1rem, 2.5vmin, 1.4rem);
        font-weight: 700;
        color: white;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
        flex-shrink: 0;
        background-color: var(--text-color-dark);
    }
    
    .items-landed-container {
        width: 100%;
        flex-grow: 1;
        padding: clamp(0.5rem, 1.5vmin, 1rem);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        gap: clamp(0.4rem, 1vmin, 0.6rem);
        overflow-y: auto;
    }
    
    .drop-zone.drag-over {
        border-style: solid;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 4px var(--primary-color), 0 8px 20px rgba(0,0,0,0.15);
        transform: scale(1.02);
    }
    
    .items-landed-container .drag-item {
        cursor: default; transform: none !important;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        width: clamp(120px, 80%, 160px);
        min-height: auto; animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        opacity: 1 !important; pointer-events: none; padding: 0.5rem;
    }
    
    .items-landed-container .drag-item:hover { box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    
    /* Hint Icon */
    .hint-icon {
        position: absolute; bottom: 1rem; right: 1rem;
        width: 50px; height: 50px; background: var(--secondary-color);
        border-radius: 50%; border: 2px solid white;
        display: flex; align-items: center; justify-content: center;
        cursor: pointer; transition: all 0.3s ease;
        z-index: 1001; box-shadow: 0 4px 15px rgba(251, 176, 59, 0.4);
        animation: glow-pulse 2s infinite;
    }
    .hint-icon:hover { transform: scale(1.1); box-shadow: 0 6px 25px rgba(251, 176, 59, 0.8); }
    .hint-icon svg { fill: white; width: 24px; height: 24px; }

    /* ===== MODALS & OVERLAYS ===== */
    .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.4); backdrop-filter: blur(5px); z-index: 3000; display: flex; justify-content: center; align-items: center; animation: fadeIn 0.3s ease; padding: 1rem; }
    .overlay.hidden { display: none; visibility: hidden; opacity: 0; }
    .modal { background: #fff; padding: 2.5rem; border-radius: 1rem; text-align: center; width: 90%; max-width: 600px; animation: slideIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); position: relative; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2); }
    .modal h2 { font-size: 2rem; font-weight: 800; margin-bottom: 1.5rem; font-family: var(--header-font); }
    .modal p, .modal li { font-size: 1.2rem; line-height: 1.6; color: var(--text-color-dark); }
    .modal ul { text-align: left; padding-left: 2rem; list-style-type: 'üß†'; padding-inline-start: 1.5rem; }
    .modal ul li::marker { padding-right: 0.5rem; }
    #activity-intro-overlay .modal { border-top: 8px solid var(--primary-color); }
    #activity-intro-overlay .modal h2 { color: var(--primary-color); }
    #activity-intro-overlay .modal p { text-align: center; background: #f8f9fa; padding: 1.5rem; border-radius: 0.75rem; border-left: 4px solid var(--primary-color);}
    #instructions-overlay .modal { border-top: 8px solid var(--primary-color); }
    #instructions-overlay .modal h2 { color: var(--primary-color); }
    #instructions-overlay ul li { margin-bottom: 0.75rem; }
    .feedback-modal { max-width: 480px; }
    .feedback-header { display: flex; align-items: center; justify-content: center; gap: 0.75rem; margin-bottom: 1rem; }
    .feedback-header h2 { font-size: 2rem; font-weight: 700; margin: 0; }
    .feedback-header.correct h2 { color: var(--correct-color); }
    .feedback-header.incorrect h2 { color: var(--incorrect-color); }
    .feedback-btn { width: 100%; }
    .feedback-btn.correct { background-color: var(--correct-color); }
    .feedback-btn.incorrect { background-color: var(--incorrect-color); }
    #feedback-modal-overlay.correct-feedback .modal { border-top: 8px solid var(--correct-color); }
    #feedback-modal-overlay.incorrect-feedback .modal { border-top: 8px solid var(--incorrect-color); }
    .modal button { width: 100%; padding: 1rem; font-size: 1.2rem; font-weight: 700; border: none; border-radius: 0.75rem; cursor: pointer; color: #fff; transition: transform 0.2s, box-shadow 0.2s; margin-top: 1rem; }
    .modal button:hover { transform: scale(1.02); }
    #activity-intro-overlay button, #instructions-overlay button { background-color: var(--primary-color); }
    #hint-overlay .modal { border-top: 8px solid var(--secondary-color); }
    #hint-overlay h2 { color: var(--secondary-color); }
    #hint-overlay button { background-color: var(--secondary-color); }
    #hint-overlay ul { list-style-type: 'üí°'; }

    /* ===== COMPLETION OVERLAY ===== */
    #completion-overlay {
        background-image: url('images/gamebg.jpg');
        background-size: cover; background-position: center; color: #fff;
        display: flex; flex-direction: column; justify-content: center; align-items: center;
        gap: 1rem; padding: 1rem;
    }
    .completion-title-banner {
        font-size: clamp(2rem, 7vmin, 4rem);
        text-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.2);
        text-align: center; font-family: var(--header-font);
    }
    #completion-overlay .modal {
        background: transparent; box-shadow: none; width: auto; max-width: none;
        display: flex; justify-content: center; align-items: center; padding: 0; overflow: visible;
    }
    #completion-image {
        width: 100%;
        max-width: 700px;
        height: auto;
        border: 3px solid var(--secondary-color);
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        margin-top: 0.5rem;
        display: block;
        margin-left: auto;
        margin-right: auto;
    }
    .completion-buttons {
        position: static;
        width: 100%;
        display: flex;
        justify-content: space-between;
        gap: 1rem;
        padding: 0 2rem 2rem 2rem;
        box-sizing: border-box;
        align-items: flex-end;
        margin-top: 0;
    }
    .completion-btn {
         background: #FBB03B;
       color: #fff;
       font-weight: 700;
       font-size: 1.1rem;
       border: 0.1875rem solid #fff;
       border-radius: 3rem;
       padding: 0.75rem 2.25rem;
       margin-top: 1rem;
       cursor: pointer;
       letter-spacing: 0.02em;
       transition: all 0.2s;
       box-shadow: 0 0.25rem 0.5rem rgba(0,0,0,0.2);
    }
    .completion-btn:hover { 
        transform: scale(1.05); 
        box-shadow: 0 0.5rem 1.25rem rgba(0,0,0,0.2);
    }
    
    /* ===== RESPONSIVE DESIGN ===== */
    @media (max-width: 991px){
        #game-wrapper {
            width: 100vw; height: 100vh; min-width: 100vw; min-height: 100vh;
            border-radius: 0; max-width: none; aspect-ratio: unset;
        }
        html { font-size: 3.2vmin; }
        #drag-items-container { flex-wrap: nowrap; overflow-x: auto; justify-content: flex-start; }
        .drag-item { flex-shrink: 0; }
        #completion-image { max-width: 50vw; width: 100%; }
    }
    @media(max-width: 768px){
        .completion-buttons { gap: 0.75rem; position: static; padding: 1rem; }
    }
    @media (max-width: 480px) {
        html { font-size: 3.8vmin; }
        .game-top-section { padding: 0.5rem; }
        #game-title { font-size: 1rem; }
        .top-right-controls { gap: 0.5rem; }
        .drop-zone-row { flex-direction: column; }
    }
</style>
</head>
<body>
<div id="game-wrapper">
   <div id="game-container">
       <div id="start-screen" class="screen">
           <h1>Name That Particle!</h1>
           <button class="start-button">Start Activity</button>
       </div>

       <div id="game-screen" class="screen hidden">
           <div class="game-top-section">
               <h1 id="game-title">Think & Match - Name That Particle!</h1>
               <div class="top-right-controls">
                    <div id="progress-container">
                        <div id="progress-bar"></div>
                    </div>
                    <span id="progress-text">0 / 6</span>
                    <div class="instructions-icon" id="instructions-icon">
                        <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-.9.92C13.45 12.9 13 13.5 13 15h-2v-.5c0-1.1.45-2.1 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41 0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25z"/></svg>
                    </div>
                </div>
           </div>
           <div class="game-content">
                <div id="drop-zones-wrapper">
                    <!-- JS will generate rows and zones here -->
                </div>
                <div id="drag-items-container">
                    <!-- JS will generate draggables here -->
                </div>
           </div>
           <div class="hint-icon" id="hint-icon">
               <svg viewBox="0 0 24 24"><path d="M9 21c0 .5.4 1 1 1h4c.6 0 1-.5 1-1v-1H9v1zm3-19C8.1 2 5 5.1 5 9c0 2.4 1.2 4.5 3 5.7V17c0 .5.4 1 1 1h6c.6 0 1-.5 1-1v-2.3c1.8-1.3 3-3.4 3-5.7 0-3.9-3.1-7-7-7z"></path></svg>
           </div>
       </div>

        <div id="activity-intro-overlay" class="overlay hidden">
           <div class="modal">
                <h2>üß† Think & Match</h2>
                <p>Atoms are made of even smaller particles. Each has its own charge and place to stay. In this challenge, match each particle to its correct charge and location inside the atom. Think carefully and drag them to where they belong. Ready? Let us begin!</p>
                <button id="close-intro-btn">Continue</button>
           </div>
       </div>

        <div id="instructions-overlay" class="overlay hidden">
            <div class="modal">
                <h2>Learner Instructions</h2>
                <ul>
                    <li>Drag each particle to the correct <strong>Charge</strong> drop zone.</li>
                    <li>Then, drag the same particle to the correct <strong>Location</strong> drop zone.</li>
                    <li>You must match both properties correctly for each particle to complete the activity!</li>
                </ul>
                <button id="close-instructions-btn">Got it!</button>
            </div>
        </div>

        <div id="hint-overlay" class="overlay hidden">
            <div class="modal">
                <h2>Here's a Hint!</h2>
                <ul>
                  <li><strong>Protons</strong> are positive and in the nucleus.</li>
                  <li><strong>Neutrons</strong> are neutral and in the nucleus.</li>
                  <li><strong>Electrons</strong> are negative and in energy levels.</li>
                </ul>
                <button id="close-hint-btn">Got It</button>
            </div>
        </div>
       
        <div id="feedback-modal-overlay" class="overlay hidden">
            <div class="modal feedback-modal">
                <div class="feedback-header">
                    <h2 id="feedback-title"></h2>
                </div>
                <p id="feedback-modal-text"></p>
                <button id="next-question-button" class="feedback-btn">Continue</button>
            </div>
        </div>

        <div id="completion-overlay" class="overlay hidden">
            <h2 class="completion-title-banner">Activity Wrap Up!</h2>
            <div class="modal">
                <img id="completion-image" src="images/complete.jpg" alt="Completion celebration" onerror="this.src='https://placehold.co/600x400/5D04B2/ffffff?text=Well+Done!'; this.onerror=null;">
            </div>
            <div class="completion-buttons">
                <button class="completion-btn" id="restart-activity-btn">Restart Activity</button>
                <button class="completion-btn" id="next-activity-btn">Next Activity</button>
            </div>
       </div>
   </div>
</div>

<audio id="intro-audio" src="audio/intro.mp3" preload="auto"></audio>
<audio id="complete-audio" src="audio/outro.mp3" preload="auto"></audio>
<audio id="ding-sound" src="audio/ding.mp3" preload="auto"></audio>
<audio id="buzz-sound" src="audio/buzz.mp3" preload="auto"></audio>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- DOM Elements ---
    const startScreen = document.getElementById('start-screen');
    const gameScreen = document.getElementById('game-screen');
    const startBtn = document.querySelector('.start-button');
    const progressBar = document.getElementById('progress-bar');
    const progressText = document.getElementById('progress-text');
    const dragItemsContainer = document.getElementById('drag-items-container');
    const dropZonesWrapper = document.getElementById('drop-zones-wrapper');


    // --- Modal & Overlay Elements ---
    const activityIntroOverlay = document.getElementById('activity-intro-overlay');
    const instructionsOverlay = document.getElementById('instructions-overlay');
    const hintOverlay = document.getElementById('hint-overlay');
    const feedbackModalOverlay = document.getElementById('feedback-modal-overlay');
    const completionOverlay = document.getElementById('completion-overlay');

    // --- Button Elements ---
    const closeIntroBtn = document.getElementById('close-intro-btn');
    const instructionsIcon = document.getElementById('instructions-icon');
    const closeInstructionsBtn = document.getElementById('close-instructions-btn');
    const hintIcon = document.getElementById('hint-icon');
    const closeHintBtn = document.getElementById('close-hint-btn');
    const nextQuestionBtn = document.getElementById('next-question-button');
    const prevActivityBtn = document.getElementById('prev-activity-btn');
    const restartActivityBtn = document.getElementById('restart-activity-btn');
    const nextActivityBtn = document.getElementById('next-activity-btn');

    // --- Feedback Elements ---
    const feedbackHeader = feedbackModalOverlay.querySelector('.feedback-header');
    const feedbackTitle = document.getElementById('feedback-title');
    const feedbackText = document.getElementById('feedback-modal-text');

    // --- Audio Elements ---
    const introAudio = document.getElementById('intro-audio');
    const completeAudio = document.getElementById('complete-audio');
    const dingSound = document.getElementById('ding-sound');
    const buzzSound = document.getElementById('buzz-sound');

    // --- Game Data ---
    const particles = [
        { id: 'proton', text: 'Proton', charge: 'positive', location: 'nucleus', icon: 'images/proton.png' },
        { id: 'neutron', text: 'Neutron', charge: 'neutral', location: 'nucleus', icon: 'images/neutron.png' },
        { id: 'electron', text: 'Electron', charge: 'negative', location: 'energy-level', icon: 'images/electron.png' }
    ];

    const dropZoneData = {
        location: [
            { id: 'nucleus', text: 'üß† Nucleus' },
            { id: 'energy-level', text: 'üåÄ Energy Level' }
        ],
        charge: [
            { id: 'positive', text: '‚ûï Positive' },
            { id: 'negative', text: '‚ûñ Negative' },
            { id: 'neutral', text: '‚óº Neutral' }
        ]
    };
    
    const feedbackMessages = {
        proton: {
            positive: "Correct! Protons are always positively charged.",
            nucleus: "Excellent! Protons live inside the nucleus.",
            'energy-level': "Protons don't orbit the nucleus. Try again.",
            neutral: "Neutral is for neutrons. Protons are positive."
        },
        neutron: {
            neutral: "Correct! Neutrons have no charge.",
            nucleus: "Yes! Neutrons stay in the nucleus with protons.",
            negative: "Negative charge belongs to electrons, not neutrons.",
            'energy-level': "Neutrons are too heavy to orbit. Try again."
        },
        electron: {
            negative: "Correct! Electrons carry a negative charge.",
            'energy-level': "Well done! Electrons move in energy levels around the nucleus.",
            positive: "Positive charges are for protons, not electrons.",
            nucleus: "Electrons don't stay in the nucleus. Think again."
        }
    };


    // --- Game State ---
    let completedTasks = 0;
    const totalTasks = particles.length * 2;
    let draggedItem = null;
    let touchClone = null;
    let particleState = {};

    // --- Core Functions ---
    function initializeGame() {
        completedTasks = 0;
        particleState = {};
        particles.forEach(p => {
            particleState[p.id] = { charge: null, location: null };
        });
        updateProgressBar();
        loadGameElements();
    }

    function loadGameElements() {
        dragItemsContainer.innerHTML = '';
        dropZonesWrapper.innerHTML = '';
        
        particles.forEach(p => {
            const dragItem = document.createElement('div');
            dragItem.className = 'drag-item';
            dragItem.draggable = true;
            dragItem.dataset.particle = p.id;
            dragItem.innerHTML = `
                <img src="${p.icon}" class="particle-image" alt="${p.text}" onerror="this.src='https://placehold.co/100x100/ffffff/34495E?text=${p.text.charAt(0)}'"/>
                <span class="item-text">${p.text}</span>
            `;
            addDragListeners(dragItem);
            dragItemsContainer.appendChild(dragItem);
        });

        const locationRow = document.createElement('div');
        locationRow.className = 'drop-zone-row';
        dropZoneData.location.forEach(z => {
            const dropZone = createDropZone(z.id, 'location', z.text);
            locationRow.appendChild(dropZone);
        });

        const chargeRow = document.createElement('div');
        chargeRow.className = 'drop-zone-row';
        dropZoneData.charge.forEach(z => {
            const dropZone = createDropZone(z.id, 'charge', z.text);
            chargeRow.appendChild(dropZone);
        });
        
        dropZonesWrapper.appendChild(locationRow);
        dropZonesWrapper.appendChild(chargeRow);
    }
    
    function createDropZone(id, type, text) {
        const zone = document.createElement('div');
        zone.className = 'drop-zone';
        zone.dataset.accepts = id;
        zone.dataset.type = type;
        zone.innerHTML = `
            <div class="drop-zone-header"><span>${text}</span></div>
            <div class="items-landed-container"></div>
        `;
        addDropListeners(zone);
        return zone;
    }


    function addDragListeners(item) {
        item.addEventListener('dragstart', (e) => {
            draggedItem = item;
            setTimeout(() => item.classList.add('dragging'), 0);
        });
        item.addEventListener('dragend', () => {
            item.classList.remove('dragging');
            draggedItem = null;
        });
        
        let offsetX, offsetY;
        item.addEventListener('touchstart', (e) => {
            if (e.cancelable) e.preventDefault();
            draggedItem = item;
            const touch = e.touches[0];
            const rect = item.getBoundingClientRect();
            offsetX = touch.clientX - rect.left;
            offsetY = touch.clientY - rect.top;
            touchClone = item.cloneNode(true);
            touchClone.classList.add('touch-clone');
            touchClone.style.width = `${rect.width}px`;
            touchClone.style.height = `${rect.height}px`;
            document.body.appendChild(touchClone);
            moveTouchClone(e);
            item.style.opacity = '0.5'; 
        }, { passive: false });

        const moveTouchClone = (e) => {
             if (!touchClone) return;
            const touch = e.touches[0];
            touchClone.style.left = `${touch.clientX - offsetX}px`;
            touchClone.style.top = `${touch.clientY - offsetY}px`;
            let elementUnderTouch = document.elementFromPoint(touch.clientX, touch.clientY);
            let dropZoneUnderTouch = elementUnderTouch ? elementUnderTouch.closest('.drop-zone') : null;
            document.querySelectorAll('.drop-zone').forEach(zone => {
                zone.classList.toggle('drag-over', zone === dropZoneUnderTouch);
            });
        }
        
        document.addEventListener('touchmove', (e) => {
            if (!touchClone || !draggedItem) return;
            if (e.cancelable) e.preventDefault();
            moveTouchClone(e);
        }, { passive: false });


        document.addEventListener('touchend', (e) => {
            if (!draggedItem) return;
            draggedItem.style.opacity = '1';
            const touch = e.changedTouches[0];
            let dropTarget = document.elementFromPoint(touch.clientX, touch.clientY);
            let dropZone = dropTarget ? dropTarget.closest('.drop-zone') : null;
            if (dropZone) handleDrop(dropZone);
            if (touchClone) touchClone.remove();
            touchClone = null;
            draggedItem = null;
            document.querySelectorAll('.drop-zone').forEach(zone => zone.classList.remove('drag-over'));
        });
    }

    function addDropListeners(zone) {
        zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('drag-over'); });
        zone.addEventListener('dragleave', () => zone.classList.remove('drag-over'));
        zone.addEventListener('drop', e => {
            e.preventDefault();
            zone.classList.remove('drag-over');
            handleDrop(zone);
        });
    }

    function handleDrop(zone) {
        if (!draggedItem) return;
        
        const particleId = draggedItem.dataset.particle;
        const particle = particles.find(p => p.id === particleId);
        const zoneType = zone.dataset.type;
        const zoneAccepts = zone.dataset.accepts;

        const isCorrect = particle[zoneType] === zoneAccepts;
        const feedback = feedbackMessages[particleId][zoneAccepts] || "That's not the right spot.";
        
        showFeedback(isCorrect, feedback);

        if (isCorrect) {
            if (!particleState[particleId][zoneType]) {
                particleState[particleId][zoneType] = zoneAccepts;
                completedTasks++;
                updateProgressBar();

                const droppedClone = draggedItem.cloneNode(true);
                droppedClone.classList.remove('dragging');
                droppedClone.draggable = false;
                zone.querySelector('.items-landed-container').appendChild(droppedClone);

                if (particleState[particleId].charge && particleState[particleId].location) {
                    draggedItem.classList.add('placed');
                }
            }
        }
        draggedItem = null;
    }

    function updateProgressBar() {
        const percentage = (completedTasks / totalTasks) * 100;
        progressBar.style.width = `${percentage}%`;
        progressText.textContent = `${completedTasks} / ${totalTasks}`;
    }

    function showFeedback(isCorrect, message) {
        feedbackTitle.textContent = isCorrect ? "Correct!" : "Not Quite...";
        feedbackText.textContent = message;
        feedbackHeader.className = isCorrect ? 'feedback-header correct' : 'feedback-header incorrect';
        nextQuestionBtn.className = isCorrect ? 'feedback-btn correct' : 'feedback-btn incorrect';
        feedbackModalOverlay.className = isCorrect ? 'overlay correct-feedback' : 'overlay incorrect-feedback';
        playSound(isCorrect ? dingSound : buzzSound);
        feedbackModalOverlay.classList.remove('hidden');
    }
    
    function checkGameCompletion() {
        if (completedTasks === totalTasks) {
            setTimeout(() => {
                gameScreen.classList.add('hidden');
                completionOverlay.classList.remove('hidden');
                playSound(completeAudio);
            }, 500);
        }
    }

    function playSound(sound) { if (sound) { sound.currentTime = 0; sound.play().catch(e => console.error('Audio play failed:', e)); } }
    
    function stopAllAudio() {
        [introAudio, completeAudio, dingSound, buzzSound].forEach(audio => { if (audio) { audio.pause(); audio.currentTime = 0; } });
    }

    // --- Event Listeners Setup ---
    startBtn.addEventListener('click', () => {
        startScreen.classList.add('hidden');
        gameScreen.classList.remove('hidden');
        activityIntroOverlay.classList.remove('hidden');
        playSound(introAudio);
        sendEvent(ActivityEvent.START_ACTIVITY, { activityName: 'Name the Particle' });
    });

    closeIntroBtn.addEventListener('click', () => {
        stopAllAudio();
        activityIntroOverlay.classList.add('hidden');
        initializeGame();
    });

    instructionsIcon.addEventListener('click', () => instructionsOverlay.classList.remove('hidden'));
    closeInstructionsBtn.addEventListener('click', () => instructionsOverlay.classList.add('hidden'));

    hintIcon.addEventListener('click', () => hintOverlay.classList.remove('hidden'));
    closeHintBtn.addEventListener('click', () => hintOverlay.classList.add('hidden'));

    nextQuestionBtn.addEventListener('click', () => {
        feedbackModalOverlay.classList.add('hidden');
        checkGameCompletion();
    });


    restartActivityBtn.addEventListener('click', () => {
        stopAllAudio();
        completionOverlay.classList.add('hidden');
        gameScreen.classList.remove('hidden');
        initializeGame();
    });

    nextActivityBtn.addEventListener('click', () => {
        stopAllAudio();
        window.location.href = "../ACTIVITY2/index.html";
        sendEvent(ActivityEvent.END_ACTIVITY, { activityName: 'Name the Particle' });
    });
});
</script>
<script src ="../eventSender.js"></script>
</body>
</html>

