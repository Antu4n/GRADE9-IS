<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Atom Detective | Spot the Difference</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* ====== FONT IMPORTS ====== */
        @font-face {
            font-family: 'Fredoka';
            src: url('../assets/Fredoka-VariableFont_wdth\,wght.ttf') format('truetype');
        }

        ::-webkit-scrollbar{
            display: none;
        }

        /* ====== ROOT VARIABLES & SCALING UNIT ====== */
        :root {
            --primary-color: #5D04B2;
            --secondary-color: #FBB03B;
            --correct-color: #5cb85c;
            --incorrect-color: #d9534f;
            --text-color-dark: #333;
            --text-color-light: #fff;
            --header-font: 'Fredoka', 'Poppins', sans-serif;
            --body-font: var(--header-font);
            --border-radius: 1.12rem;
            --pad-lg: 1.92rem;
            --font-lg: 1.92rem;
            --font-md: 1.28rem;
        }
        
        html {
             font-size: 1.8vmin;
        }

        /* ====== GLOBAL BASE ====== */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            display: flex; justify-content: center; align-items: center;
            min-height: 100vh; background: #f0f4f8;
            font-family: var(--body-font);
            overflow: hidden;
        }
        #game-wrapper {
            width: 100%; max-width: 1200px; aspect-ratio: 16 / 9;
            overflow: hidden;
            display: flex; flex-direction: column; 
            box-shadow: 0 15px 40px rgba(0,0,0,0.3);
            position: relative;
        }
        #game-container {
            width: 100%; height: 100%; background: #fff;
            position: relative; display: flex; flex-direction: column;
        }
        .screen {
            position: absolute; width: 100%; height: 100%; top: 0; left: 0;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: opacity 0.5s ease-in-out, visibility 0.5s;
            pointer-events: all; visibility: visible;
            background-image: url('images/gamebg.jpg'); background-size: cover; background-position: center;
        }
        .hidden { opacity: 0; pointer-events: none; visibility: hidden; }

        /* ===== START SCREEN ===== */
        #start-screen h1 {
            color: var(--text-color-light); font-size: 3.2rem;
            font-family: var(--header-font);
            font-weight: 600;
        }
        .start-button { 
            background: #FBB03B; color: #fff; font-weight: 900;
            font-size: 1.1rem; border: 3px solid #fff; border-radius: 3rem;
            padding: 0.75rem 2.25rem; margin-top: 1rem; cursor: pointer;
            letter-spacing: 0.02em; text-shadow: 0 2px 0 #b88b2a;
            transition: all 0.2s; box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .start-button:hover { transform: scale(1.06); box-shadow: 0 6px 24px rgba(0,0,0,0.18); }


        /* ===== GAME SCREEN STYLES ===== */
        #game-screen { 
            justify-content: flex-start; 
            overflow: hidden; 
            display: flex;
            flex-direction: column;
            background: #fff;
        }
        
        .game-top-section { 
            width: 100%; background-color: var(--primary-color); 
            padding: clamp(0.5rem, 1.5vmin, 0.75rem) clamp(0.75rem, 2vmin, 1.25rem);
            display: flex; justify-content: space-between; align-items: center;
            color: #fff; z-index: 10;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            flex-shrink: 0;
        }
        #game-title {
            font-weight: 600;
            margin: 0; font-family: var(--header-font);
        }
        .top-right-controls { display: flex; align-items: center; gap: 1rem; }
        
        #progress-container { 
            width: clamp(100px, 20vw, 200px); background-color: rgba(255,255,255,0.3);
            border-radius: 1rem; height: clamp(15px, 2.5vmin, 20px);
            border: 2px solid #fff; position: relative; overflow: hidden;
        }
        #progress-bar {
            height: 100%; width: 0%; background: #FFFF00;
            border-radius: 0.8rem; transition: width 0.5s ease;
        }
        #progress-text {
            font-weight: 700; color: #fff;
            text-shadow: none;
        }
        
        /* ====== HINT & HELP ICONS & ANIMATIONS ====== */
        @keyframes glow-pulse { 0%, 100% { box-shadow: 0 0 0.625rem rgba(251, 176, 59, 0.5), 0 0 1.25rem rgba(251, 176, 59, 0.3); transform: scale(1); } 50% { box-shadow: 0 0 1.25rem rgba(251, 176, 59, 0.8), 0 0 1.875rem rgba(251, 176, 59, 0.5); transform: scale(1.1); } }
        @keyframes glow-pulse-white { 0%, 100% { box-shadow: 0 0 0.625rem rgba(255, 255, 255, 0.7), 0 0 1.25rem rgba(255, 255, 255, 0.5); transform: scale(1); } 50% { box-shadow: 0 0 1.25rem rgba(255, 255, 255, 1), 0 0 1.875rem rgba(255, 255, 255, 0.7); transform: scale(1.1); } }
        
        #help-button {
            position: static; width: 2.5rem; height: 2.5rem;
            background: rgba(255, 255, 255, 0.2); border: 0.125rem solid rgba(255, 255, 255, 0.3);
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: all 0.3s ease; z-index: 15;
            animation: glow-pulse-white 2.5s infinite ease-in-out;
            padding: 0;
        }
        #help-button svg { fill: white; width: 1.25rem; height: 1.25rem; }
        #help-button:hover { animation: none; background: rgba(255, 255, 255, 0.3); transform: scale(1.1); }
        
        #hint-button {
            position: absolute; bottom: 1.6rem; right: 1.6rem;
            z-index: 20;
            width: 4rem; height: 4rem;
            background: var(--secondary-color);
            border: 0.24rem solid white;
            border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.3s ease;
            box-shadow: 0 0.32rem 1.2rem rgba(251, 176, 59, 0.4);
            animation: glow-pulse 2s infinite ease-in-out;
        }
        #hint-button.hidden { display: none; }
        #hint-button:hover { animation: none; transform: scale(1.1); box-shadow: 0 0.48rem 2rem rgba(251, 176, 59, 0.8); }
        #hint-button svg { width: 1.92rem; height: 1.92rem; fill: white; }

        /* ===== MODALS ===== */
        .modal-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.4); backdrop-filter: blur(0.4rem); z-index: 1000; display: flex; justify-content: center; align-items: center; animation: fadeIn 0.3s ease; }
        .modal-overlay.hidden { display: none; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .modal { background: #fff; padding: var(--pad-lg, 1.92rem); border-radius: var(--border-radius, 1.12rem); text-align: center; width: 90%; max-width: 48rem; border-top: 0.64rem solid var(--primary-color); animation: slideIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .modal-title { color: var(--primary-color); font-size: var(--font-lg, 1.92rem); margin-bottom: 1.92rem;font-weight: 600; }
        .modal-text { font-size: var(--font-md, 1.28rem); line-height: 1.6; color: var(--text-color-dark); margin-bottom: 2.56rem; text-align: left; }
        .modal-text p { margin-bottom: 1rem; }
        
        .modal-button { width: 100%; padding: 1.28rem; font-size: 1.44rem; font-weight: 700; border: none; border-radius: 0.96rem; cursor: pointer; color: #ffffff; transition: transform 0.2s, box-shadow 0.2s; }
        .modal-button:hover { transform: scale(1.03); }
        
        #narrationModal .modal-button, #helpModal .modal-button { background: var(--primary-color); }
        #hintModal .modal-button { background: var(--secondary-color); }

        @keyframes slideIn { from { transform: translateY(2.4rem) scale(0.95); opacity: 0; } to { transform: translateY(0) scale(1); opacity: 1; } }
        
        #hintModal .modal { border-top-color: var(--secondary-color); }
        #hintModal .modal-title { color: var(--secondary-color); }
        
        .feedback-modal { max-width: 36rem; }
        #feedback-correct-overlay .modal { border-top-color: var(--correct-color); }
        #feedback-incorrect-overlay .modal { border-top-color: var(--incorrect-color); }
        
        #feedback-correct-overlay .modal-title { color: var(--correct-color); }
        #feedback-incorrect-overlay .modal-title { color: var(--incorrect-color); }
        
        #feedback-correct-overlay .modal-button { background-color: var(--correct-color); }
        #feedback-incorrect-overlay .modal-button { background-color: var(--incorrect-color); }
        .narration-text { text-align: left; background: #f8f9fa; padding: 1.5rem; border-radius: 0.75rem; border-left: 0.25rem solid var(--primary-color); }

        /* ===== COMPLETION & TAKEAWAYS SCREENS ===== */
        #completion-screen {
            padding: 2rem;
            color: #fff;
        }
        #completion-screen h2 {
            font-size: clamp(2rem, 7vmin, 4rem);
            text-shadow: 0 4px 8px rgba(0,0,0,0.3);
            text-align: center;
            font-weight: 500;
        }
        #completion-screen img {
            width: clamp(400px, 65%, 700px);
            height: auto;
            border: 3px solid var(--secondary-color);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            margin: 2rem 0 0 0;
        }
        .end-buttons-bar {
            margin-top: auto;
            width: 100%;
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            align-items: center;
            gap: clamp(0.75rem, 2vmin, 1.25rem);
            padding-top: clamp(0.75rem, 2vmin, 1.25rem);
        }
        .completion-btn {
            font-family: var(--header-font);
            background: #FBB03B;
            color: #fff;
            font-weight: 900;
            border: 3px solid #fff;
            border-radius: 3rem;
            padding: clamp(0.5rem, 1.5vmin, 0.75rem) clamp(1.25rem, 3vmin, 2rem);
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            text-decoration: none;
        }
        .completion-btn:hover { transform: scale(1.06); }
        #previous-button { grid-column: 1; justify-self: start; }
        #play-again-button { grid-column: 2; justify-self: center; }
        #key-takeaways-button { grid-column: 3; justify-self: end; }

        #key-takeaways-overlay h2 { 
            font-family: var(--header-font); color: white; font-size: 2.5rem;
            text-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.3); margin-bottom: 1.5rem;
        }
        .takeaways-container {
            background-color: white; color: var(--text-color-dark);
            border-radius: 1rem; padding: 1.5rem 2rem; max-width: 45rem;
            width: 90%; border-top: 0.3rem solid var(--secondary-color);
            box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.1);
            max-height: 60vh; overflow-y: auto;
        }
        .takeaways-title { font-size: 2rem; color: var(--primary-color); margin-bottom: 1.2rem; font-weight: 700; }
        .takeaways-list { list-style-type: none; padding: 0; text-align: left; }
        .takeaways-list li { position: relative; padding-left: 2rem; margin-bottom: 0.8rem; font-size: 1rem; line-height: 1.5; }
        .takeaways-list li::before { content: "✓"; color: var(--correct-color); position: absolute; left: 0; top: 0; font-size: 1.2rem; font-weight: bold; }
        .primary-action-btn {
            background: var(--secondary-color); color: #fff; font-weight: 900; font-size: 1.25rem;
            border: 0.1875rem solid #fff; border-radius: 3rem; padding: 0.75rem 2.5rem;
            cursor: pointer; text-shadow: 0 0.125rem 0 #b88b2a; transition: all 0.2s;
            box-shadow: 0 0.25rem 0.5rem rgba(0, 0, 0, 0.2); text-decoration: none; margin-top: 1.5rem;
        }
        .primary-action-btn:hover { transform: scale(1.06); }

        /* ===== SCENARIO LAYOUT ===== */
        .scenario-content {
            flex: 1; padding: 1.5rem; overflow: hidden;
            display: flex; flex-direction: row; justify-content: center; align-items: center;
            gap: 2rem;
            opacity: 1; transition: opacity 0.3s ease-in-out;
        }
        .scenario-content.fade-out { opacity: 0; }

        .image-column {
            flex: 1.2; display: flex; flex-direction: column;
            justify-content: center; align-items: center; height: 100%;
        }
        .diagrams-container {
            display: flex; justify-content: center; align-items: center;
            gap: 2rem; width: 100%;
        }
        .diagram-wrapper { text-align: center; flex: 1; }
        .diagram-image {
            width: 100%; height: auto; max-height: 40vh;
            object-fit: contain; filter: drop-shadow(0 4px 15px rgba(0,0,0,0.15));
        }
        .diagram-label {
            font-size: 1.5rem; font-weight: 700; color: var(--primary-color);
            margin-top: 0.5rem;
        }
        
        .text-column {
            flex: 1; display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            gap: 1.5rem; height: 100%; overflow-y: auto;
        }
        .question-text {
            font-size: 1.6rem; color: #333; font-weight: 600;
            text-align: center; max-width: 95%;
        }
        .options-container { 
            display: grid; grid-template-columns: 1fr; 
            gap: 1rem; width: 100%; max-width: 450px;
        }
        .option-button {
            background: #f0f4f8; border: 3px solid #ddd;
            border-radius: 1rem; padding: 1rem; cursor: pointer;
            transition: all 0.3s ease; font-size: 1.2rem;
            color: var(--text-color-dark); font-weight: 600;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05); 
            text-align: left;
        }
        .option-button:hover:not(.selected) {
            border-color: var(--secondary-color);
            transform: translateY(-2px);
        }
        .option-button.correct {
            background: var(--correct-color); color: white; border-color: #fff;
        }
        .option-button.incorrect {
            background: var(--incorrect-color); color: white; animation: shake 0.5s;
        }
        .option-button:disabled { cursor: not-allowed; opacity: 0.8; }
        
        @keyframes shake { 0%, 100% { transform: translateX(0); } 20%, 60% { transform: translateX(-8px); } 40%, 80% { transform: translateX(8px); } }

        /* ===== RESPONSIVE DESIGN ===== */
        @media(min-width: 1200px){
            .question-text { font-size: 1.8rem; }
            .option-button { font-size: 1.3rem; }
        }
        @media (max-width: 1199px) {
            html { font-size: 2.2vmin; }
        }
        @media (max-width:1024px){
             #game-wrapper {
                width: 100vw; height: 100vh; min-width: 100vw; min-height: 100vh;
                border-radius: 0; max-width: none; aspect-ratio: unset;
            }
        }
        @media (max-width: 991px){
            html { font-size: 3vmin; }
            .question-text { font-size: 1.4rem; max-width: 95%;}
            .option-button { font-size: 1.2rem; }
            .scenario-content { padding: 1rem; }
            .image-column, .text-column { height: auto; width: 100%; }
            .diagrams-container { flex-direction: row; }
            .diagram-image { max-height: 52vh; }
        }
        @media (max-width: 768px) {
            html { font-size: 3.3vmin; }
            .scenario-content { padding: 1rem; }
            .diagrams-container { gap: 1rem; }
            .diagram-image { max-height: 44vh; }
            .question-text { font-size: 1.3rem; }
            .options-container { gap: 0.75rem; }
            .completion-title-banner { font-size: 1.8rem; }
            .completion-btn { min-width: 120px; }
        }
    </style>
</head>
<body>

<div id="game-wrapper">
    <div id="game-container">
        <div id="start-screen" class="screen">
            <h1>Atom Detective</h1>
            <button class="start-button">Start Activity</button>
        </div>

        <div id="game-screen" class="screen hidden">
            <div class="game-top-section">
                <h1 id="game-title">Atom Detective</h1>
                <div class="top-right-controls">
                    <div id="progress-container">
                        <div id="progress-bar"></div>
                    </div>
                    <span id="progress-text">0 / 4</span>
                    <button id="help-button" class="help-icon" title="Help">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-.9.92C13.45 12.9 13 13.5 13 15h-2v-.5c0-1.1.45-2.1 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41 0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25z"/></svg>
                    </button>
                </div>
            </div>
            
            <div class="scenario-content" id="scenario-content">
                <div class="image-column">
                    <div class="diagrams-container">
                        <div class="diagram-wrapper">
                            <img id="diagram-image-1" src="" alt="Atom Diagram 1" class="diagram-image">
                            <p id="diagram-label-1" class="diagram-label"></p>
                        </div>
                        <div class="diagram-wrapper">
                            <img id="diagram-image-2" src="" alt="Atom Diagram 2" class="diagram-image">
                            <p id="diagram-label-2" class="diagram-label"></p>
                        </div>
                    </div>
                </div>
                <div class="text-column">
                    <p class="question-text" id="question-text"></p>
                    <div class="options-container" id="options-container"></div>
                </div>
            </div>
             <button id="hint-button" class="hint-icon hidden" title="Get a Hint">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M9 21c0 .5.4 1 1 1h4c.6 0 1-.5 1-1v-1H9v1zm3-19C8.1 2 5 5.1 5 9c0 2.4 1.2 4.5 3 5.7V17c0 .5.4 1 1 1h6c.6 0 1-.5 1-1v-2.3c1.8-1.3 3-3.4 3-5.7 0-3.9-3.1-7-7-7z"/></svg>
            </button>
        </div>

        <div id="completion-screen" class="screen hidden">
            </div>
        
        <div id="key-takeaways-overlay" class="screen hidden">
             </div>

        <div id="narrationModal" class="modal-overlay hidden">
            <div class="modal">
                <h2 class="modal-title">Activity Introduction</h2>
                <p class="modal-text narration-text"></p>
                <button id="continueNarrationButton" class="modal-button">Continue</button>
            </div>
        </div>

        <div id="help-modal-overlay" class="modal-overlay hidden">
            <div id="helpModal" class="modal">
                <h2 id="help-title" class="modal-title">Learner Instructions</h2>
                <div id="help-modal-text" class="modal-text"></div>
                <button id="help-modal-btn" class="modal-button">Got It!</button>
            </div>
        </div>

        <div id="hint-modal-overlay" class="modal-overlay hidden">
            <div id="hint-modal" class="modal">
                <h2 id="hint-title" class="modal-title">Here's a Hint...</h2>
                <div id="hint-modal-text" class="modal-text"></div>
                <button id="hint-modal-btn" class="modal-button" style="color: var(--secondary-color);">Got it!</button>
            </div>
        </div>
        
        <div id="feedback-correct-overlay" class="modal-overlay hidden">
            <div class="modal feedback-modal">
                <h2 class="modal-title">Correct!</h2>
                <p id="correct-feedback-text" class="modal-text"></p>
                <button class="modal-button" onclick="closeModal('feedback-correct-overlay')">Continue</button>
            </div>
        </div>
        
        <div id="feedback-incorrect-overlay" class="modal-overlay hidden">
            <div class="modal feedback-modal">
                <h2 class="modal-title">Not Quite</h2>
                <p id="incorrect-feedback-text" class="modal-text"></p>
                <button class="modal-button" onclick="closeModal('feedback-incorrect-overlay')">Try Again</button>
            </div>
        </div>
    </div>
</div>

<script src = "../eventSender.js"></script>
<script>
    const activityData = {
        conclusionText: "Well done comparing valence electrons! The number in the outer shell tells us whether an atom will lose or gain electrons. This is key in predicting how it reacts with other elements.",
        keyTakeaways: [
            "Elements are classified by <b>electron arrangement</b> and <b>physical/chemical properties</b>.",
            "<b>Metals</b>: 1–3 valence electrons (e.g., Na = 2.8.1, Mg = 2.8.2).",
            "<b>Non-metals</b>: 5–8 valence electrons (e.g., O = 2.6, Cl = 2.8.7).",
            "<b>Metalloids</b>: 4 valence electrons, showing both metal and non-metal properties (e.g., Si, B).",
            "<b>Exceptions</b>: Hydrogen, Helium, Boron, and Silicon have special cases."
        ],
        scenarios: [
            {
                title: "Sodium vs. Magnesium",
                elements: ["Sodium", "Magnesium"],
                images: ["images/sodium.jpg", "images/magnesium.jpg"],
                question: "Which atom has more electrons in its outer shell?",
                options: [
                    { text: "Sodium", feedback: "Sodium’s last shell contains 1 electron, not more than magnesium. Check the outermost ring on both diagrams." },
                    { text: "Magnesium", feedback: "Correct! Magnesium has 2 electrons in the outermost shell. Sodium has only 1." },
                    { text: "Both have the same", feedback: "Sodium has 1, and magnesium has 2 in the outermost shell — they are not the same." }
                ],
                correctIndex: 1,
                hint: "Count the electrons in the very last, outermost ring for each atom."
            },
            {
                title: "Magnesium vs. Aluminium",
                elements: ["Magnesium", "Aluminium"],
                images: ["images/magnesium.jpg", "images/aluminium.jpg"],
                question: "Which element is more likely to lose 3 electrons during bonding?",
                options: [
                    { text: "Magnesium", feedback: "Magnesium has 2 outer electrons and typically loses only 2, not 3." },
                    { text: "Aluminium", feedback: "Correct! Aluminium has 3 outer electrons and tends to lose all three to become stable." },
                    { text: "Neither", feedback: "One of them — aluminium — is highly likely to lose 3 electrons. Look at the third shell." }
                ],
                correctIndex: 1,
                hint: "Which of the two atoms has exactly 3 electrons in its outermost shell?"
            },
            {
                title: "Fluorine vs. Neon",
                elements: ["Fluorine", "Neon"],
                images: ["images/fluorine.jpg", "images/neon.jpg"],
                question: "Which atom is more chemically reactive?",
                options: [
                    { text: "Fluorine", feedback: "Correct! Fluorine needs just 1 more electron to complete its shell, making it highly reactive." },
                    { text: "Neon", feedback: "Neon already has a full outer shell with 8 electrons. It is very stable and does not easily react." },
                    { text: "Both are equally reactive", feedback: "Only fluorine is reactive — neon is a noble gas, meaning it is stable and inert." }
                ],
                correctIndex: 0,
                hint: "An atom with a nearly full outer shell is very reactive because it wants to gain an electron."
            },
            {
                title: "Sodium vs. Chlorine",
                elements: ["Sodium", "Chlorine"],
                images: ["images/sodium.jpg", "images/chlorine.jpg"],
                question: "Which atom is more likely to lose an electron?",
                options: [
                    { text: "Sodium", feedback: "Correct! Sodium has 1 valence electron and easily loses it to become stable." },
                    { text: "Chlorine", feedback: "Chlorine tends to gain 1 electron to complete its shell — not lose its 7 outer electrons." },
                    { text: "Neither", feedback: "Sodium is very likely to lose its single outer electron. Review the electron arrangement." }
                ],
                correctIndex: 0,
                hint: "Atoms with only one or two electrons in their outer shell find it easier to lose them."
            }
        ]
    };

    let currentScenarioIndex = 0;
    const totalScenarios = activityData.scenarios.length;
    let answerChecked = false;

    let introAudio, dingAudio, buzzAudio, outroAudio;

    function initAudio() {
        try {
            introAudio = new Audio('audio/intro.mp3');
            dingAudio = new Audio('audio/ding.mp3');
            buzzAudio = new Audio('audio/buzz.mp3');
            outroAudio = new Audio('audio/outro.mp3');
        } catch (e) {
            console.warn("Audio could not be loaded.");
            const mockAudio = { play: () => {}, pause: () => {}, currentTime: 0 };
            introAudio = dingAudio = buzzAudio = outroAudio = mockAudio;
        }
    }

    function playSound(audio) { if(audio) { audio.currentTime = 0; audio.play().catch(e => {}); } }
    function stopSound(audio) { if(audio) { audio.pause(); } }

    function setupInitialListeners() {
        document.querySelector('.start-button').addEventListener('click', showActivityIntro);
        document.getElementById('continueNarrationButton').addEventListener('click', () => {
            closeModal('narrationModal');
        });
    }

    function initGame() {
        currentScenarioIndex = 0;
        answerChecked = false;
        
        document.getElementById('progress-text').textContent = `0 / ${totalScenarios}`;
        
        document.getElementById('help-button').onclick = showInstructions;
        document.getElementById('hint-button').onclick = showHint;
        document.getElementById('help-modal-btn').onclick = () => closeModal('help-modal-overlay');
        document.getElementById('hint-modal-btn').onclick = () => closeModal('hint-modal-overlay');
        
        loadScenario();
    }
    function loadScenario() {
        answerChecked = false;
        
        const scenario = activityData.scenarios[currentScenarioIndex];
        
        document.getElementById('diagram-image-1').src = scenario.images[0];
        document.getElementById('diagram-label-1').textContent = scenario.elements[0];
        document.getElementById('diagram-image-2').src = scenario.images[1];
        document.getElementById('diagram-label-2').textContent = scenario.elements[1];
        document.getElementById('question-text').textContent = scenario.question;
        
        const optionsContainer = document.getElementById('options-container');
        optionsContainer.innerHTML = '';
        scenario.options.forEach((option, index) => {
            const button = document.createElement('button');
            button.className = 'option-button';
            button.innerHTML = option.text;
            button.onclick = () => selectOption(index, button);
            optionsContainer.appendChild(button);
        });
        
        updateProgress();
    }

    function selectOption(index, button) {
        if (answerChecked) return;
        answerChecked = true;

        const scenario = activityData.scenarios[currentScenarioIndex];
        const buttons = document.querySelectorAll('.option-button');
        
        buttons.forEach(btn => btn.disabled = true);

        const isCorrect = index === scenario.correctIndex;
        const feedback = scenario.options[index].feedback;
        
        if (isCorrect) {
            button.classList.add('correct');
            playSound(dingAudio);
            setTimeout(() => {
                showFeedbackPopup('correct', feedback);
            }, 500);
        } else {
            button.classList.add('incorrect');
            playSound(buzzAudio);
            setTimeout(() => {
                showFeedbackPopup('incorrect', feedback);
            }, 500);
        }
    }

    function goToNextScenario() {
        const container = document.getElementById('scenario-content');
        container.classList.add('fade-out');
        setTimeout(() => {
            currentScenarioIndex++;
            if (currentScenarioIndex < totalScenarios) {
                loadScenario();
                container.classList.remove('fade-out');
            } else {
                endActivity();
            }
        }, 300);
    }
    
    function updateProgress() {
        const progress = currentScenarioIndex;
        document.getElementById('progress-bar').style.width = `${(progress / totalScenarios) * 100}%`;
        document.getElementById('progress-text').textContent = `${progress} / ${totalScenarios}`;
    }

    function showFeedbackPopup(type, message) {
        document.getElementById(`${type}-feedback-text`).innerHTML = message;
        openModal(`feedback-${type}-overlay`);
    }
    
    function showActivityIntro() {
        document.getElementById('start-screen').classList.add('hidden');
        document.getElementById('game-screen').classList.remove('hidden');
        document.getElementById('hint-button').classList.remove('hidden');
        
        const narrationText = document.querySelector("#narrationModal .narration-text");
        narrationText.textContent = "Time to become an electron detective! Look closely at the atom diagrams. Each dot or cross shows an electron. The outermost ring tells you how reactive an atom is. Ready to spot the key differences?";
        
        openModal('narrationModal');
        playSound(introAudio);
        sendEvent(ActivityEvent.START_ACTIVITY, {activityName: 'Atom Detective'});
    }
    
    function showHint() {
        const scenario = activityData.scenarios[currentScenarioIndex];
        document.getElementById('hint-modal-text').textContent = scenario.hint;
        openModal('hint-modal-overlay');
    }

    function showInstructions() { 
        openModal('help-modal-overlay');
        document.getElementById('help-modal-text').innerHTML = `
            <p>1. Look at the two diagrams carefully.</p>
            <p>2. Focus on the outermost shell — this is the valence shell.</p>
            <p>3. Read the question below the diagrams.</p>
            <p>4. Choose the correct option that answers the question.</p>`;
    }
    
    function openModal(id) {
        document.getElementById(id).classList.remove('hidden');
    }

    function closeModal(id) {
        document.getElementById(id).classList.add('hidden');
        
        if (id === 'narrationModal') {
            stopSound(introAudio);
            initGame();
        } else if (id === 'feedback-correct-overlay') { 
            goToNextScenario();
        } 
        else if (id === 'feedback-incorrect-overlay') {
            tryAgain();
        }
    }
    function tryAgain() {
        answerChecked = false; // Allow another answer
        const buttons = document.querySelectorAll('.option-button');
        buttons.forEach(btn => {
            btn.disabled = false; // Re-enable all buttons
            btn.classList.remove('incorrect'); // Remove the red 'incorrect' styling
        });
    }
    
    function endActivity() {
        document.getElementById('progress-bar').style.width = `100%`;
        document.getElementById('progress-text').textContent = `${totalScenarios} / ${totalScenarios}`;
        document.getElementById('game-screen').classList.add('hidden');
        document.getElementById('hint-button').classList.add('hidden');
        
        const completionScreen = document.getElementById('completion-screen');
        completionScreen.innerHTML = `
            <h2>Activity Complete!</h2>
            <img src="images/complete.jpg" alt="Activity Summary Snapshot">
            <div class="end-buttons-bar">
                <button id="previous-button" class="completion-btn" onclick="goToPreviousActivity()">Previous Activity</button>
                <button id="play-again-button" class="completion-btn" onclick="restartGame()">Restart Activity</button>
                <button id="key-takeaways-button" class="completion-btn" onclick="showKeyTakeaways()">Key Takeaways</button>
            </div>
        `;
        completionScreen.classList.remove('hidden');

        playSound(outroAudio);
    }

    function showKeyTakeaways() {
        stopSound(outroAudio);
        const takeawaysOverlay = document.getElementById('key-takeaways-overlay');
        takeawaysOverlay.innerHTML = `
            <h2>Lesson Complete</h2>
            <div class="takeaways-container">
                <div class="takeaways-title">Key Takeaways</div>
                <ul class="takeaways-list"></ul>
            </div>
            <button class="primary-action-btn" onclick="sendEvent(LessonEvent.END_LESSON, 
                    { lessonName: 'How to Draw Energy Level Diagrams: Lesson 4' });">Exit Lesson</button>
        `;
        
        const list = takeawaysOverlay.querySelector('.takeaways-list');
        list.innerHTML = activityData.keyTakeaways.map(item => `<li>${item}</li>`).join('');

        document.getElementById('completion-screen').classList.add('hidden');
        takeawaysOverlay.classList.remove('hidden');
        sendEvent(ActivityEvent.END_ACTIVITY, {activityName: 'Atom Detective', completed: true});
    }
    
    function restartGame() {
        stopSound(outroAudio);
        document.getElementById('completion-screen').classList.add('hidden');
        document.getElementById('key-takeaways-overlay').classList.add('hidden');
        document.getElementById('game-screen').classList.remove('hidden');
        document.getElementById('hint-button').classList.remove('hidden');
        // FIX: Ensure the scenario content is visible by removing the fade-out class
        document.getElementById('scenario-content').classList.remove('fade-out');
        initGame();
    }

    function goToPreviousActivity() { 
        window.location.href = "../ACTIVITY3/index.html";
        sendEvent(ActivityEvent.END_ACTIVITY, {activityName: 'Atom Detective'});
    }
    
    window.onload = () => { 
        initAudio();
        setupInitialListeners();
    };
</script>
</body>
</html>