<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Symbol Builder â€“ Atomic Code Maker</title>
<style>
    /* ====== FONT IMPORTS ====== */
    @font-face {
      font-family: 'Fredoka';
            src: url('../assets/Fredoka-VariableFont_wdth\,wght.ttf') format('truetype');
    }
    ::-webkit-scrollbar{
        display: none;
    }
    
    /* ====== ROOT VARIABLES & SCALING ====== */
    :root {
      --primary-color: #5D04B2;
      --secondary-color: #FBB03B;
      --correct-color: #4caf50;
      --incorrect-color: #C62828;
      --text-color-dark: #2c3e50;
      --text-color-light: #fff;
      --border-radius: 1rem;
      --header-font: 'Fredoka', Arial, sans-serif;
      --body-font: var(--header-font);
      --game-bg: #ecf0f1;
      --item-bg: #ffffff;
      --item-border: #bdc3c7;
      --zone-bg: #ffffff;
      --zone-border: #DADEE2;
    }
    
    html {
      font-size: 1.8vmin;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      user-select: none;
    }
    
    body {
        width: 100%;
        height: 100vh;
        overflow: hidden; 
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: #d4d8da;
        font-family: var(--body-font);
    }

    #game-wrapper {
        width: 100%;
        max-width: 1200px;
        height: auto;
        aspect-ratio: 16 / 9;
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
        overflow: hidden;
        position: relative;
        display: flex;
        flex-direction: column;
        background: #fff;
    }
    
    #game-container {
        width: 100%;
        height: 100%;
        position: relative;
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }
    
    .touch-clone {
        position: fixed;
        opacity: 0.9;
        pointer-events: none;
        z-index: 9999;
        transform-origin: center center;
        transition: transform 0.1s;
        box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        background: var(--secondary-color);
        color: var(--text-color-dark);
        font-size: 2rem;
        font-weight: 700;
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
    }

    .screen {
        width: 100%;
        height: 100%;
        position: absolute;
        top: 0;
        left: 0;
        display: flex;
        flex-direction: column;
        transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
        overflow: hidden;
    }

    .screen.hidden {
        opacity: 0;
        pointer-events: none;
        transform: scale(0.95);
    }

    /* ===== START SCREEN ===== */
    #start-screen {
      color: var(--text-color-light);
      text-align: center;
      padding: 2rem;
      background-image: url('images/gamebg.jpg');
      background-size: cover;
      background-position: center;
      justify-content: center;
      align-items: center;
    }
    
    #start-screen h1 {
      color: var(--text-color-light);
      font-size: 3.2rem;
      font-family: var(--header-font);
      font-weight: 500;
    }
    
    .start-button {
      background: var(--secondary-color);
      color: #fff;
      font-weight: 900;
      font-size: 1.1rem;
      border: 3px solid #fff;
      border-radius: 3rem;
      padding: 0.75rem 2.25rem;
      margin-top: 1rem;
      cursor: pointer;
      letter-spacing: 0.02em;
      text-shadow: 0 2px 0 #b88b2a;
      transition: all 0.2s;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }
    
    .start-button:hover {
      transform: scale(1.06);
      box-shadow: 0 6px 24px rgba(0, 0, 0, 0.18);
    }
    
    /* ===== GAME SCREEN BASE ===== */
    #game-screen {
      justify-content: flex-start;
      overflow: hidden;
      position: relative;
      background: var(--game-bg);
    }
    
    .game-top-section { 
        width: 100%;
        background-color: var(--primary-color);
        padding: 0.75rem 1.25rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        color: #fff;
        z-index: 10;
        box-shadow: 0 0.1rem 0.5rem rgba(0,0,0,0.2);
        flex-shrink: 0;
    }
    
    #game-title {
      font-weight: 800;
      margin: 0;
      font-family: var(--header-font);
    }
    
    .top-right-controls {
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    
    #progress-container {
      width: clamp(100px, 20vw, 200px);
      background-color: rgba(255, 255, 255, 0.3);
      border-radius: 1rem;
      height: clamp(15px, 2.5vmin, 20px);
      border: 2px solid #fff;
      position: relative;
      overflow: hidden;
    }
    
    #progress-bar {
      height: 100%;
      width: 0%;
      background: #FFFF00;
      border-radius: 0.8rem;
      transition: width 0.5s ease;
    }
    
    #progress-text {
      font-weight: 700;
      color: #fff;
    }
    
    .instructions-icon {
      width: 2.5rem;
      height: 2.5rem;
      background: rgba(255, 255, 255, 0.2);
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
      z-index: 15;
      flex-shrink: 0;
      animation: glow-pulse-white 2s infinite;
    }
    
    .instructions-icon:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: scale(1.1);
    }
    
    .instructions-icon svg {
      width: 1.25rem;
      height: 1.25rem;
      fill: white;
    }

    /* ====== Game Content Layout ====== */
    .game-content {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }
    
    #build-area-container {
        flex-grow: 1;
        padding: 1.5rem;
        display: flex;
        justify-content: center;
        align-items: center;
        position: relative;
    }
    
    .build-area {
        width: 100%;
        max-width: 25rem;
        aspect-ratio: 1 / 1;
        position: relative;
        background-size: contain;
        background-position: center;
        background-repeat: no-repeat;
    }

    .drop-zone {
        position: absolute;
        width: 15%; /* UPDATED */
        height: 15%; /* UPDATED */
        border: 3px dashed var(--item-border);
        border-radius: 0.5rem;
        display: flex;
        justify-content: center;
        align-items: center;
        transition: all 0.2s ease;
        background-color: rgba(255, 255, 255, 0.6);
    }
    .drop-zone.mass-number { top: 12%; left: 13%; } /* UPDATED */
    .drop-zone.atomic-number { bottom: 16%; left: 13%; } /* UPDATED */
    
    .drop-zone.drag-over {
        border-color: var(--secondary-color);
        background-color: rgba(251, 176, 59, 0.2);
        transform: scale(1.1);
    }
    
    .drop-zone.filled {
        border-color: transparent;
        background-color: transparent;
    }

    .drop-zone .drag-item {
        width: 100%;
        height: 100%;
        margin: 0;
        box-shadow: none;
        font-size: 3vmin; /* UPDATED */
    }
    
    #drag-items-container {
        height: 25%;
        flex-shrink: 0;
        background: #dcdde1;
        box-shadow: inset 0 5px 15px -5px rgba(0,0,0,0.15);
        padding: 1rem;
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        justify-content: center;
        align-content: center;
        overflow-y: auto;
    }

    .drag-item {
        background: var(--item-bg);
        border: 2px solid var(--item-border);
        border-radius: 0.5rem;
        padding: 0.5rem 1rem;
        font-weight: 500;
        font-size: 1.8rem;
        color: var(--text-color-dark);
        text-align: center;
        cursor: grab;
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        transition: all 0.2s ease;
        flex-shrink: 0;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .drag-item:hover {
        transform: scale(1.1);
        border-color: var(--secondary-color);
        box-shadow: 0 8px 20px rgba(0,0,0,0.2);
        z-index: 10;
    }
    
    .drag-item.dragging { opacity: 0.6; cursor: grabbing; }

    /* ===== MODALS & OVERLAYS ===== */
    .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.4); backdrop-filter: blur(5px); z-index: 3000; display: flex; justify-content: center; align-items: center; animation: fadeIn 0.3s ease; padding: 1rem; }
    .overlay.hidden { display: none; }
    .modal { background: #fff; padding: 2.5rem; border-radius: 1rem; text-align: center; width: 90%; max-width: 600px; animation: slideIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); position: relative; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2); }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes slideIn { from { transform: translateY(30px) scale(0.95); opacity: 0; } to { transform: translateY(0) scale(1); opacity: 1; } }
    .modal h2 { font-size: 2rem; font-weight: 600; margin-bottom: 1.5rem; font-family: var(--header-font); }
    .modal p, .modal li { font-size: 1.2rem; line-height: 1.6; color: var(--text-color-dark); }
    #activity-intro-overlay .modal { border-top: 8px solid var(--primary-color); }
    #activity-intro-overlay .modal h2 { color: var(--primary-color); }
    #activity-intro-overlay .modal p { text-align: left; background: #f8f9fa; padding: 1.5rem; border-radius: 0.75rem; border-left: 4px solid var(--primary-color); }
    #instructions-overlay .modal { border-top: 8px solid var(--primary-color); }
    #instructions-overlay .modal h2 { color: var(--primary-color); }
    #instructions-overlay .modal ol { text-align: left; padding-left: 2rem; font-size: 1.2rem; }
    .feedback-modal { max-width: 480px; }
    .feedback-header { display: flex; align-items: center; justify-content: center; gap: 0.75rem; margin-bottom: 1rem; }
    .feedback-header h2 { font-size: 2rem; font-weight: 700; margin: 0; }
    .feedback-header.correct h2 { color: var(--correct-color); }
    .feedback-header.incorrect h2 { color: var(--incorrect-color); }
    .feedback-btn { width: 100%; }
    .feedback-btn.correct { background-color: var(--correct-color); }
    .feedback-btn.incorrect { background-color: var(--incorrect-color); }
    #feedback-modal-overlay.correct-feedback .modal { border-top: 8px solid var(--correct-color); }
    #feedback-modal-overlay.incorrect-feedback .modal { border-top: 8px solid var(--incorrect-color); }
    .modal button { width: 100%; padding: 1rem; font-size: 1.2rem; font-weight: 700; border: none; border-radius: 0.75rem; cursor: pointer; color: #fff; transition: transform 0.2s, box-shadow 0.2s; margin-top: 1rem; }
    .modal button:hover { transform: scale(1.02); }
    #activity-intro-overlay button, #instructions-overlay button { background-color: var(--primary-color); }
    
    /* ===== COMPLETION OVERLAY ===== */
    #completion-overlay { background-image: url('images/gamebg.jpg'); background-size: cover; background-position: center; color: #fff;flex-direction: column; justify-content: center; align-items: center; gap: 1.5rem; padding: 2rem; }
    .completion-title-banner { font-size: clamp(2rem, 7vmin, 3.5rem); text-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.3); text-align: center; font-family: var(--header-font); font-weight: 500; }
     .completion-buttons {
        position: absolute; bottom: 2rem; width: 100%; display: flex;
        justify-content: space-between; gap: 1.5rem; padding: 0 2rem;
    }
    .completion-btn {
       background: #FBB03B; color: #fff; font-weight: 600;
       font-size: 1.1rem; border: 0.1875rem solid #fff;
       border-radius: 3rem; padding: 0.75rem 2.25rem;
       margin-top: 1rem; cursor: pointer; letter-spacing: 0.02em;
       transition: all 0.2s; box-shadow: 0 0.25rem 0.5rem rgba(0,0,0,0.2);
    }
    .completion-btn:hover { transform: scale(1.05); }
    
    #completion-overlay .modal {
        background: transparent; box-shadow: none; padding: 0; overflow: visible;
        width: auto; max-width: none;
    }
    #completion-image { 
        width: clamp(400px, 70%, 700px); max-width: 85%; height: auto;
        border: 3px solid var(--secondary-color); border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3); margin-top: 0.5rem;
    }

    /* ====== HINT STYLES (FROM SOURCE) ====== */
    .hint-icon {
        position: absolute;
        bottom: 1.5rem;
        right: 1.5rem;
        width: 50px;
        height: 50px;
        background: var(--secondary-color);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
        z-index: 1001;
        box-shadow: 0 4px 15px rgba(251, 176, 59, 0.4);
        animation: glow-pulse 2s infinite ease-in-out;
        border: 3px solid white;
    }
    .hint-icon:hover {
        animation-play-state: paused;
        transform: scale(1.1);
    }
    .hint-icon svg {
        fill: white;
        width: 24px;
        height: 24px;
    }
    #hint-overlay .modal {
        max-width: 500px;
        border-top: 5px solid var(--secondary-color);
        padding: 2rem;
        text-align: center;
    }
    #hint-overlay h2 {
        font-size: 2rem;
        color: var(--secondary-color);
        margin-bottom: 1rem;
    }
    #hint-overlay p {
        font-size: 1.2rem;
        line-height: 1.6;
        color: var(--text-color-dark);
        margin-bottom: 1rem;
    }
    #hint-overlay button {
        margin-top: 1.5rem;
        padding: 0.8rem 2rem;
        background: var(--secondary-color);
        color: white;
        border: none;
        border-radius: 2rem;
        cursor: pointer;
        font-size: 1.1rem;
        font-weight: bold;
        transition: transform 0.2s;
    }
    #hint-overlay button:hover {
        transform: scale(1.05);
    }
    @keyframes glow-pulse {
        0%, 100% {
            box-shadow: 0 0 10px rgba(251, 176, 59, 0.5), 0 0 20px rgba(251, 176, 59, 0.3);
            transform: scale(1);
        }
        50% {
            box-shadow: 0 0 20px rgba(251, 176, 59, 0.8), 0 0 30px rgba(251, 176, 59, 0.5);
            transform: scale(1.1);
        }
    }
    @keyframes glow-pulse-white {
      0%, 100% { box-shadow: 0 0 10px rgba(255, 255, 255, 0.7), 0 0 20px rgba(255, 255, 255, 0.5); transform: scale(1); }
      50% { box-shadow: 0 0 20px rgba(255, 255, 255, 1), 0 0 30px rgba(255, 255, 255, 0.7); transform: scale(1.1); }
    }

    /* ===== RESPONSIVE DESIGN ===== */
    @media (max-width: 1200px) {
        html { font-size: 2.2vmin; }
        #game-title { font-size: 2rem; }
    }
    @media (max-width: 1000px) {
        html { font-size: 3.3vmin; }
        #game-title { font-size: 1.75rem; }
        #build-area-container { height: 70%; }
        #drag-items-container { height: 30%; }
        #game-wrapper {
            width: 100vw !important; height: 100vh !important;
            min-width: 100vw !important; min-height: 100vh !important;
            border-radius: 0 !important; max-width: none !important;
            aspect-ratio: unset !important; box-shadow: none;
        }
        #completion-image {
            max-width: 55%;
            margin-bottom: 4rem;
        }   
         .build-area{
            width: 29%;
        }
    }

    @media (max-width: 768px) {
        html { font-size: 3.5vmin; }
        .game-top-section { flex-wrap: wrap; gap: 0.5rem; }
        #game-title { font-size: 1.5rem; }
        .top-right-controls { flex-grow: 1; justify-content: flex-end; }
        .game-content { flex-direction: column; }
        #build-area-container { height: 65%; }
        #drag-items-container { height: 35%; }
        .build-area{
            width: 33%;
        }     
        #completion-image {
            max-width: 69%;
            margin-bottom: 5rem;
        }

    }
</style>
</head>
<body>
<div id="game-wrapper">
   <div id="game-container">
       <div id="start-screen" class="screen">
           <h1>Symbol Builder: Atomic Code</h1>
           <button class="start-button">Start Activity</button>
       </div>

       <div id="game-screen" class="screen hidden">
           <div class="game-top-section">
               <h1 id="game-title">Atomic Code Maker</h1>
               <div class="top-right-controls">
                    <div id="progress-container">
                        <div id="progress-bar"></div>
                    </div>
                    <span id="progress-text">0 / 5</span>
                    <div class="instructions-icon" id="instructions-icon">
                        <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-.9.92C13.45 12.9 13 13.5 13 15h-2v-.5c0-1.1.45-2.1 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41 0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25z"/></svg>
                    </div>
                </div>
           </div>
           <div class="game-content">
               <div id="build-area-container"></div>
               <div id="drag-items-container"></div>
           </div>
           <div class="hint-icon" id="hint-icon">
                <svg viewBox="0 0 24 24"><path d="M9 21c0 .5.4 1 1 1h4c.6 0 1-.5 1-1v-1H9v1zm3-19C8.1 2 5 5.1 5 9c0 2.4 1.2 4.5 3 5.7V17c0 .5.4 1 1 1h6c.6 0 1-.5 1-1v-2.3c1.8-1.3 3-3.4 3-5.7 0-3.9-3.1-7-7-7z"></path></svg>
           </div>
       </div>

        <div id="activity-intro-overlay" class="overlay hidden">
           <div class="modal">
                <h2>Activity Introduction</h2>
                <p>Scientists use a special code to describe atoms. Each atomic symbol includes the element name, atomic number, and mass number, and they must be placed correctly. In this activity, you will build atomic symbols by dragging each number and element into the right spot. Let us crack the atomic code!</p>
                <button id="close-intro-btn">Continue</button>
           </div>
       </div>

        <div id="instructions-overlay" class="overlay hidden">
            <div class="modal">
                <h2>Learner Instructions</h2>
                <ol>
                    <li>Drag the correct mass number to the top-left position (superscript).</li>
                    <li>Drag the correct atomic number to the bottom-left position (subscript).</li>
                    <li>Feedback is automatic once both numbers are placed.</li>
                </ol>
                <button id="close-instructions-btn">Got it!</button>
            </div>
        </div>
       
        <div id="feedback-modal-overlay" class="overlay hidden">
            <div class="modal feedback-modal">
                <div class="feedback-header">
                    <h2 id="feedback-title"></h2>
                </div>
                <p id="feedback-modal-text"></p>
                <button id="next-question-button" class="feedback-btn">Continue</button>
            </div>
        </div>
        
        <div id="hint-overlay" class="overlay hidden">
            <div class="modal">
                <h2>Here's a hint</h2>
                <p id="hint-text"></p>
                <button id="close-hint-btn">Got it!</button>
            </div>
        </div>

        <div id="completion-overlay" class="overlay hidden">
            <h2 class="completion-title-banner">Activity Wrap Up</h2>
             <div class="modal">
                <img id="completion-image" src="images/complete.jpg" alt="Activity Complete" onerror="this.style.display='none'">
            </div>
            <div class="completion-buttons">
                <button class="completion-btn" id="previous-activity-btn">Previous Activity</button>
                <button class="completion-btn" id="restart-activity-btn">Restart Activity</button>
                <button class="completion-btn" id="next-activity-btn">Next Activity</button>
            </div>
        </div>
   </div>
</div>

<audio id="intro-audio" src="audio/intro.mp3" preload="auto"></audio>
<audio id="complete-audio" src="audio/outro.mp3" preload="auto"></audio>
<audio id="ding-sound" src="audio/ding.mp3" preload="auto"></audio>
<audio id="buzz-sound" src="audio/buzz.mp3" preload="auto"></audio>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- DOM Elements ---
    const startScreen = document.getElementById('start-screen');
    const gameScreen = document.getElementById('game-screen');
    const startBtn = document.querySelector('.start-button');
    const progressBar = document.getElementById('progress-bar');
    const progressText = document.getElementById('progress-text');
    const buildAreaContainer = document.getElementById('build-area-container');
    const dragItemsContainer = document.getElementById('drag-items-container');
    const activityIntroOverlay = document.getElementById('activity-intro-overlay');
    const instructionsOverlay = document.getElementById('instructions-overlay');
    const feedbackModalOverlay = document.getElementById('feedback-modal-overlay');
    const completionOverlay = document.getElementById('completion-overlay');
    const hintOverlay = document.getElementById('hint-overlay');
    const closeIntroBtn = document.getElementById('close-intro-btn');
    const instructionsIcon = document.getElementById('instructions-icon');
    const closeInstructionsBtn = document.getElementById('close-instructions-btn');
    const nextQuestionBtn = document.getElementById('next-question-button');
    const restartActivityBtn = document.getElementById('restart-activity-btn');
    const previousActivityBtn = document.getElementById('previous-activity-btn');
    const nextActivityBtn = document.getElementById('next-activity-btn');
    const hintIcon = document.getElementById('hint-icon');
    const closeHintBtn = document.getElementById('close-hint-btn');
    const feedbackHeader = feedbackModalOverlay.querySelector('.feedback-header');
    const feedbackTitle = document.getElementById('feedback-title');
    const feedbackText = document.getElementById('feedback-modal-text');
    const hintText = document.getElementById('hint-text');
    const introAudio = document.getElementById('intro-audio');
    const completeAudio = document.getElementById('complete-audio');
    const dingSound = document.getElementById('ding-sound');
    const buzzSound = document.getElementById('buzz-sound');

    // --- Game Data ---
    const gameData = [
        { id: 'Na', name: 'Sodium', symbol: 'Na', mass: 23, atomic: 11, image: 'images/sodium.jpg', hint: 'Sodium (Na) is the 11th element on the periodic table.' },
        { id: 'Cl', name: 'Chlorine', symbol: 'Cl', mass: 35, atomic: 17, image: 'images/chlorine.jpg', hint: 'Chlorine (Cl) has 17 protons. Its mass number is 35.' },
        { id: 'C', name: 'Carbon', symbol: 'C', mass: 14, atomic: 6, image: 'images/carbon.jpg', hint: 'This isotope of Carbon (C) has 6 protons and 8 neutrons.' },
        { id: 'Mg', name: 'Magnesium', symbol: 'Mg', mass: 12, atomic: 12, image: 'images/magnesium.jpg', hint: 'Magnesium (Mg) has an equal number of protons and neutrons in this isotope.' },
        { id: 'Ca', name: 'Calcium', symbol: 'Ca', mass: 40, atomic: 20, image: 'images/calcium.jpg', hint: 'Calcium (Ca) is a common element with 20 protons. Its mass number is double its atomic number.' }
    ];

    // --- Game State ---
    let score = 0;
    const totalQuestions = gameData.length;
    let currentQuestionIndex = 0;
    let draggedItem = null;
    let touchClone = null;

    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    function initializeGame() {
        score = 0;
        currentQuestionIndex = 0;
        updateProgressBar();
        loadQuestion(currentQuestionIndex);
        loadDraggableItems();
    }

    function loadQuestion(index) {
        buildAreaContainer.innerHTML = '';
        const currentQuestion = gameData[index];
        const buildArea = document.createElement('div');
        buildArea.className = 'build-area';
        buildArea.style.backgroundImage = `url('${currentQuestion.image}')`;
        buildArea.dataset.id = currentQuestion.id;
        buildArea.innerHTML = `
            <div class="drop-zone mass-number" data-accepts="mass"></div>
            <div class="drop-zone atomic-number" data-accepts="atomic"></div>
        `;
        buildAreaContainer.appendChild(buildArea);
        document.querySelectorAll('.drop-zone').forEach(addDropListeners);
    }
    
    function loadDraggableItems() {
        dragItemsContainer.innerHTML = '';
        let allItems = [];
        gameData.forEach(item => {
            allItems.push({ type: 'mass', value: item.mass });
            allItems.push({ type: 'atomic', value: item.atomic });
        });
        const uniqueItems = Array.from(new Set(allItems.map(JSON.stringify))).map(JSON.parse);
        shuffleArray(uniqueItems).forEach(item => {
            const dragItem = document.createElement('div');
            dragItem.className = 'drag-item';
            dragItem.draggable = true;
            dragItem.dataset.type = item.type;
            dragItem.dataset.value = item.value;
            dragItem.textContent = item.value;
            addDragListeners(dragItem);
            dragItemsContainer.appendChild(dragItem);
        });
    }

    function checkAnswer() {
        const buildArea = document.querySelector('.build-area');
        const massZone = buildArea.querySelector('.drop-zone.mass-number');
        const atomicZone = buildArea.querySelector('.drop-zone.atomic-number');
        const massItem = massZone.querySelector('.drag-item');
        const atomicItem = atomicZone.querySelector('.drag-item');
        const currentQuestion = gameData[currentQuestionIndex];

        const isMassCorrect = massItem && parseInt(massItem.dataset.value) === currentQuestion.mass;
        const isAtomicCorrect = atomicItem && parseInt(atomicItem.dataset.value) === currentQuestion.atomic;

        if (isMassCorrect && isAtomicCorrect) {
            score++;
            updateProgressBar();
            showFeedback(true, `Well done! ${currentQuestion.name} has a mass number of ${currentQuestion.mass} and an atomic number of ${currentQuestion.atomic}.`);
            massZone.classList.add('correct');
            atomicZone.classList.add('correct');
            massItem.draggable = false;
            atomicItem.draggable = false;
        } else {
            showFeedback(false, "Not quite right. Mass number goes top-left, and atomic number goes bottom-left. Check your numbers and try again!");
            setTimeout(() => {
                dragItemsContainer.appendChild(massItem);
                dragItemsContainer.appendChild(atomicItem);
                massZone.classList.remove('filled');
                atomicZone.classList.remove('filled');
            }, 300);
        }
    }
    
    function handleDrop(zone) {
        if (!draggedItem) return;
        if (zone.children.length > 0) {
            dragItemsContainer.appendChild(zone.firstElementChild);
        }
        zone.appendChild(draggedItem);
        zone.classList.add('filled');
        draggedItem = null;
        const buildArea = document.querySelector('.build-area');
        const massZone = buildArea.querySelector('.drop-zone.mass-number');
        const atomicZone = buildArea.querySelector('.drop-zone.atomic-number');
        if (massZone.children.length > 0 && atomicZone.children.length > 0) {
            setTimeout(checkAnswer, 100);
        }
    }
    
    function addDragListeners(item) {
        item.addEventListener('dragstart', e => {
            draggedItem = item;
            if (item.parentElement.classList.contains('drop-zone')) {
                item.parentElement.classList.remove('filled');
            }
            setTimeout(() => item.classList.add('dragging'), 0);
        });
        item.addEventListener('dragend', () => {
            if (draggedItem) item.classList.remove('dragging');
            draggedItem = null;
        });

        item.addEventListener('touchstart', e => {
            if (e.cancelable) e.preventDefault();
            draggedItem = item;
            if (item.parentElement.classList.contains('drop-zone')) {
                item.parentElement.classList.remove('filled');
            }
            const touch = e.touches[0];
            const rect = item.getBoundingClientRect();
            touchClone = item.cloneNode(true);
            touchClone.classList.add('touch-clone');
            touchClone.style.width = `${rect.width}px`;
            touchClone.style.height = `${rect.height}px`;
            document.body.appendChild(touchClone);
            moveTouchClone(touch.clientX, touch.clientY, rect);
            item.style.opacity = '0.5';
        }, { passive: false });
    }
    
    document.addEventListener('touchmove', e => {
        if (!touchClone || !draggedItem) return;
        if (e.cancelable) e.preventDefault();
        const touch = e.touches[0];
        const rect = draggedItem.getBoundingClientRect();
        moveTouchClone(touch.clientX, touch.clientY, rect);
        let elementUnderTouch = document.elementFromPoint(touch.clientX, touch.clientY);
        let dropZoneUnderTouch = elementUnderTouch ? elementUnderTouch.closest('.drop-zone') : null;
        document.querySelectorAll('.drop-zone:not(.correct)').forEach(zone => {
            zone.classList.toggle('drag-over', zone === dropZoneUnderTouch);
        });
    }, { passive: false });

    document.addEventListener('touchend', e => {
        if (!draggedItem) return;
        draggedItem.style.opacity = '1';
        const touch = e.changedTouches[0];
        let dropTarget = document.elementFromPoint(touch.clientX, touch.clientY);
        let dropZone = dropTarget ? dropTarget.closest('.drop-zone:not(.correct)') : null;
        if (dropZone) {
            handleDrop(dropZone);
        } else {
             if(draggedItem.parentElement.classList.contains('drop-zone')){
                dragItemsContainer.appendChild(draggedItem);
             }
        }
        if (touchClone) touchClone.remove();
        touchClone = null;
        draggedItem = null;
        document.querySelectorAll('.drop-zone').forEach(zone => zone.classList.remove('drag-over'));
    });
    
    function moveTouchClone(x, y, rect) {
        touchClone.style.left = `${x - rect.width / 2}px`;
        touchClone.style.top = `${y - rect.height / 2}px`;
    }

    function addDropListeners(zone) {
        zone.addEventListener('dragover', e => {
            e.preventDefault();
            if (zone.children.length === 0) zone.classList.add('drag-over');
        });
        zone.addEventListener('dragleave', () => zone.classList.remove('drag-over'));
        zone.addEventListener('drop', e => {
            e.preventDefault();
            zone.classList.remove('drag-over');
            handleDrop(zone);
        });
    }

    function updateProgressBar() {
        const percentage = (score / totalQuestions) * 100;
        progressBar.style.width = `${percentage}%`;
        progressText.textContent = `${score} / ${totalQuestions}`;
    }

    function showFeedback(isCorrect, message) {
        feedbackTitle.textContent = isCorrect ? "Correct!" : "Try Again";
        feedbackText.textContent = message;
        feedbackHeader.className = isCorrect ? 'feedback-header correct' : 'feedback-header incorrect';
        nextQuestionBtn.className = isCorrect ? 'feedback-btn correct' : 'feedback-btn incorrect';
        feedbackModalOverlay.className = isCorrect ? 'overlay correct-feedback' : 'overlay incorrect-feedback';
        playSound(isCorrect ? dingSound : buzzSound);
        feedbackModalOverlay.classList.remove('hidden');
    }
    
    function nextQuestionOrEnd() {
        currentQuestionIndex++;
        if (currentQuestionIndex < totalQuestions) {
            loadQuestion(currentQuestionIndex);
        } else {
            setTimeout(() => {
                gameScreen.classList.add('hidden');
                completionOverlay.classList.remove('hidden');
                playSound(completeAudio);
            }, 500);
        }
    }
    
    function showHint() {
        const currentHint = gameData[currentQuestionIndex].hint;
        hintText.textContent = currentHint;
        hintOverlay.classList.remove('hidden');
    }

    function playSound(sound) { if (sound) { sound.currentTime = 0; sound.play().catch(e => console.error('Audio play failed:', e)); } }
    
    function stopAllAudio() {
        [introAudio, completeAudio, dingSound, buzzSound].forEach(audio => { if (audio) { audio.pause(); audio.currentTime = 0; } });
    }

    // --- Event Listeners Setup ---
    startBtn.addEventListener('click', () => {
        startScreen.classList.add('hidden');
        gameScreen.classList.remove('hidden');
        activityIntroOverlay.classList.remove('hidden');
        playSound(introAudio);
    });

    closeIntroBtn.addEventListener('click', () => {
        stopAllAudio();
        activityIntroOverlay.classList.add('hidden');
        initializeGame();
    });

    instructionsIcon.addEventListener('click', () => instructionsOverlay.classList.remove('hidden'));
    closeInstructionsBtn.addEventListener('click', () => instructionsOverlay.classList.add('hidden'));

    nextQuestionBtn.addEventListener('click', () => {
        feedbackModalOverlay.classList.add('hidden');
        if (feedbackModalOverlay.classList.contains('correct-feedback')) {
            setTimeout(nextQuestionOrEnd, 1000);
        }
    });
    
    hintIcon.addEventListener('click', showHint);
    closeHintBtn.addEventListener('click', () => hintOverlay.classList.add('hidden'));

    restartActivityBtn.addEventListener('click', () => {
        stopAllAudio();
        completionOverlay.classList.add('hidden');
        startScreen.classList.remove('hidden');
    });

previousActivityBtn.addEventListener('click', () => {
    window.location.href = "../ACTIVITY1/index.html";
    sendEvent(ActivityEvent.END_ACTIVITY, { activityName: 'Symbol Builder: Atomic Code' });
});
nextActivityBtn.addEventListener('click', () => {
    window.location.href = "../ACTIVITY3/index.html";
    sendEvent(ActivityEvent.END_ACTIVITY, { activityName: 'Symbol Builder: Atomic Code' });
});
}); // <-- Properly close the DOMContentLoaded callback
</script>
</body>
</html>