<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Activity 3: Decode the Symbol</title>
    <style>
        /* Font Imports */
        @font-face {
            font-family: 'Fredoka';
            /* Assuming assets folder is one level up from where the HTML is. Adjust if needed. */
            src: url('../assets/Fredoka-VariableFont_wdth\,wght.ttf') format('truetype');
        }
        ::-webkit-scrollbar {
            display: none;
        }
        /* Root Variables */
        :root {
            --primary-color: #5D04B2;
            --secondary-color: #fbb03b;
            --progress-color: #ffff00;
            --correct-color: #4caf50;
            --text-color-dark: #333;
            --text-color-light: #fff;
            --card-background-light: #ffffff;
            --header-font: 'Fredoka';
            --body-font: var(--header-font);
        }

        /* Proportional Scaling System Setup */
        html {
            /* Establishes a master scaling unit relative to the viewport's smallest dimension. */
            font-size: 1.8vmin;
        }

        /* Global Reset & Base Styles */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden; /* Prevent body scrollbars */
        }

        body {
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #f0f4f8;
            font-family: var(--body-font);
            font-weight: 400;
        }

        h1, h2, h3, h4, h5, h6 {
            font-family: var(--header-font);
            font-weight: 400;
        }
        #game-wrapper {
            width: 100%;
            height: auto;
            aspect-ratio: 16 / 9;
            max-width: 1200px;
            margin: auto;
            position: relative;
        }

        #game-container {
            width: 100%;
            height: 100%;
            position: relative;
            overflow: hidden;
            background-color: var(--primary-color);
        }

        .screen {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
            overflow: hidden;
            padding: 1rem;
        }

        .screen.hidden {
            opacity: 0;
            pointer-events: none;
            transform: scale(0.95);
        }

        
    /* ===== START SCREEN ===== */
    #start-screen {
      color: var(--text-color-light);
      text-align: center;
      padding: 2rem;
      background-image: url('images/gamebg.jpg'); /* Updated background */
      background-size: cover;
      background-position: center;
      justify-content: center;
      align-items: center;
    }
    
    #start-screen h1 {
      color: var(--text-color-light);
      font-size: 3.2rem;
      font-family: var(--header-font);
      text-shadow: 0 0.2rem 0.5rem rgba(0,0,0,0.4);
    }
    
    .start-button {
      background: var(--secondary-color);
      color: #fff;
      font-weight: 900;
      font-size: 1.1rem;
      border: 3px solid #fff;
      border-radius: 3rem;
      padding: 0.75rem 2.25rem;
      margin-top: 1rem;
      cursor: pointer;
      letter-spacing: 0.02em;
      transition: all 0.2s;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }
    
    .start-button:hover {
      transform: scale(1.06);
      box-shadow: 0 6px 24px rgba(0, 0, 0, 0.18);
    }
    
        /* Game Screen Styles */
        #game-screen {
             justify-content: flex-start;
             padding: 0;
             display: flex;
             flex-direction: column;
        }
        
        /* Header / Top Bar */
        .game-top-section { 
          width: 100%;
          background-color: #5D04B2;
          padding: 0.75rem 1.25rem;
          display: flex;
          justify-content: space-between;
          align-items: center;
          color: #fff;
          z-index: 10;
          box-shadow: 0 0.1rem 0.5rem rgba(0,0,0,0.2);
          flex-shrink: 0;
        }
        
        #game-title {
          font-size: 1.8rem;
          font-weight: 800;
          margin: 0;
        }
        
        .progress-wrapper {
            display: flex;
            align-items: center;
            gap: 0.8rem;
        }

        /* Progress Bar */
         #progress-container {
            width: 12.5rem;
            background-color: rgba(255,255,255,0.3);
            border-radius: 1rem;
            height: 1.25rem;
            border: 2px solid #fff;
            position: relative;
            overflow: hidden;
        }

        #progress-bar {
            height: 100%;
            width: 0%;
            background: #FFFF00;
            border-radius: 0.8rem;
            transition: width 0.5s ease;
        }

        #progress-text {
            color: var(--text-color-light);
            font-weight: 700;
            font-size: 1rem;
            text-shadow: 0.0625rem 0.0625rem 0.125rem rgba(0,0,0,0.6);
            white-space: nowrap;
        }
            
        @keyframes glow-pulse-white {
            0%, 100% { box-shadow: 0 0 1rem rgba(255, 255, 255, 0.7), 0 0 2rem rgba(255, 255, 255, 0.5); transform: scale(1); }
            50% { box-shadow: 0 0 2rem rgba(255, 255, 255, 1), 0 0 3rem rgba(255, 255, 255, 0.7); transform: scale(1.1); }
        }

        .instructions-icon {
            width: 3rem;
            height: 3rem;
            background: rgba(255, 255, 255, 0.2);
            border: 0.15rem solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 15;
            flex-shrink: 0;
            animation: glow-pulse-white 2s infinite ease-in-out;
        }
        .instructions-icon svg { width: 60%; height: 60%; fill: white; }
        .instructions-icon:hover { 
            transform: scale(1.1);
            animation-play-state: paused;
        }
        
        .lab-game-area {
            width: 100%;
            flex-grow: 1;
            position: relative;
            background-color: #fafafa;
            display: flex;
            justify-content: space-around;
            align-items: center;
            gap: 1rem;
            padding: 1.5rem;
        }

        .symbol-container {
            position: relative;
            flex: 1;
            max-width: 30%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .symbol-image {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        
        .hotspot {
            position: absolute;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 2;
            border-radius: 50%;
            background-color: rgb(48 0 255 / 27%);
            border: 0.2rem solid white;
            transform: translate(-50%, -50%); /* Center the hotspot */
        }

        @keyframes zone-pulse {
            0% { transform: translate(-50%, -50%) scale(1); box-shadow: 0 0 0 0rem rgba(255, 255, 255, 0.7); }
            70% { box-shadow: 0 0 0 1.5rem rgba(255, 255, 255, 0); }
            100% { transform: translate(-50%, -50%) scale(1); box-shadow: 0 0 0 0rem rgba(255, 255, 255, 0); }
        }
        
        .hotspot.active { animation: zone-pulse 1.5s infinite; }
        
        .hotspot.completed::before {
            content: 'âœ“';
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2.5rem;
            color: white;
            font-weight: 700;
            text-shadow: 0 0.1rem 0.3rem rgba(0,0,0,0.5);
        }
        .hotspot.completed { 
            pointer-events: none; 
            background-color: rgba(76, 175, 80, 0.3);
            border-color: rgba(255, 255, 255, 0.5); 
            animation: none;
        }
        
        /* MODALS */
        .overlay {
          position: absolute; top: 0; left: 0; width: 100%; height: 100%;
          background-color: rgba(0,0,0,0.4);
          backdrop-filter: blur(0.5rem);
          z-index: 100;
          display: flex; justify-content: center; align-items: center;
          animation: fadeIn 0.3s ease;
        }
        .overlay.hidden { display: none; }
        
        .modal {
          background: var(--card-background-light, #fff);
          padding: 2.5rem;
          border-radius: 1rem;
          text-align: center;
          width: 90%; 
          max-width: 50rem;
          animation: slideIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
          position: relative;
        }
        
        .modal .modal-title {
          font-size: 2.5rem; font-weight: 600; margin-bottom: 1.5rem;
          color: var(--primary-color);
        }
        .modal p { font-size: 1.5rem; line-height: 1.6; color: var(--text-color-dark, #333); }

        #activity-description-overlay .modal { border-top: 0.5rem solid var(--primary-color); }
        #activity-description-overlay .modal .modal-title { color: var(--primary-color); }
        #activity-description-overlay .modal p {
          text-align: left; background: #f8f9fa; padding: 1.5rem;
          border-radius: 0.75rem; border-left: 0.4rem solid var(--primary-color);
        }
        
        #game-instructions-overlay .modal { border-top: 0.5rem solid var(--primary-color); }
        #game-instructions-overlay .modal .modal-title { color: var(--primary-color); }
        #game-instructions-overlay .modal p {
            text-align: left;
            background-color: #f8f9fa;
            padding: 1rem 1.5rem;
            border-radius: 0.75rem;
            font-size: 1.2rem; line-height: 1.6;
        }
        
        .modal-close-btn {
          width: 100%; padding: 1.2rem; font-size: 1.5rem; font-weight: 700;
          border: none; border-radius: 0.75rem; cursor: pointer; color: #fff;
          background-color: var(--primary-color);
          transition: transform 0.2s, box-shadow 0.2s;
          margin-top: 1.5rem;
        }
        
        .modal-close-btn:hover { transform: scale(1.02); }

        .scenario-modal {
            display: flex; 
            background: var(--card-background-light);
            width: 90%; 
            max-width: 50rem;
            border-radius: 1rem;
            overflow: hidden; 
            animation: slideIn 0.6s ease; 
        }
      
        .scenario-content { 
            width: 100%;
            padding: 2.5rem; 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            overflow-y: auto; 
        }
        
        .info-item {
            opacity: 0;
            text-align: left;
        }
        .info-item.fade-in-up {
            animation: fadeInUp 0.6s ease-out forwards;
        }

        .info-item p {
            color: var(--text-color-dark);
            font-size: 1.8rem;
            line-height: 1.8;
        }
        #scenario-title {
            font-size: 2.2rem;
            color: var(--primary-color);
            font-family: var(--header-font);
            margin-bottom: 1.5rem;
            opacity: 0;
            text-align: left;
        }
        #scenario-title.fade-in-up {
             animation: fadeInUp 0.6s ease-out forwards;
        }

        #scenario-close-btn {
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.5s ease;
        }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideIn { from { transform: translateY(3rem) scale(0.95); opacity: 0; } to { transform: translateY(0) scale(1); opacity: 1; } }
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(2rem);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Completion Screen Styles */
        #completion-overlay { 
            background-image: url('images/gamebg.jpg'); /* Updated background */
            background-size: cover;
            background-position: center;
            color: #fff;
            z-index: 200;
            justify-content: flex-start; /* Align content to the top */
            padding-top: 3%;
        }
        .completion-header { 
          font-size: 4rem;
          margin-bottom: 1rem;
          text-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.2);
          text-align: center;
          font-weight: 500;
        }
        #completion-overlay .modal {
            background: transparent; box-shadow: none; padding: 0; overflow: visible;
            width: auto; max-width: none;
        }
        #completion-image { 
            width: clamp(400px, 70%, 700px); max-width: 85%; height: auto;
            border: 3px solid var(--secondary-color); border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3); margin-top: 0.5rem;
        }
      
        .completion-buttons-footer { 
          position: absolute;
          bottom: 1.5rem;
          left: 0; right: 0;
          width: 100%;
          display: flex;
          justify-content: space-between;
          align-items: center;
          gap: 2rem;
          padding: 0 1.25rem;
        }
        .completion-btn { 
          font-family: var(--header-font);
          background: #FBB03B;
          color: #fff;
          font-weight: 600;
          font-size: 1.5rem;
          border: 0.3rem solid #fff;
          border-radius: 3rem;
          padding: 0.75rem 2.5rem;
          cursor: pointer;
          transition: all 0.2s;
          box-shadow: 0 0.4rem 0.8rem rgba(0,0,0,0.2);
          text-decoration: none;
          min-width: 14rem;
          text-align: center;
        }
        .completion-btn:hover { transform: scale(1.06); box-shadow: 0 0.6rem 2.4rem rgba(0,0,0,0.18); }
        
        
        /* MEDIA QUERIES */
        @media (max-aspect-ratio: 16/9) {
            #game-wrapper {
                max-height: 100%;
                max-width: calc(100vh * 16 / 9);
            }
        }
        @media (max-width: 1200px) {
            html {
                font-size: 2.2vmin;
            }
        }
        
        @media (max-width: 1000px) {
            html{
                font-size: 3vmin;
            }
            #game-wrapper {
                width: 100vw; height: 100vh; min-width: 100vw; min-height: 100vh;
                border-radius: 0; max-width: none; aspect-ratio: unset;
            }
            .info-item p {
                color: var(--text-color-dark);
                font-size: 1.8rem;
                line-height: 1.5;
            }
        }
        
        @media (max-width: 768px) {
             html {
                font-size: 3vmin;
            }
            .completion-header { font-size: 3rem; }
            .completion-buttons-footer {
                gap: 1rem;
                bottom: 1rem;
            }
            .scenario-content {
                padding: 1.5rem;
            }
            #scenario-title { font-size: 1.8rem; }
            .info-item p { font-size: 1.5rem; }
        }
    </style>
</head>
<body>
    <div id="game-wrapper">
        <div id="game-container">
            <div id="start-screen" class="screen">
                <h1>Decode the Symbol</h1>
                <button class="start-button" onclick="startGame(); sendEvent(ActivityEvent.START_ACTIVITY, { activityName: 'Decode the Symbol' });">Start Activity</button>
            </div>

            <div id="game-screen" class="screen hidden">
                <div class="game-top-section">
                    <h1 id="game-title">Decode the Symbol</h1>
                    <div class="progress-wrapper">
                         <div id="progress-container">
                            <div id="progress-bar"></div>
                        </div>
                        <div id="progress-text">0 / 9</div>
                        <div class="instructions-icon" onclick="showGameInstructions()">
                            <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-.9.92C13.45 12.9 13 13.5 13 15h-2v-.5c0-1.1.45-2.1 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41 0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25z"/></svg>
                        </div>
                    </div>
                </div>
                <div class="lab-game-area" id="lab-game-area">
                    </div>
            </div>

            <div id="activity-description-overlay" class="overlay hidden">
                <div class="modal">
                    <h2 class="modal-title">Activity Introduction</h2>
                    <p>Each atomic symbol contains hints about what makes an atom unique. By clicking on the parts of the symbol, you will uncover the meaning behind every number and letter. Explore carefully, and learn how to read atomic identities.</p>
                    <button class="modal-close-btn" onclick="closeActivityDescription();">Continue</button>
                </div>
            </div>
            
            <div id="game-instructions-overlay" class="overlay hidden">
                <div class="modal">
                    <h2 class="modal-title">Learner Instructions</h2>
                    <p>Click on the mass number, atomic number, and chemical symbol in each atomic symbol to reveal their meaning.</p>
                    <button class="modal-close-btn" onclick="closeGameInstructions()">Got It!</button>
                </div>
            </div>
            
            <div id="scenario-overlay" class="overlay hidden">
                 <div class="scenario-modal">
                    <div class="scenario-content">
                        <h2 id="scenario-title"></h2>
                        <div id="scenario-info"></div>
                        <button id="scenario-close-btn" class="modal-close-btn" onclick="closeScenario()">Continue</button>
                    </div>
                </div>
            </div>

            <div id="completion-overlay" class="screen hidden">
                <h2 class="completion-header">Activity Wrap Up!</h2>
                 <div class="modal">
                <img id="completion-image" src="images/complete.jpg" alt="Activity Complete" onerror="this.style.display='none'">
            </div>
                <div class="completion-buttons-footer">
                    <button class="completion-btn" onclick="previousActivity()">Previous Activity</button>
                    <button class="completion-btn" onclick="restartGame()">Restart Activity</button>
                    <a href="#" class="completion-btn" onclick="sendEvent(ActivityEvent.END_ACTIVITY, { activityName: 'Decode the Symbol' });">Next Activity</a>
                </div>
            </div>
        </div>
    </div>

    <audio id="ding-sound" src="audio/ding.mp3" preload="auto"></audio>
    <audio id="intro-audio" src="audio/intro.mp3" preload="auto"></audio>
    <audio id="outro-audio" src="audio/outro.mp3" preload="auto"></audio>
    
    <script>
        // --- DATA ---
        const activityData = [
            {
                symbolId: 'nitrogen',
                imageSrc: 'images/nitrogen.jpg',
                hotspots: [
                    {
                        id: 'N-mass',
                        title: 'Mass Number (14)',
                        explanation: 'This is the mass number, which equals the total number of protons and neutrons in the atom. For Nitrogen, that means 7 protons + 7 neutrons = 14.',
                        coords: { top: '30%', left: '22%', width: '15%', height: '10%' }
                    },
                    {
                        id: 'N-atomic',
                        title: 'Atomic Number (7)',
                        explanation: 'This is the atomic number. It tells you the number of protons in the atom. Nitrogen has 7 protons.',
                        coords: { top: '66%', left: '18%', width: '15%', height: '10%' }
                    },
                    {
                        id: 'N-symbol',
                        title: 'Chemical Symbol (N)',
                        explanation: 'This is the chemical symbol for Nitrogen. Every element has a unique one- or two-letter code.',
                        coords: { top: '50%', left: '50%', width: '50%', height: '40%' }
                    }
                ]
            },
            {
                symbolId: 'sodium',
                imageSrc: 'images/sodium.jpg',
                hotspots: [
                    {
                        id: 'Na-mass',
                        title: 'Mass Number (23)',
                        explanation: 'This is the mass number for Sodium. It represents the total number of protons and neutrons. Sodium has 11 protons and 12 neutrons: 11 + 12 = 23.',
                        coords: { top: '31%', left: '22%', width: '20%', height: '13%' }
                    },
                    {
                        id: 'Na-atomic',
                        title: 'Atomic Number (11)',
                        explanation: 'This is the atomic number. It shows that Sodium has 11 protons. It also defines the element.',
                        coords: { top: '66%', left: '21%', width: '18%', height: '13%' }
                    },
                    {
                        id: 'Na-symbol',
                        title: 'Chemical Symbol (Na)',
                        explanation: 'This is the chemical symbol for Sodium. <strong>Na</strong> comes from the Latin name Natrium.',
                        coords: { top: '50%', left: '50%', width: '55%', height: '40%' }
                    }
                ]
            },
            {
                symbolId: 'calcium',
                imageSrc: 'images/calcium.jpg',
                hotspots: [
                    {
                        id: 'Ca-mass',
                        title: 'Mass Number (40)',
                        explanation: 'This is the mass number. Calcium has 20 protons and 20 neutrons. The mass number is their sum: 20 + 20 = 40.',
                        coords: { top: '30%', left: '22%', width: '18%', height: '10%' }
                    },
                    {
                        id: 'Ca-atomic',
                        title: 'Atomic Number (20)',
                        explanation: 'This is the atomic number. It shows that Calcium has 20 protons. This number also tells us how the atom behaves chemically.',
                        coords: { top: '66%', left: '20%', width: '18%', height: '12%' }
                    },
                    {
                        id: 'Ca-symbol',
                        title: 'Chemical Symbol (Ca)',
                        explanation: 'This is the chemical symbol for Calcium. Symbols are used worldwide to represent elements.',
                        coords: { top: '48%', left: '50%', width: '55%', height: '40%' }
                    }
                ]
            }
        ];
        
        const TOTAL_ACTIVITIES = activityData.reduce((acc, symbol) => acc + symbol.hotspots.length, 0);

        // --- STATE ---
        let completedActivities = new Set();
        let activeActivity = null;

        // --- DOM ELEMENTS ---
        const startScreen = document.getElementById('start-screen');
        const gameScreen = document.getElementById('game-screen');
        const completionOverlay = document.getElementById('completion-overlay');
        const labGameArea = document.getElementById('lab-game-area');
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');
        const overlays = {
            activityDescription: document.getElementById('activity-description-overlay'),
            gameInstructions: document.getElementById('game-instructions-overlay'),
            scenario: document.getElementById('scenario-overlay'),
        };
        const sounds = {
            ding: document.getElementById('ding-sound'),
            intro: document.getElementById('intro-audio'),
            outro: document.getElementById('outro-audio'),
        };
        
        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', initializeGame);

        function initializeGame() {
            labGameArea.innerHTML = ''; 
            completedActivities.clear();
            activeActivity = null;

            activityData.forEach(symbol => {
                const container = document.createElement('div');
                container.className = 'symbol-container';
                
                const img = document.createElement('img');
                img.src = symbol.imageSrc;
                img.className = 'symbol-image';
                container.appendChild(img);

                symbol.hotspots.forEach(spot => {
                    const hotspot = document.createElement('div');
                    hotspot.className = 'hotspot';
                    hotspot.id = spot.id;
                    hotspot.dataset.symbolId = symbol.symbolId;
                    hotspot.dataset.hotspotId = spot.id;
                    Object.assign(hotspot.style, spot.coords);
                    container.appendChild(hotspot);
                });
                labGameArea.appendChild(container);
            });
            updateHotspotStates();
            updateProgress();
            labGameArea.addEventListener('click', handleHotspotClick);
        }

        // --- GAME FLOW ---
        function startGame() {
            startScreen.classList.add('hidden');
            gameScreen.classList.remove('hidden');
            setTimeout(() => {
                overlays.activityDescription.classList.remove('hidden');
                playSound(sounds.intro);
            }, 500);
        }

        function closeActivityDescription() {
            overlays.activityDescription.classList.add('hidden');
            stopSound(sounds.intro);
        }
        
        function handleHotspotClick(event) {
            const clickedHotspot = event.target.closest('.hotspot');
            if (!clickedHotspot || clickedHotspot.classList.contains('completed')) return;
            
            const symbolId = clickedHotspot.dataset.symbolId;
            const hotspotId = clickedHotspot.dataset.hotspotId;
            
            const symbolData = activityData.find(s => s.symbolId === symbolId);
            activeActivity = symbolData.hotspots.find(h => h.id === hotspotId);
            
            showScenarioInfo(activeActivity);
        }

        function showScenarioInfo(activity) {
            const scenarioTitle = document.getElementById('scenario-title');
            const infoContainer = document.getElementById('scenario-info');
            const closeButton = document.getElementById('scenario-close-btn');

            scenarioTitle.textContent = activity.title;
            
            infoContainer.innerHTML = '';
            scenarioTitle.classList.remove('fade-in-up');
            scenarioTitle.style.opacity = '0';

            const itemDiv = document.createElement('div');
            itemDiv.className = 'info-item';
            itemDiv.innerHTML = `<p>${activity.explanation}</p>`;
            infoContainer.appendChild(itemDiv);

            const allItems = [
                { el: scenarioTitle, delay: 0 },
                { el: itemDiv, delay: 300 }
            ];

            closeButton.style.visibility = 'hidden';
            closeButton.style.opacity = '0';
            
            overlays.scenario.classList.remove('hidden');
            
            allItems.forEach(item => {
                item.el.classList.remove('fade-in-up');
                setTimeout(() => {
                    item.el.classList.add('fade-in-up');
                }, item.delay);
            });

            const totalAnimationTime = allItems.length * 300 + 400;
            setTimeout(() => {
                closeButton.style.visibility = 'visible';
                closeButton.style.opacity = '1';
            }, totalAnimationTime);
        }

        function closeScenario() {
            overlays.scenario.classList.add('hidden');
            
            if (activeActivity && !completedActivities.has(activeActivity.id)) {
                playSound(sounds.ding);
                completedActivities.add(activeActivity.id);
                updateProgress();
                updateHotspotStates();
            }
             
            activeActivity = null;

            if (completedActivities.size === TOTAL_ACTIVITIES) {
                 setTimeout(() => {
                     gameScreen.classList.add('hidden');
                     completionOverlay.classList.remove('hidden');
                     playSound(sounds.outro); 
                 }, 800);
            }
        }
        
        function restartGame() {
            stopSound(sounds.outro);
            completionOverlay.classList.add('hidden');
            startScreen.classList.remove('hidden');
            initializeGame();
        }
        function previousActivity() {
            stopSound(sounds.outro);
            // This can be a placeholder or actual navigation
            console.log("Navigating to the previous activity.");
            sendEvent(ActivityEvent.END_ACTIVITY, { activityName: 'Decode the Symbol' });
        }
        
        // --- UI & FEEDBACK ---
        function updateProgress() {
            const progress = (completedActivities.size / TOTAL_ACTIVITIES) * 100;
            progressBar.style.width = `${progress}%`;
            progressText.textContent = `${completedActivities.size} / ${TOTAL_ACTIVITIES}`;
        }
        
        function updateHotspotStates() {
            document.querySelectorAll('.hotspot').forEach((hotspot) => {
                const activityId = hotspot.id;
                hotspot.classList.remove('completed', 'active'); 

                if (completedActivities.has(activityId)) {
                    hotspot.classList.add('completed');
                } else {
                    hotspot.classList.add('active');
                }
            });
        }

        // --- MODAL CONTROLS ---
        function showGameInstructions() { overlays.gameInstructions.classList.remove('hidden'); }
        function closeGameInstructions() { overlays.gameInstructions.classList.add('hidden'); }
        
        // --- UTILITIES ---
        function playSound(audioEl) {
            if (audioEl) {
                audioEl.currentTime = 0;
                audioEl.play().catch(e => console.error('Audio play failed:', e));
            }
        }

        function stopSound(audioEl) {
            if(audioEl) {
                audioEl.pause();
                audioEl.currentTime = 0;
            }
        }    
    </script>
</body>
</html>